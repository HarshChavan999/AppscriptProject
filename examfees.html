

<div class="bg-white rounded-xl shadow-lg border border-gray-200 mt-6 ml-64 hidden" id="feeReceiptForm">
  <div class="bg-white text-gray-900 p-6 border-b border-gray-200">
    <div class="flex flex-col items-center">
      <p class="text-3xl font-bold text-gray-700"><i class="fas fa-file-alt mr-1"></i>EXAM RECEIPT</p>
    </div>
  </div>

  <form id="examReceiptForm" class="inquiry-form-container" onsubmit="FeeReceiptFormHandle(event)">
    <div class="p-6 space-y-4 max-w-4xl mx-auto">

      <h2 class="text-xl font-semibold text-gray-800">Invoice Details</h2>
      <div class="grid grid-cols-1 gap-6">
          <!-- First Row: Enrollment ID (Left), Date (Middle), Receipt Number (Right) -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <!-- Enrollment ID Field (Left) -->
              <div>
                  <label for="enrollmentIdInput" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                      <i class="fas fa-id-card text-blue-900 mr-2"></i>Enrollment ID <span class="text-red-500 ml-1">*</span>
                  </label>
                  <input type="text" id="enrollmentIdInput" name="enrollmentId"
                         class="form-input w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500"
                         placeholder="Enter enrollment ID">
              </div>

              <!-- Date Field (Middle) -->
              <div>
                  <label for="receiptDate" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                      <i class="fas fa-calendar-alt text-blue-900 mr-2"></i>Date <span class="text-red-500 ml-1">*</span>
                  </label>
                  <div class="relative">
                      <div id="receiptDateDisplay"
                           class="form-input w-full px-4 py-2 rounded-lg border border-gray-300 bg-gray-100 cursor-not-allowed flex items-center">
                          Loading...
                      </div>
                      <input type="hidden" id="receiptDate" name="receiptDate" value="">
                      <i class="fas fa-calendar-alt absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                  </div>
              </div>

              <!-- Receipt Number Field (Right) -->
              <div>
                  <label for="ExamReceiptNumber" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                      <i class="fas fa-hashtag text-blue-900 mr-2"></i>Receipt Number <span class="text-red-500 ml-1">*</span>
                  </label>
                  <input type="text" id="ExamReceiptNumber" name="receiptNumber"
                         class="form-input w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500"
                         readonly>
              </div>
          </div>

          <!-- Second Row: Student Name and Course Name -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Student Name Field -->
              <div>
                  <label for="studentNameInput" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                      <i class="fas fa-user-graduate text-blue-900 mr-2"></i>Student Name <span class="text-red-500 ml-1">*</span>
                  </label>
                  <input type="text" id="studentNameInput" name="studentName"
                         class="form-input w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500"
                         required placeholder="Enter student name">
              </div>

              <!-- Course Name Field -->
              <div>
                  <label for="courseNameInput" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                      <i class="fas fa-book text-blue-900 mr-2"></i>Course Name <span class="text-red-500 ml-1">*</span>
                  </label>
                  <input type="text" id="courseNameInput" name="courseName"
                         class="form-input w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500"
                         required placeholder="Enter course name">
              </div>
          </div>
      </div>

      <h2 class="text-xl font-semibold text-gray-800">Payment Information</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Total Amount Field -->
          <div>
              <label for="totalAmount" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                  <i class="fas fa-rupee-sign text-blue-900 mr-2"></i>Total Amount (‚Çπ) <span class="text-red-500 ml-1">*</span>
              </label>
              <input type="number" id="totalAmount" name="totalAmount" value="500" readonly
                     class="form-input w-full px-4 py-2 rounded-lg border border-gray-300 bg-gray-100 cursor-not-allowed">
          </div>

          <!-- Payment Mode Field -->
          <div>
              <label for="paymentModeInput" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                  <i class="fas fa-credit-card text-blue-900 mr-2"></i>Payment Mode <span class="text-red-500 ml-1">*</span>
              </label>
              <select id="paymentModeInput" name="paymentMode"
                      class="form-select w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500"
                      required>
                  <option value="" disabled selected>Select Payment Mode</option>
                  <option value="Cash">üíµ Cash</option>
                  <option value="Cheque">üìù Cheque</option>
                  <option value="Bank Transfer">üè¶ Bank Transfer</option>
                  <option value="UPI">üì± UPI</option>
                  <option value="Credit/Debit Card">üí≥ Credit/Debit Card</option>
              </select>
          </div>
      </div>

      <div class="border-t border-gray-200 pt-4">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
          <div class="mb-4 md:mb-0">
            <label class="inline-flex items-center cursor-pointer">
              <input type="checkbox" id="agreeTerms" name="agreeTerms" required class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
              <span class="ml-2 text-sm text-gray-700">I acknowledge and agree to the payment details above</span>
            </label>
            <div id="agreeError" class="text-red-500 text-xs italic mt-1"></div>
          </div>
          <div class="flex justify-end space-x-4">
            <button type="button" onclick="generateAndSaveReceipt()" id="generateReceiptBtn" class="bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-medium tracking-wide py-2.5 px-6 rounded-md shadow-lg transform hover:scale-105 transition duration-300 flex items-center justify-center gap-2">
              <i class="fas fa-print mr-2"></i>Generate Receipt
            </button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<script>
  // Calculate balance amount automatically
    // document.getElementById('paidAmount').addEventListener('input', function() {
    //     const total = parseFloat(document.getElementById('totalAmount').value) || 0;
    //     const paid = parseFloat(this.value) || 0;
    //     const balance = total - paid;
    //     document.getElementById('balanceAmount').value = balance.toFixed(2);
    // });
    
    // Handle form submission
    function FeeReceiptFormHandle(e) {
  e.preventDefault();

  const form = document.getElementById('examReceiptForm');
  const formData = new FormData(form);

  const receiptNumber = formData.get('receiptNumber');

  // Validate that receipt number is loaded
  if (!receiptNumber || receiptNumber === 'Generating...' || receiptNumber === '') {
    showNotification("Please wait for the receipt number to load before submitting.", "error");
    return;
  }

  // Get current date in a format that Google Apps Script can handle
  const now = new Date();
  const dateString = (now.getMonth() + 1) + '/' + now.getDate() + '/' + now.getFullYear();

  const data = {
    receiptDate: dateString, // Current date as MM/DD/YYYY string
    receiptNumber: receiptNumber,
    enrollmentId: formData.get('enrollmentId'),
    studentName: formData.get('studentName'),
    courseName: formData.get('courseName'),
    totalAmount: formData.get('totalAmount'),
    paymentMode: formData.get('paymentMode'),
    agreeTerms: formData.get('agreeTerms') ? 'Yes' : 'No'
  };

  // Show loading state
  const submitBtn = document.getElementById('generateReceiptBtn');
  const originalText = submitBtn.innerHTML;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
  submitBtn.disabled = true;

  google.script.run
    .withSuccessHandler(function(result) {
      // Reset button
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;

      if (result && result.success) {
        // Success notification
        showNotification(result.message || "Receipt saved successfully!", "success");

        // Reset form but keep the date
        form.reset();

        // Reload only receipt number for next entry (without resetting date)
        loadexamfeeOnly();
      } else {
        // Error notification
        showNotification(result.message || "Failed to save receipt. Please try again.", "error");
      }
    })
    .withFailureHandler(function(error) {
      // Reset button
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;

      // Error notification
      showNotification("Error saving receipt: " + error.message, "error");
      console.error("Save receipt error:", error);
    })
    .saveReceiptData(data);
}

    // Notification function
    function showNotification(message, type = "info") {
      // Remove any existing notifications
      const existingNotifications = document.querySelectorAll('.notification-toast');
      existingNotifications.forEach(notification => notification.remove());

      // Create notification element
      const notification = document.createElement('div');
      notification.className = `notification-toast fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;

      // Set colors based on type
      if (type === "success") {
        notification.classList.add('bg-green-500', 'text-white');
        notification.innerHTML = `
          <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <span>${message}</span>
          </div>
        `;
      } else if (type === "error") {
        notification.classList.add('bg-red-500', 'text-white');
        notification.innerHTML = `
          <div class="flex items-center">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <span>${message}</span>
          </div>
        `;
      } else {
        notification.classList.add('bg-blue-500', 'text-white');
        notification.innerHTML = `
          <div class="flex items-center">
            <i class="fas fa-info-circle mr-2"></i>
            <span>${message}</span>
          </div>
        `;
      }

      // Add to page
      document.body.appendChild(notification);

      // Animate in
      setTimeout(() => {
        notification.classList.remove('translate-x-full');
      }, 100);

      // Auto remove after 5 seconds
      setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 5000);
    }

    
    // Generate PDF receipt
    function generatePDFReceipt() {
        // Add your PDF generation logic here
        console.log("Generating PDF receipt");
    }

    // Setup event listener for enrollment ID input
    function setupEnrollmentIdListener() {
        const enrollmentIdInput = document.getElementById('enrollmentIdInput');
        if (enrollmentIdInput) {
            enrollmentIdInput.addEventListener('blur', function() {
                const enrollmentId = this.value.trim();
                if (enrollmentId) {
                    // Show loading state
                    showNotification("Fetching student data...", "info");

                    // Call the backend function to get student data
                    google.script.run
                        .withSuccessHandler(function(studentData) {
                            if (studentData && !studentData.error) {
                                // Populate the form fields with retrieved data
                                document.getElementById('studentNameInput').value = studentData.studentName || '';
                                document.getElementById('courseNameInput').value = studentData.courseName || '';

                                // Set exam fee based on course and branch
                                setExamFeeFromCourse(studentData.courseName);

                                showNotification("Student data loaded successfully!", "success");
                                console.log("Student data loaded:", studentData);
                            } else {
                                showNotification("Enrollment ID not found or invalid", "error");
                                console.error("Error fetching student data:", studentData);
                            }
                        })
                        .withFailureHandler(function(error) {
                            showNotification("Error fetching student data: " + error.message, "error");
                            console.error("Error fetching student data:", error);
                        })
                        .getStudentDataByEnrollmentId(enrollmentId);
                }
            });
        }
    }

    // Function to set exam fee based on course and branch
    function setExamFeeFromCourse(courseName) {
        if (!courseName) return;

        // Map display course names to internal course keys
        const courseKeyMap = {
            "ANM Nursing Diploma Course": "anm_nursing",
            "GNM Nursing Diploma Course": "gnm_nursing",
            "DMLT Diploma Course": "dmlt",
            "OT Technician": "ot_technician",
            "General Nursing and Midwifery Assistant": "general_nursing"
        };

        const courseKey = courseKeyMap[courseName];

        if (courseKey) {
            // Get branch from session storage
            const branch = sessionStorage.getItem("userBranch") || sessionStorage.getItem("branch") || "kurla";

            // Get course data from getCourseDataByLocation function
            // Since this is client-side, we need to call the server-side function
            google.script.run
                .withSuccessHandler(function(courseData) {
                    const examFee = courseData[courseKey]?.exam_fee || 500; // Default to 500 if not found
                    document.getElementById('totalAmount').value = examFee;
                    console.log(`Set exam fee to ‚Çπ${examFee} for course: ${courseName}, branch: ${branch}`);
                })
                .withFailureHandler(function(error) {
                    console.error("Error getting course data:", error);
                    document.getElementById('totalAmount').value = 500; // Default fallback
                })
                .getCourseDataByLocation(branch);
        } else {
            console.warn("Course not found in mapping:", courseName);
            document.getElementById('totalAmount').value = 500; // Default fallback
        }
    }
function openexamfees() {
    console.log("openexamfees() called - starting form setup");
    hideAllSections();
    const formShown = document.getElementById("feeReceiptForm").classList.remove("hidden");
    console.log("Form shown:", formShown);

    copyadmissionreceipt();
    console.log("copyadmissionreceipt() completed");

    loadexamfee();
    console.log("loadexamfee() completed");

    // Add event listener for enrollment ID input
    setupEnrollmentIdListener();

    // Auto-populate today's date in the date field - Format DD/MM/YYYY for display
    console.log("About to set date in exam fees form...");

    // Wait for all other functions to complete, then set the date
    setTimeout(() => {
        console.log("Setting date now...");
        const dateInput = document.getElementById('receiptDate');
        const isFormVisible = !document.getElementById("feeReceiptForm").classList.contains("hidden");

        console.log("Date input found:", !!dateInput);
        console.log("Form is visible:", isFormVisible);

        if (dateInput && isFormVisible) {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const displayDate = `${dd}/${mm}/${yyyy}`;

            console.log("Setting value to:", displayDate);

            // Set the hidden form field (for form submission)
            dateInput.value = displayDate;

            // Set the visible display field (what the user sees)
            const displayField = document.getElementById('receiptDateDisplay');
            if (displayField) {
                displayField.textContent = displayDate;
                console.log("Display field updated to:", displayDate);
            } else {
                console.log("Display field not found!");
            }

            console.log("Hidden input value set to:", dateInput.value);
            console.log("Parent container hidden:", document.getElementById("feeReceiptForm").classList.contains("hidden"));
        } else {
            console.log("Date input not found or form not visible!");
            console.log("Date input element:", dateInput);
            console.log("Form visibility:", isFormVisible);
        }
    }, 500); // Increased delay to 500ms

  //   // 1. Get the stored branch from the hidden input
  //   const userBranch = document.getElementById("userBranch").value;

  //   // 2. Get the branch input element in your inquiry form
  //   const branchInput = document.getElementById("branch");

  //   // 3. Set its value directly
  //   if (userBranch) {
  //       branchInput.value = userBranch;
  //   } else {
  //       branchInput.value = ""; // Or some default value
  //   }

  //   // ‚≠ê START: Add this section for Inquiry Taken By
  //   // 4. Get the stored username from the hidden input (loggedInUserId)
  //   const loggedInUser = document.getElementById("loggedInUserId").value; // Or document.getElementById("userName").value;

  //   // 5. Get the Inquiry Taken By input element
  //   const inquiryTakenByInput = document.getElementById("receivedBy");

  //   // 6. Set its value directly
  //   if (loggedInUser) {
  //       inquiryTakenByInput.value = loggedInUser;
  //   } else {
  //       inquiryTakenByInput.value = ""; // Or some default value like "Anonymous"
  //   }
  }

//   function examfeeTakenBy() {
//     const inquiryTakenByInput = document.getElementById("receivedBy");
//     const branchInput = document.getElementById("branch"); // Get the branch input

//     // Get the logged-in username from the hidden input field that was set during login
//     const loggedInUserFromHiddenInput = document.getElementById("loggedInUserId")?.value;
//     // Get the logged-in branch from the hidden input field that was set during login
//     const loggedInBranchFromHiddenInput = document.getElementById("userBranch")?.value;


//     if (inquiryTakenByInput) {
//         if (loggedInUserFromHiddenInput) {
//             inquiryTakenByInput.value = loggedInUserFromHiddenInput;
//             inquiryTakenByInput.readOnly = true; // Ensure it's readonly
//         } else {
//             inquiryTakenByInput.value = "N/A"; // Or handle anonymous users differently
//             console.warn("Logged-in user ID not found in hidden input.");
//         }
//     }

//     if (branchInput) {
//         if (loggedInBranchFromHiddenInput) {
//             branchInput.value = loggedInBranchFromHiddenInput;
//             branchInput.readOnly = true; // Ensure it's readonly
//         } else {
//             branchInput.value = "N/A"; // Or some default
//             console.warn("Logged-in user branch not found in hidden input.");
//         }
//     }
// }

function generateexamReceipt(formData = null) {
    try {
      const logoBase64 = "https://i.postimg.cc/15z0wxhX/cropped-circle-image-(1).png";

        // Get values from formData parameter if provided, otherwise from form fields
        const receiptNo = formData?.receiptNumber || document.getElementById('ExamReceiptNumber').value || "REC" + Math.floor(1000 + Math.random() * 9000);
        const date = formData?.receiptDate || document.getElementById('receiptDate').value || new Date().toLocaleDateString('en-GB');
        const studentName = formData?.studentName || document.getElementById('studentNameInput').value || "N/A";
        const courseName = formData?.courseName || document.getElementById('courseNameInput').value || "N/A";
        const totalAmount = parseFloat(formData?.totalAmount || document.getElementById('totalAmount').value) || 0;
        // const paidAmount = parseFloat(document.getElementById('paidAmount').value) || 0;
        // const balanceAmount = totalAmount - paidAmount;
        // const receivedBy = document.getElementById('receivedBy').value || "Admin";
        const paymentMode = formData?.paymentMode || document.getElementById('paymentModeInput').value || "Cash";
        // const transactionDetails = document.getElementById('transactionDetails').value || "-";

        // Format currency
        const formatCurrency = (amount) => {
            return '‚Çπ' + amount.toFixed(2);
        };

        // Prepare receipt data
        // Get branch from session storage
        const branch = sessionStorage.getItem("userBranch") || sessionStorage.getItem("branch") || "kurla";

        const receiptData = {
            receiptNo: receiptNo,
            date: date,
            studentName: studentName,
            courseName: courseName,
            totalAmount: formatCurrency(totalAmount),
            // paidAmount: formatCurrency(paidAmount),
            // balanceAmount: formatCurrency(balanceAmount),
            paymentMode: paymentMode,
            // transactionDetails: transactionDetails,
            // receivedBy: receivedBy,
            branch: branch
        };

        // Generate the receipt HTML
        const receiptHTML = `
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Receipt</title>
                <style>
                    @page { size: A4; margin: 0.5in; }
                    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: white; }
                    .page-container { width: 210mm; height: 297mm; display: flex; flex-direction: column; 
                                    justify-content: space-between; padding: 10mm; box-sizing: border-box; }
                    .receipt { width: 100%; height: 45%; border: 3px solid #000; border-radius: 15px; 
                             padding: 15px; box-sizing: border-box; background: white; margin-bottom: 10mm; 
                             page-break-inside: avoid; }
                    .header { display: flex; align-items: center; margin-bottom: 15px; 
                             border-bottom: 2px solid #000; padding-bottom: 10px; }
                    .logo img { width: 65px; height: auto;}
                    .institute-name { font-size: 28px; font-weight: bold; color: #000;
                                    flex-grow: 1; letter-spacing: 1px; text-align: center; }
                    .receipt-label { background: #333; color: white; padding: 5px 15px; 
                                    border-radius: 20px; font-size: 14px; font-weight: bold; }
                    .receipt-content { display: flex; flex-direction: column; height: calc(100% - 100px); }
                    .receipt-info { display: flex; justify-content: space-between; margin-bottom: 20px; }
                    .receipt-no, .date { font-size: 16px; font-weight: bold; }
                    .form-fields { flex-grow: 1; display: flex; flex-direction: column; gap: 12px; }
                    .field-row { display: flex; align-items: center; font-size: 14px; font-weight: bold; }
                    .field-label { min-width: 140px; color: #000; }
                    .field-value { flex-grow: 1; border-bottom: 1px solid #000; padding: 2px 5px; 
                                 min-height: 20px; color: #0066cc; white-space: nowrap; 
                                 overflow: hidden; text-overflow: ellipsis; max-width: calc(100% - 140px); }
                    .amount-fields { display: flex; gap: 20px; }
                    .amount-field { flex: 1; min-width: 30%; }
                    .amount-fields .field-value { max-width: none; white-space: normal; word-break: break-all; flex-grow: 1; padding-left: 5px; }
                    .amount-fields .field-label { min-width: 140px; }
                    .footer { margin-top: 15px; display: flex; justify-content: space-between; align-items: flex-end; }
                    .note { font-size: 16px; font-weight: bold; max-width: 60%; }
                    .signature-area { text-align: center; min-width: 150px; }
                    .signature-line { border-bottom: 1px solid #000; height: 40px; margin-bottom: 5px; }
                    .signature-label { font-size: 16px; font-weight: bold; }
                    @media print { 
                        .page-container { height: 297mm; padding: 0.5in; } 
                        .receipt { margin-bottom: 5mm; } 
                    }
                </style>
            </head>
            <body>
                <div class="page-container">
                    <!-- First Receipt -->
                    <div class="receipt">
                        <div class="header">
                            <div class="logo">
                        <img src="${logoBase64}">
                    </div> 
                    
                            <div class="institute-name">SHELAR TRAINING INSTITUTE</div>
                            <div class="receipt-label">RECEIPT</div>
                        </div>
                        <div class="receipt-content">
                            <div class="receipt-info">
                                <div class="receipt-no">Receipt No. ${receiptData.receiptNo}</div>
                                <div class="date">Date: ${receiptData.date}</div>
                                <div class="branch" style="font-weight: bold;">Branch: ${receiptData.branch}</div>
                            </div>
                            <div class="form-fields">
                                <div class="field-row">
                                    <div class="field-label">Student Name:</div>
                                    <div class="field-value">${receiptData.studentName}</div>
                                </div>
                                <div class="field-row">
                                    <div class="field-label">Course Name:</div>
                                    <div class="field-value">${receiptData.courseName}</div>
                                </div>
                                <div class="field-row amount-fields">
                                    <div class="amount-field">
                                        <div class="field-row">
                                            <div class="field-label">Total Amount:</div>
                                            <div class="field-value">${receiptData.totalAmount}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="field-row">
                                    <div class="field-label">Payment Mode:</div>
                                    <div class="field-value">${receiptData.paymentMode}</div>
                                </div>


                            </div>
                            <div class="footer">
                                <div class="note">‚Ä¢ Fees once paid are non-refundable</div>
                                <div class="signature-area">
                                    <div class="signature-line"></div>
                                    <div class="signature-label">Authorized Signature</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr style="border: 2px dashed #000; margin: 25px 0;">
                    <!-- Second Receipt (Duplicate) -->
                    <div class="receipt">
                        <div class="header">
                           <div class="logo">
                        <img src="${logoBase64}">
                    </div> 
                    
                            <div class="institute-name">SHELAR TRAINING INSTITUTE</div>
                            <div class="receipt-label">RECEIPT</div>
                        </div>
                        <div class="receipt-content">
                            <div class="receipt-info">
                                <div class="receipt-no">Receipt No: ${receiptData.receiptNo}</div>
                                <div class="date" style="font-weight: bold;">Date: ${receiptData.date}</div>
                                <div class="branch" style="font-weight: bold;">Branch: ${receiptData.branch}</div>
                            </div>
                            <div class="form-fields"> 
                                <div class="field-row">
                                    <div class="field-label">Student Name:</div>
                                    <div class="field-value">${receiptData.studentName}</div>
                                </div>
                                <div class="field-row">
                                    <div class="field-label">Course Name:</div>
                                    <div class="field-value">${receiptData.courseName}</div>
                                </div>
                                <div class="field-row amount-fields">
                                    <div class="amount-field">
                                        <div class="field-row">
                                            <div class="field-label">Total Amount:</div>
                                            <div class="field-value">${receiptData.totalAmount}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="field-row">
                                    <div class="field-label">Payment Mode:</div>
                                    <div class="field-value">${receiptData.paymentMode}</div>
                                </div>

                                <div class="field-row">
                                    <div class="field-label">Branch:</div>
                                    <div class="field-value">${receiptData.branch}</div>
                                </div>


                            </div>
                            <div class="footer">
                                <div class="note">‚Ä¢ Fees once paid are non-refundable</div>
                                <div class="signature-area">
                                    <div class="signature-line"></div>
                                    <div class="signature-label">Authorized Signature</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <script>
                    setTimeout(() => {
                        window.print();
                    }, 500);
                </scr` + `ipt>
            </body>
            </html>
        `;

        // Open a new tab and write the receipt
        const printWindow = window.open('', '_blank', 'width=800,height=1000');
        printWindow.document.write(receiptHTML);
        printWindow.document.close();
        console.log("Student Name from form:", studentName);
        console.log("Course Name from form:", courseName);


    } catch (error) {
        console.error("Error generating receipt:", error);
        alert("Error generating receipt. Please check the console for details.");
    }
}


function generateAndSaveReceipt() {
  // First validate the form
  const form = document.getElementById('examReceiptForm');
  const formData = new FormData(form);

  const receiptNumber = formData.get('receiptNumber');

  // Validate that receipt number is loaded
  if (!receiptNumber || receiptNumber === 'Generating...' || receiptNumber === '') {
    showNotification("Please wait for the receipt number to load before proceeding.", "error");
    return;
  }

  // Check if terms are agreed
  if (!document.getElementById('agreeTerms').checked) {
    document.getElementById('agreeError').classList.remove('hidden');
    showNotification("Please agree to the terms and conditions.", "error");
    return;
  } else {
    document.getElementById('agreeError').classList.add('hidden');
  }

  // Get current date in a format that Google Apps Script can handle
  const now = new Date();
  const dateString = (now.getMonth() + 1) + '/' + now.getDate() + '/' + now.getFullYear();

  const data = {
    receiptDate: dateString, // Current date as MM/DD/YYYY string
    receiptNumber: receiptNumber,
    enrollmentId: formData.get('enrollmentId'),
    studentName: formData.get('studentName'),
    courseName: formData.get('courseName'),
    totalAmount: formData.get('totalAmount'),
    paymentMode: formData.get('paymentMode'),
    agreeTerms: formData.get('agreeTerms') ? 'Yes' : 'No'
  };

  // Show loading state
  const btn = document.getElementById('generateReceiptBtn');
  const originalText = btn.innerHTML;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
  btn.disabled = true;

  google.script.run
    .withSuccessHandler(function(result) {
      if (result && result.success) {
        // Success notification
        showNotification(result.message || "Receipt saved successfully! Generating receipt...", "success");

        // Store current form values before resetting
        const currentFormData = {
          receiptNumber: formData.get('receiptNumber'),
          studentName: formData.get('studentName'),
          courseName: formData.get('courseName'),
          totalAmount: formData.get('totalAmount'),
          paymentMode: formData.get('paymentMode'),
          receiptDate: formData.get('receiptDate')
        };

        // Reset form but keep the date
        form.reset();

        // Reload only receipt number for next entry (without resetting date)
        loadexamfeeOnly();

        // Now generate the receipt with stored values
        setTimeout(() => {
          generateexamReceipt(currentFormData);
        }, 1000); // Small delay to ensure save is complete

      } else {
        // Error notification
        showNotification(result.message || "Failed to save receipt. Please try again.", "error");
        // Reset button
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    })
    .withFailureHandler(function(error) {
      // Reset button
      btn.innerHTML = originalText;
      btn.disabled = false;

      // Error notification
      showNotification("Error saving receipt: " + error.message, "error");
      console.error("Save receipt error:", error);
    })
    .saveReceiptData(data);
}

function loadexamfee(){
  const receiptInput = document.getElementById("ExamReceiptNumber");
  const submitBtn = document.getElementById("generateReceiptBtn");

  if (!receiptInput) {
    console.error("Receipt number input field not found!");
    return;
  }

  // Disable submit button while loading
  if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
  }

  // 1. Reset the input field's state each time the form is opened.
  receiptInput.readOnly = false;
  receiptInput.value = "Generating..."; // Show immediate feedback.

  // 2. Clear any lingering timers from previous times the form was opened.
  clearTimeout(receiptLockTimer);

  // 3. Call the backend script to fetch the number.
  google.script.run
    .withSuccessHandler(function (newReceiptNumber) {
      // 4. Populate the input field as soon as the number is received.
      receiptInput.value = newReceiptNumber;
      console.log(
        `Populated receipt number: ${newReceiptNumber}. Field will lock in 5 seconds if not edited.`
      );

      // Enable submit button now that receipt number is loaded
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-print mr-2"></i>Generate Receipt';
      }

      // 5. Set a 5-second timer. If it completes, the field becomes read-only.
      receiptLockTimer = setTimeout(() => {
        receiptInput.readOnly = true;
        console.log(`Receipt number ${newReceiptNumber} is now locked.`);
      }, 5000); // 5000 milliseconds = 5 seconds

      // 6. Listen for the *very first* input from the user.
      // The { once: true } option automatically removes the listener after it runs once.
      receiptInput.addEventListener(
        "input",
        () => {
          console.log("User is typing. Cancelling the auto-lock timer.");
          // If the user starts typing, cancel the timer that would have locked the field.
          clearTimeout(receiptLockTimer);
        },
        { once: true }
      );
    })
    .withFailureHandler(function (error) {
      console.error("Error fetching receipt number: " + error.message);
      receiptInput.value = "Error fetching number";

      // Re-enable submit button even on error, so user can try again
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Receipt';
      }
    })
    .getNextReceiptNumberEF();
}

function loadexamfeeOnly(){
  const receiptInput = document.getElementById("ExamReceiptNumber");
  const submitBtn = document.getElementById("generateReceiptBtn");

  if (!receiptInput) {
    console.error("Receipt number input field not found!");
    return;
  }

  // Disable submit button while loading
  if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
  }

  // Clear any lingering timers
  clearTimeout(receiptLockTimer);

  // Set to generating state
  receiptInput.readOnly = false;
  receiptInput.value = "Generating...";

  // Call the backend script to fetch the number
  google.script.run
    .withSuccessHandler(function (newReceiptNumber) {
      // Populate the input field
      receiptInput.value = newReceiptNumber;
      console.log(`Loaded next receipt number: ${newReceiptNumber}`);

      // Enable submit button
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-print mr-2"></i>Generate Receipt';
      }

      // Set a 5-second timer to lock the field
      receiptLockTimer = setTimeout(() => {
        receiptInput.readOnly = true;
        console.log(`Receipt number ${newReceiptNumber} is now locked.`);
      }, 5000);
    })
    .withFailureHandler(function (error) {
      console.error("Error fetching receipt number: " + error.message);
      receiptInput.value = "Error fetching number";

      // Re-enable submit button even on error
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-print mr-2"></i>Generate Receipt';
      }
    })
    .getNextReceiptNumberEF();
}
</script>
