<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enhanced Fee Management Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet" />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet" />
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- html2pdf -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
         body {
         font-family: 'Inter', sans-serif;
         }
         .modal {
         position: fixed;
         top: 0;
         left: 0;
         right: 0;
         bottom: 0;
         background: rgba(0, 0, 0, 0.5);
         display: flex;
         justify-content: center;
         align-items: center;
         z-index: 999;
         }
         .modal-content {
         background: #fff;
         padding: 1.5rem;
         border-radius: 0.5rem;
         width: 90%;
         max-width: 500px;
         }
         .printable {
         background: white;
         min-height: 100vh;
         }
         @media print {
         @page {
         size: A4 portrait;
         margin: 0;
         }
         body {
         margin: 0;
         padding: 0;
         font-size: 12px;
         background: white;
         }
         /* Hide everything except printable receipt */
         body * {
         visibility: hidden;
         }
         #separateReceipt,
         #separateReceipt * {
         visibility: visible;
         }
         #separateReceipt {
         position: absolute;
         left: 0;
         top: 0;
         width: 100%;
         margin: 0;
         padding: 10mm;
         box-shadow: none;
         }
         .no-print {
         display: none !important;
         }
         #ifId {
         display: flex;
         justify-content: center;
         align-items: center;
         min-height: 100vh;
         background-color: #f3f4f6;
         /* Tailwind's gray-100 */
         padding: 1rem;
         }
         }
      </style>
  </head>
  <body class="bg-gray-100">
    <!-- LOGIN SECTION -->
    <div id="loginSection"
      class="min-h-screen bg-gradient-to-br from-blue-600 to-purple-700 flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8 space-y-6">
        <div class="text-center">
          <img
            src="https://i.postimg.cc/DZFDcqP8/IMG-20250320-WA0023-1-modified-3.png"
            class="w-24 mx-auto mb-4 rounded-lg" alt="Institute Logo" />
          <h2 class="text-3xl font-bold text-gray-800">Shelar Training
            Institute</h2>
          <p class="text-gray-500 mt-2">Sign in to continue</p>
        </div>
        <form id="loginForm" class="space-y-4">
          <div>
            <label
              class="block text-sm font-medium text-gray-700 mb-1">Username</label>
            <div class="relative">
              <input type="text" id="loginUsername"
                class="w-full px-4 py-3 rounded-lg border border-gray-300 
                        focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="Enter username" required />
              <i class="fas fa-user absolute right-3 top-3.5 text-gray-400"></i>
            </div>
          </div>
          <div>
            <label
              class="block text-sm font-medium text-gray-700 mb-1">Password</label>
            <div class="relative">
              <input type="password" id="loginPassword"
                class="w-full px-4 py-3 rounded-lg border border-gray-300 
                        focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="••••••••" required />
              <i class="fas fa-lock absolute right-3 top-3.5 text-gray-400"></i>
            </div>
          </div>
          <button type="submit"
            class="w-full bg-blue-600 text-white py-3 rounded-lg 
                  hover:bg-blue-700 transition-colors font-medium">
            Sign In
          </button>
        </form>
      </div>
    </div>
    <!-- MAIN APP SECTION -->
    <div id="appSection" class="hidden min-h-screen">
      <div class="flex min-h-screen">
        <!-- SIDEBAR -->
        <aside class="bg-blue-800 text-white w-64 hidden md:flex flex-col">
          <div
            class="py-6 px-4 bg-blue-900 flex flex-col items-center justify-center">
            <img
              src="https://i.postimg.cc/DZFDcqP8/IMG-20250320-WA0023-1-modified-3.png"
              class="w-24 mx-auto mb-4 rounded-lg" alt="Institute Logo" />
            <h2 class="text-lg font-bold">STI</h2>
            <p class="text-xs text-blue-200">Role: <span
                id="userRoleDisplay"></span></p>
          </div>
          <!-- SIDEBAR SEARCH -->
          <div class="p-4">
            <label class="block text-xs text-blue-200">Search Student ID</label>
            <div class="mt-1 relative">
              <input type="text" id="sideBarSearchId"
                class="w-full pl-4 pr-10 py-2 rounded-md text-black 
                  focus:ring-2 focus:ring-blue-300 focus:outline-none"
                placeholder="e.g. ST001" />
              <button onclick="searchBySideBar()"
                class="absolute right-2 top-1.5 text-gray-500 hover:text-blue-600">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>
          <nav class="flex-1 px-4 py-4 space-y-2">
            <button onclick="openSlip()"
              class="w-full flex items-center gap-2 px-3 py-2 rounded-md text-white hover:bg-blue-700">
              <i class="fas fa-file-alt"></i>
              <span>Slip</span>
            </button>
            <button onclick="openInquiryForm()"
              class="w-full flex items-center gap-2 px-3 py-2 rounded-md text-white hover:bg-blue-700">
              <i class="fas fa-plane-plus"></i>
              <span>Inquiry Form</span>
            </button>
            <button onclick="openAdmissionForm()"
              class="w-full flex items-center gap-2 px-3 py-2 rounded-md text-white hover:bg-blue-700">
              <i class="fas fa-user-plus"></i>
              <span>Admission Form</span>
            </button>
            <button onclick="searchOldFees()"
              class="w-full flex items-center gap-2 px-3 py-2 rounded-md text-white hover:bg-blue-700">
              <i class="fas fa-history"></i>
              <span>Old Records</span>
            </button>
            <button id="manageStudentsBtn" onclick="toggleManageStudents()"
              class="hidden w-full flex items-center gap-2 px-3 py-2 rounded-md text-white hover:bg-blue-700">
              <i class="fas fa-users"></i>
              <span>Manage Students</span>
            </button>
            <button id="analyticsBtn" onclick="toggleAnalytics()"
              class="hidden w-full flex items-center gap-2 px-3 py-2 rounded-md text-white hover:bg-blue-700">
              <i class="fas fa-chart-pie"></i>
              <span>Analytics</span>
            </button>
            <button id="classMonthDashboardBtn"
              onclick="toggleClassMonthDashboard()"
              class="hidden w-full flex items-center gap-2 px-3 py-2 rounded-md text-white hover:bg-blue-700">
              <i class="fas fa-school"></i>
              <span>Class Dashboard</span>
            </button>
            <button id="dueFeesBtn" onclick="toggleDueFees()"
              class="hidden w-full flex items-center gap-2 px-3 py-2 rounded-md text-white hover:bg-blue-700">
              <i class="fas fa-hand-holding-usd"></i>
              <span>Due Fees</span>
            </button>
            <button onclick="downloadPDF()"
              class="w-full flex items-center gap-2 px-3 py-2 rounded-md text-white hover:bg-blue-700">
              <i class="fas fa-file-pdf"></i>
              <span>Download PDF</span>
            </button>
            <button onclick="showLatestReceipt()"
              class="w-full flex items-center gap-2 px-3 py-2 rounded-md text-white hover:bg-blue-700">
              <i class="fas fa-receipt"></i>
              <span>View Receipt</span>
            </button>
            <button onclick="logout()"
              class="mt-6 w-full flex items-center gap-2 px-3 py-2 rounded-md text-white bg-red-600 hover:bg-red-700">
              <i class="fas fa-sign-out-alt"></i>
              <span>Logout</span>
            </button>
          </nav>
        </aside>
        <!-- MAIN CONTENT -->
        <main class="flex-1 p-4 overflow-y-auto">
          <!-- HIDDEN INPUTS -->
          <input type="hidden" id="userName" />
          <input type="hidden" id="userRole" />
          <!-- SLIP FORM SECTION -->
          <div id="slipFormSection"
            class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
            <div
              class="flex flex-col md:flex-row justify-between items-start mb-6">
              <div>
                <label
                  class="block text-sm font-medium text-gray-700 mb-1">Student
                  ID</label>
                <div class="flex items-center gap-2">
                  <input type="text" id="studentId"
                    class="w-44 px-3 py-2 border-b-2 border-gray-300 focus:border-blue-500 outline-none" />
                  <!-- Button to fetch old slips by typed ID -->
                  <button type="button" onclick="searchOldFeesFromSlip()"
                    class="px-2 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300">
                    View Old Slips
                  </button>
                </div>
              </div>
              <img
                src="https://i.postimg.cc/DZFDcqP8/IMG-20250320-WA0023-1-modified-3.png"
                class="w-24 mx-auto mb-4 rounded-lg" alt="Institute Logo" />
              <div class="text-right">
                <p class="text-lg font-bold text-red-600">TRAINEE COPY</p>
                <p class="text-sm text-gray-500">Generated at: <span
                    id="generatedTime"></span></p>
              </div>
            </div>
            <div class="text-center mb-6">
              <h1 class="text-3xl font-bold text-gray-800 mb-2">Shelar Training
                Institute</h1>
            </div>
            <form id="receiptForm" class="space-y-6">
              <input type="hidden" id="recordRowNumber" />
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                  <label
                    class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                  <input type="date" id="date"
                    class="w-full px-3 py-2 border-b-2 border-gray-300 focus:border-blue-500 outline-none"
                    onchange="updateMonthField()" />
                </div>
                <div>
                  <label
                    class="block text-sm font-medium text-gray-700 mb-1">Month</label>
                  <input type="text" id="monthField"
                    class="w-full px-3 py-2 border-b-2 border-gray-300 bg-gray-50 focus:border-blue-500 outline-none"
                    readonly />
                </div>
                <div>
                  <label
                    class="block text-sm font-medium text-gray-700 mb-1">Session</label>
                  <select id="session"
                    class="w-full px-3 py-2 border-b-2 border-gray-300 focus:border-blue-500 outline-none">
                    <option value>Loading...</option>
                  </select>
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label
                    class="block text-sm font-medium text-gray-700 mb-1">Transaction
                    ID</label>
                  <input type="text" id="transactionId"
                    class="w-full px-3 py-2 border-b-2 border-gray-300 focus:border-blue-500 outline-none" />
                </div>
                <div>
                  <label
                    class="block text-sm font-medium text-gray-700 mb-1">Course</label>
                  <select id="trade"
                    class="w-full px-3 py-2 border-b-2 border-gray-300 focus:border-blue-500 outline-none">
                    <option value>Loading...</option>
                  </select>
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label
                    class="block text-sm font-medium text-gray-700 mb-1">Student
                    Name</label>
                  <input type="text" id="studentName"
                    class="w-full px-3 py-2 border-b-2 border-gray-300 focus:border-blue-500 outline-none" />
                </div>
                <div>
                  <label
                    class="block text-sm font-medium text-gray-700 mb-1">Father's
                    Name</label>
                  <input type="text" id="fatherName"
                    class="w-full px-3 py-2 border-b-2 border-gray-300 focus:border-blue-500 outline-none" />
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label
                    class="block text-sm font-medium text-gray-700 mb-1">Paid
                    Amount ($)</label>
                  <input type="number" id="paidAmount"
                    class="w-full px-3 py-2 border-b-2 border-gray-300 focus:border-blue-500 outline-none"
                    oninput="convertAmountToWords()" />
                </div>
                <div>
                  <label
                    class="block text-sm font-medium text-gray-700 mb-1">Amount
                    in Words</label>
                  <input type="text" id="paidAmountInWord"
                    class="w-full px-3 py-2 border-b-2 border-gray-300 bg-gray-50 focus:border-blue-500 outline-none"
                    readonly />
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label
                    class="block text-sm font-medium text-gray-700 mb-1">Branch</label>
                  <select id="feesType"
                    class="w-full px-3 py-2 border-b-2 border-gray-300 focus:border-blue-500 outline-none">
                    <option value>Loading...</option>
                  </select>
                </div>
                <div>
                  <label
                    class="block text-sm font-medium text-gray-700 mb-1">Payment
                    Mode</label>
                  <select id="paymentMode"
                    class="w-full px-3 py-2 border-b-2 border-gray-300 focus:border-blue-500 outline-none">
                    <option value>Loading...</option>
                  </select>
                </div>
              </div>
              <input type="hidden" id="remark" />
              <div class="mt-12 pt-6 border-t border-gray-200">
                <div class="flex flex-col md:flex-row justify-between gap-4">
                  <div class="text-sm text-gray-500">
                    <p>* Fees once paid cannot be refunded under any
                      circumstances</p>
                    <p class="mt-2"> Gmail:
                      shelartraininginstitute@gmail.com</p>
                  </div>
                  <div class="text-right">
                    <p class="font-medium">Authorized Signature</p>
                    <div
                      class="mt-2 h-12 w-48 border-b-2 border-gray-300"></div>
                  </div>
                </div>
              </div>
              <div class="no-print mt-8 flex flex-wrap justify-end gap-4">
                <button type="reset"
                  class="px-6 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg">Clear</button>
                <button id="btnSubmitNew" type="submit"
                  class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">
                  Save Receipt
                </button>
                <button id="btnUpdateData" type="button"
                  class="hidden px-6 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-medium"
                  onclick="updateFeeData()">
                  Update Receipt
                </button>
              </div>
            </form>
          </div>
          <!-- ADD RECEIPT SECTION -->
          <div id="separateReceipt"
            class="hidden printable bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl mx-auto my-8">
            <div class="flex items-center mb-4">
              <img
                src="https://i.postimg.cc/DZFDcqP8/IMG-20250320-WA0023-1-modified-3.png"
                class="w-24 mx-auto mb-4 rounded-lg" alt="Institute Logo" />
              <h1 class="text-2xl font-bold text-center">SHELAR TRAINING
                INSTITUTE</h1>
            </div>
            <div class="text-center mb-4">
              <span class="border border-black px-2 py-1">RECEIPT</span>
            </div>
            <div class="flex justify-between mb-4">
              <div>
                <span class="font-bold">Receipt No.</span>
                <span id="receiptNumber">400</span>
              </div>
              <div>
                <span class="font-bold">Date :</span>
                <span id="receiptDate">________________</span>
              </div>
            </div>
            <div class="mb-4">
              <span class="font-bold">Full Name :</span>
              <span
                id="receiptStudentName">______________________________</span>
            </div>
            <div class="mb-4">
              <span class="font-bold">Propose to Pay :</span>
              <span id="receiptCourse">______________________________</span>
            </div>
            <div class="flex justify-between mb-4">
              <div>
                <span class="font-bold">Total Amount :</span>
                <span id="receiptTotalAmount">________________</span>
              </div>
              <div>
                <span class="font-bold">Paid :</span>
                <span id="receiptPaidAmount">________________</span>
              </div>
              <div>
                <span class="font-bold">Balance Amount :</span>
                <span id="receiptBalance">________________</span>
              </div>
            </div>
            <div class="mb-4">
              <!-- <span class="font-bold">Exam Fees :</span> -->
              <span id="receiptExamFees">______________________________</span>
            </div>
            <div class="mb-4">
              <span class="font-bold">Received by :</span>
              <span id="receiptReceivedBy">______________________________</span>
            </div>
            <div class="mb-4">
              <span class="font-bold">•</span>
              <span>Once you pay fees for course not refundable.</span>
            </div>
            <div class="text-right">
              <span class="font-bold">Authority Signature</span>
            </div>
            <div class="no-print mt-6 text-center">
              <button onclick="printReceipt()"
                class="px-6 py-2 bg-blue-600 text-white rounded-lg">
                <i class="fas fa-print mr-2"></i>Print Receipt
              </button>
              <button onclick="backToSlipForm()"
                class="px-6 py-2 bg-gray-500 text-white rounded-lg ml-4">
                <i class="fas fa-arrow-left mr-2"></i>Back
              </button>
            </div>
          </div>
          <!-- OLD FEES SECTION -->
          <div id="oldFeesSection"
            class="hidden bg-white rounded-xl shadow-lg p-6 border border-gray-200 mt-6">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold text-gray-800">Payment History</h2>
              <button onclick="backToSlipForm()"
                class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg flex items-center gap-2">
                <i class="fas fa-arrow-left"></i> Back
              </button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th
                      class="px-4 py-3 text-left text-sm font-medium text-gray-700">Date</th>
                    <th
                      class="px-4 py-3 text-left text-sm font-medium text-gray-700">Month</th>
                    <th
                      class="px-4 py-3 text-left text-sm font-medium text-gray-700">Amount</th>
                    <th
                      class="px-4 py-3 text-left text-sm font-medium text-gray-700">Transaction
                      ID</th>
                    <th
                      class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                  </tr>
                </thead>
                <tbody id="oldFeesTable"
                  class="divide-y divide-gray-200"></tbody>
              </table>
            </div>
          </div>
          <!-- ANALYTICS SECTION -->
          <div id="analyticsSection"
            class="hidden bg-white rounded-xl shadow-lg p-6 border border-gray-200 mt-6">
            <div
              class="flex flex-col md:flex-row justify-between items-center mb-6">
              <h2 class="text-2xl font-bold text-gray-800">Fees Analytics</h2>
              <div class="flex items-center gap-4 flex-wrap">
                <label>From</label>
                <input type="date" id="analyticsDateFrom"
                  class="px-2 py-1 border rounded" />
                <label>To</label>
                <input type="date" id="analyticsDateTo"
                  class="px-2 py-1 border rounded" />
                <select id="analyticsMonthFilter"
                  class="px-2 py-1 border rounded" onchange="loadAnalytics()">
                  <option value>All Months</option>
                  <option value="Jan">Jan</option>
                  <option value="Feb">Feb</option>
                  <option value="Mar">Mar</option>
                  <option value="Apr">Apr</option>
                  <option value="May">May</option>
                  <option value="Jun">Jun</option>
                  <option value="Jul">Jul</option>
                  <option value="Aug">Aug</option>
                  <option value="Sep">Sep</option>
                  <option value="Oct">Oct</option>
                  <option value="Nov">Nov</option>
                  <option value="Dec">Dec</option>
                </select>
                <select id="analyticsFeesTypeFilter"
                  class="px-2 py-1 border rounded" onchange="loadAnalytics()">
                  <option value>Branch</option>
                </select>
                <select id="analyticsPaymentModeFilter"
                  class="px-2 py-1 border rounded" onchange="loadAnalytics()">
                  <option value>All Payment Modes</option>
                </select>
                <button onclick="loadAnalytics()"
                  class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded">
                  Filter
                </button>
                <!-- CLEAR FILTER -->
                <button onclick="clearAnalyticsFilter()"
                  class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded">
                  Clear Filter
                </button>
                <button onclick="backToSlipFromAnalytics()"
                  class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg flex items-center gap-2">
                  <i class="fas fa-arrow-left"></i> Back
                </button>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
              <div
                class="bg-blue-100 p-4 rounded-lg flex flex-col items-center">
                <p class="text-sm text-gray-700">Total Paid Fees</p>
                <p id="cardTotalPaid"
                  class="text-xl font-bold text-blue-900">0</p>
              </div>
              <div class="bg-red-100 p-4 rounded-lg flex flex-col items-center">
                <p class="text-sm text-gray-700">Total Unpaid Fees</p>
                <p id="cardTotalUnpaid"
                  class="text-xl font-bold text-red-900">0</p>
              </div>
              <div
                class="bg-gray-100 p-4 rounded-lg flex flex-col items-center">
                <p class="text-sm text-gray-700">Total Students</p>
                <p id="cardTotalStudents"
                  class="text-xl font-bold text-gray-900">0</p>
              </div>
              <div
                class="bg-green-100 p-4 rounded-lg flex flex-col items-center">
                <p class="text-sm text-gray-700">Paid Students</p>
                <p id="cardPaidStudents"
                  class="text-xl font-bold text-green-900">0</p>
              </div>
              <div
                class="bg-yellow-100 p-4 rounded-lg flex flex-col items-center">
                <p class="text-sm text-gray-700">Unpaid Students</p>
                <p id="cardUnpaidStudents"
                  class="text-xl font-bold text-yellow-900">0</p>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div class="bg-white p-4 rounded border shadow">
                <h3 class="text-lg font-bold mb-4">Bar Chart: Fees Paid (by
                  Date)</h3>
                <canvas id="dateWiseChart"></canvas>
              </div>
              <div class="bg-white p-4 rounded border shadow">
                <h3 class="text-lg font-bold mb-4">Line Chart: Fees Trend</h3>
                <canvas id="lineChart"></canvas>
              </div>
              <div class="bg-white p-4 rounded border shadow">
                <h3 class="text-lg font-bold mb-4">Paid vs Unpaid Fees</h3>
                <canvas id="pieChart"></canvas>
              </div>
            </div>
          </div>
          <!-- MANAGE STUDENTS SECTION -->
          <div id="manageStudentSection"
            class="hidden bg-white rounded-xl shadow-lg p-6 border border-gray-200 mt-6">
            <div
              class="flex flex-col md:flex-row justify-between items-center mb-6">
              <h2 class="text-2xl font-bold text-gray-800">Manage Students</h2>
              <div class="flex gap-4">
                <input type="text" id="studentSearchInput"
                  placeholder="Search students..."
                  class="px-4 py-2 border rounded-lg"
                  onkeyup="filterStudentList()" />
                <button onclick="openStudentModal('add')"
                  class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg font-medium flex items-center gap-2">
                  <i class="fas fa-user-plus"></i><span>Add Student</span>
                </button>
              </div>
            </div>
            <!-- Export buttons for Manage Students -->
            <div class="mb-4 flex gap-2">
              <button onclick="copyTable('studentTableContainer')"
                class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm">
                Copy
              </button>
              <button
                onclick="exportCSV('studentTableContainer','students.csv')"
                class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm">
                CSV
              </button>
              <button
                onclick="exportTablePDF('studentTableContainer','Students')"
                class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm">
                PDF
              </button>
            </div>
            <div id="studentTableContainer" class="overflow-x-auto"></div>
          </div>
          <!-- CLASS & MONTH DASHBOARD -->
          <div id="classMonthDashboard"
            class="hidden bg-white rounded-xl shadow-lg p-6 border border-gray-200 mt-6">
            <div
              class="flex flex-col md:flex-row justify-between items-center mb-6">
              <h2 class="text-2xl font-bold text-gray-800">Class &amp; Month
                Dashboard</h2>
              <button onclick="backToSlipFromClassDashboard()"
                class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg flex items-center gap-2">
                <i class="fas fa-arrow-left"></i><span>Back</span>
              </button>
            </div>
            <!-- Improved UI: added a student search box -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
              <div>
                <label
                  class="block text-sm font-medium text-gray-700 mb-1">Select
                  Class</label>
                <select id="selectClass"
                  class="w-full px-4 py-2 border rounded-lg border-gray-300"></select>
              </div>
              <div>
                <label
                  class="block text-sm font-medium text-gray-700 mb-1">Select
                  Month</label>
                <select id="selectMonth"
                  class="w-full px-4 py-2 border rounded-lg border-gray-300">
                  <option value>All Months</option>
                  <option value="Jan">Jan</option>
                  <option value="Feb">Feb</option>
                  <option value="Mar">Mar</option>
                  <option value="Apr">Apr</option>
                  <option value="May">May</option>
                  <option value="Jun">Jun</option>
                  <option value="Jul">Jul</option>
                  <option value="Aug">Aug</option>
                  <option value="Sep">Sep</option>
                  <option value="Oct">Oct</option>
                  <option value="Nov">Nov</option>
                  <option value="Dec">Dec</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Paid
                  Status</label>
                <select id="selectPaidStatus"
                  class="w-full px-4 py-2 border rounded-lg border-gray-300"
                  onchange="filterClassMonthTable()">
                  <option value="all">All</option>
                  <option value="paid">Paid Only</option>
                  <option value="unpaid">Unpaid Only</option>
                </select>
              </div>
              <!-- Student Search Input -->
              <div>
                <label
                  class="block text-sm font-medium text-gray-700 mb-1">Search
                  Student</label>
                <input type="text" id="classMonthSearchInput"
                  class="w-full px-4 py-2 border rounded-lg border-gray-300"
                  placeholder="Type name or ID..."
                  onkeyup="filterClassMonthTable()" />
              </div>
              <div class="flex items-end">
                <button onclick="loadClassMonthDashboard()"
                  class="px-4 py-2 bg-pink-600 hover:bg-pink-700 text-white rounded-lg">
                  Filter
                </button>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="bg-white p-4 rounded border shadow">
                <h3 class="text-lg font-bold mb-4">Fees Paid (Line Chart by
                  Date)</h3>
                <canvas id="classMonthLineChart"></canvas>
              </div>
              <div class="bg-white p-4 rounded border shadow">
                <h3 class="text-lg font-bold mb-4">Paid/Unpaid Pie</h3>
                <canvas id="classMonthPieChart"></canvas>
              </div>
            </div>
            <div class="mt-6 overflow-y-auto max-h-96">
              <table class="min-w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-2 text-left">Student ID</th>
                    <th class="px-4 py-2 text-left">Name</th>
                    <th class="px-4 py-2 text-left">Paid?</th>
                  </tr>
                </thead>
                <tbody id="classMonthStudentTable"></tbody>
              </table>
            </div>
          </div>
          <!-- DUE FEES SECTION -->
          <div id="dueFeesSection"
            class="hidden bg-white rounded-xl shadow-lg p-6 border border-gray-200 mt-6">
            <div
              class="flex flex-col md:flex-row justify-between items-center mb-6">
              <h2 class="text-2xl font-bold text-gray-800">Due Fees</h2>
              <button onclick="closeDueFees()"
                class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg flex items-center gap-2">
                <i class="fas fa-arrow-left"></i><span>Back</span>
              </button>
            </div>
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
              <div class="bg-blue-50 p-4 rounded flex flex-col items-center">
                <p class="text-sm text-gray-700">Total Fees</p>
                <p id="dueTotalFees"
                  class="text-xl font-bold text-blue-900">0</p>
              </div>
              <div class="bg-green-50 p-4 rounded flex flex-col items-center">
                <p class="text-sm text-gray-700">Total Paid</p>
                <p id="dueTotalPaid"
                  class="text-xl font-bold text-green-900">0</p>
              </div>
              <div class="bg-red-50 p-4 rounded flex flex-col items-center">
                <p class="text-sm text-gray-700">Total Due</p>
                <p id="dueTotalDue" class="text-xl font-bold text-red-900">0</p>
              </div>
              <div class="bg-yellow-50 p-4 rounded flex flex-col items-center">
                <p class="text-sm text-gray-700">Fully Paid Students</p>
                <p id="dueFullyPaidCount"
                  class="text-xl font-bold text-yellow-900">0</p>
              </div>
            </div>
            <!-- Filter by Class + Search + Export Buttons -->
            <div class="flex flex-wrap items-center gap-2 mb-4">
              <select id="dueFeesClassSelect"
                class="px-4 py-2 border rounded-lg border-gray-300"
                onchange="filterDueFees()">
                <option value>All Classes</option>
                <!-- filled dynamically with getClassList() -->
              </select>
              <input type="text" id="dueFeesSearch" onkeyup="filterDueFees()"
                placeholder="Search Due Fees..."
                class="px-3 py-2 border rounded-lg" />
              <button onclick="copyTable('dueFeesTableContainer')"
                class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm">Copy</button>
              <button
                onclick="exportCSV('dueFeesTableContainer','due_fees.csv')"
                class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm">CSV</button>
              <button
                onclick="exportTablePDF('dueFeesTableContainer','DueFees')"
                class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm">PDF</button>
            </div>
            <div id="dueFeesTableContainer" class="overflow-x-auto"></div>
          </div>
          <div id="admissionFormSection"
            class="hidden bg-white rounded-xl shadow-xl overflow-hidden">
            <!-- Your existing Admission Form HTML here -->
            <form class="max-w-6xl mx-auto bg-white p-6 border border-gray-300"
              onsubmit="handleSubmit(event)">
              <!-- Header Section -->
              <div class="flex justify-between items-center mb-4">
                <div class="flex items-center">
                  <img
                    src="https://i.postimg.cc/DZFDcqP8/IMG-20250320-WA0023-1-modified-3.png"
                    class="w-20 mx-auto mb-4 rounded-lg"
                    alt="Institute Logo" />
                  <div id="slipFormSection">
                    <h1 class="text-5xl font-bold text-yellow-500">STI</h1>
                    <p class="text-sm">Shelar Training Institute</p>
                  </div>
                </div>
                <div class="text-right text-sm">
                  <p>Mob: +91 9967288158</p>
                  <p>+91 7400406467</p>
                  <p>SHELAR TRAINING INSTITUTE C/34,</p>
                  <p>BUNGLOW, NEAR NANDIKESHWAR MANDIR,</p>
                  <p>KAMGAR NAGAR, KURLA (E)</p>
                </div>
              </div>
              <!-- Title Section -->
              <h2
                class="text-center text-xl font-bold bg-black text-white py-1 mb-4">ADMISSION
                FORM</h2>
              <!-- Form Fields -->
              <div class="space-y-4">
                <!-- Receipt Number -->
                <div class="flex items-center">
                  <label class="w-1/4">Receipt Number:</label>
                  <input class="border-b border-black flex-2 ml-3"
                    name="recipt_number" type="text" />
                </div>
                <!-- Student Name -->
                <div class="flex items-center">
                  <label class="w-1/4">Student Name:</label>
                  <input class="border-b border-black flex-2 ml-3"
                    name="student_name" type="text" />
                </div>
                <!-- Branch -->
                <div class="flex items-center">
                  <label class="w-1/4">Branch:</label>
                  <select class="border-b border-black flex-2 ml-3"
                    name="branch">
                    <option value disabled selected>Select Branch</option>
                    <option value="kurla">Kurla</option>
                    <option value="nala_sopara">Nala Sopara</option>
                  </select>
                </div>
                <!-- Course Name and Duration -->
                <div class="flex items-center">
                  <label class="w-1/4">Course Name:</label>
                  <select class="border-b border-black flex-2 ml-3"
                    name="course_name">
                    <option value disabled selected>Select Course</option>
                    <option value="anm_nursing">ANM Nursing Diploma
                      Course</option>
                    <option value="gnm_nursing">GNM Nursing Diploma
                      Course</option>
                    <option value="dmlt">DMLT Diploma Course</option>
                    <option value="ot_technician">OT Technician</option>
                    <option value="general_nursing">General Nursing and
                      Midwifery Assistant</option>
                    <option value="beautician">Beautician</option>
                    <option value="electrician">Electrician Course</option>
                    <option value="mobile_repairing">Mobile Repairing
                      Course</option>
                    <option value="ac_refrigerator">AC & Refrigerator</option>
                    <option value="automobile">Automobile Course</option>
                  </select>
                </div>
                <!-- Admission Fees Input -->
                <div class="flex items-center">
                  <label class="w-1/4">Admission Fees:</label>
                  <input class="border-b border-black flex-2 ml-3"
                    name="admission_fees" type="text" id="admission_fees"
                    oninput="calculateMonthlyFees()" />
                </div>
                <!-- Monthly Fees Output -->
                <div class="flex items-center">
                  <label class="w-1/4">Monthly Fees:</label>
                  <input class="border-b border-black flex-2 ml-3"
                    name="monthly_fees" type="text" id="monthly_fees"
                    readonly />
                  <label class="w-1/4 ml-4">Total:</label>
                  <input class="border-b border-black flex-2 ml-3" name="total"
                    type="text" id="total" readonly />
                </div>
              </div>
              <div class="mb-4">
                <h3 class="font-bold mb-2">
                  1
                  <sup>
                    st
                  </sup>
                  Year Fees 2025
                </h3>
    
              <table
                class="w-full border-collapse border border-black text-center">
                <tr>
                  <td class="border border-black p-1">
                    Jan 25
                  </td>
                  <td class="border border-black p-1">
                    Feb 25
                  </td>
                  <td class="border border-black p-1">
                    Mar 25
                  </td>
                  <td class="border border-black p-1">
                    Apr 25
                  </td>
                  <td class="border border-black p-1">
                    May 25
                  </td>
                  <td class="border border-black p-1">
                    Jun 25
                  </td>
                  <td class="border border-black p-1">
                    Jul 25
                  </td>
                  <td class="border border-black p-1">
                    Aug 25
                  </td>
                  <td class="border border-black p-1">
                    Sep 25
                  </td>
                  <td class="border border-black p-1">
                    Oct 25
                  </td>
                  <td class="border border-black p-1">
                    Nov 25
                  </td>
                  <td class="border border-black p-1">
                    Dec 25
                  </td>
                </tr>
                <tr>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="jan_25"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="feb_25"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="mar_25"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="apr_25"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="may_25"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="jun_25"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="jul_25"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="aug_25"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="sep_25"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="oct_25"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="nov_25"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="dec_25"
                      type="text" />
                  </td>
                </tr>
              </table>
            </div>
            <div class="mb-4">
              <h3 class="font-bold mb-2">
                2
                <sup>
                  nd
                </sup>
                Year Fees 2026
              </h3>
              <table
                class="w-full border-collapse border border-black text-center">
                <tr>
                  <td class="border border-black p-1">
                    Jan 26
                  </td>
                  <td class="border border-black p-1">
                    Feb 26
                  </td>
                  <td class="border border-black p-1">
                    Mar 26
                  </td>
                  <td class="border border-black p-1">
                    Apr 26
                  </td>
                  <td class="border border-black p-1">
                    May 26
                  </td>
                  <td class="border border-black p-1">
                    Jun 26
                  </td>
                  <td class="border border-black p-1">
                    Jul 26
                  </td>
                  <td class="border border-black p-1">
                    Aug 26
                  </td>
                  <td class="border border-black p-1">
                    Sep 26
                  </td>
                  <td class="border border-black p-1">
                    Oct 26
                  </td>
                  <td class="border border-black p-1">
                    Nov 26
                  </td>
                  <td class="border border-black p-1">
                    Dec 26
                  </td>
                </tr>
                <tr>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="jan_26"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="feb_26"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="mar_26"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="apr_26"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="may_26"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="jun_26"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="jul_26"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="aug_26"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="sep_26"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="oct_26"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="nov_26"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="dec_26"
                      type="text" />
                  </td>
                </tr>
              </table>
            </div>
            <div class="mb-4">
              <h3 class="font-bold mb-2">
                3
                <sup> rd </sup>
                Year Fees 2027
              </h3>
              <table
                class="w-full border-collapse border border-black text-center">
                <tr>
                  <td class="border border-black p-1">
                    Jan 27
                  </td>
                  <td class="border border-black p-1">
                    Feb 27
                  </td>
                  <td class="border border-black p-1">
                    Mar 27
                  </td>
                  <td class="border border-black p-1">
                    Apr 27
                  </td>
                  <td class="border border-black p-1">
                    May 27
                  </td>
                  <td class="border border-black p-1">
                    Jun 27
                  </td>
                  <td class="border border-black p-1">
                    Jul 27
                  </td>
                  <td class="border border-black p-1">
                    Aug 27
                  </td>
                  <td class="border border-black p-1">
                    Sep_27
                  </td>
                  <td class="border border-black p-1">
                    Oct 27
                  </td>
                  <td class="border border-black p-1">
                    Nov 27
                  </td>
                  <td class="border border-black p-1">
                    Dec 27
                  </td>
                </tr>
                <tr>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="jan_27"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="feb_27"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="mar_27"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="apr_27"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="may_27"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="jun_27"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="jul_27"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="aug_27"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="sep_27"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="oct_27"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="nov_27"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="dec_27"
                      type="text" />
                  </td>
                </tr>
              </table>
            </div>
            <div class="mb-4">
              <h3 class="font-bold mb-2">
                3
                <sup>
                  rd
                </sup>
                Year Fees 2028
              </h3>
              <table
                class="w-full border-collapse border border-black text-center">
                <tr>
                  <td class="border border-black p-1">
                    Jan 28
                  </td>
                  <td class="border border-black p-1">
                    Feb 28
                  </td>
                  <td class="border border-black p-1">
                    Mar 28
                  </td>
                  <td class="border border-black p-1">
                    Apr 28
                  </td>
                  <td class="border border-black p-1">
                    May 28
                  </td>
                  <td class="border border-black p-1">
                    Jun 28
                  </td>
                  <td class="border border-black p-1">
                    Jul 28
                  </td>
                  <td class="border border-black p-1">
                    Aug 28
                  </td>
                  <td class="border border-black p-1">
                    Sep 28
                  </td>
                  <td class="border border-black p-1">
                    Oct 28
                  </td>
                  <td class="border border-black p-1">
                    Nov 28
                  </td>
                  <td class="border border-black p-1">
                    Dec 28
                  </td>
                </tr>
                <tr>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="jan_28"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="feb_28"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="mar_28"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="apr_28"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="may_28"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="jun_28"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="jul_28"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="aug_28"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="sep_28"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="oct_28"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="nov_28"
                      type="text" />
                  </td>
                  <td class="border border-black p-1">
                    <input class="w-full border-none text-center" name="dec_28"
                      type="text" />
                  </td>
                </tr>
              </table>
            </div>
            <div class="mb-4">
              <p>
                I Am Mr./Ms.
                <input class="border-b border-black inline-block w-full"
                  name="I Am Mr./Ms." type="text" />
                Mother / Father / Husband / Sister / Brother of
                <input class="border-b border-black inline-block w-full"
                  name="Mother / Father / Husband / Sister / Brother of"
                  type="text" />
              </p>
              <!-- Agree to Terms -->
              <div class="mb-4">
                <label class="inline-flex items-center">
                  <input type="checkbox" id="agree" name="agree" required
                    class="form-checkbox h-6 w-5 text-blue-600"><span
                    class="ml-2 text-gray-700 text-sm">I agree to the
                    terms and conditions</span>
                </label>
                <div class="text-red-500 text-xs italic" id="agreeError"></div>
              </div>
              <div class="space-y-4">
                <div class="flex flex-col items-center space-y-2">
                  <div class="flex items-center space-x-8">
                    <div class="flex flex-col items-center space-y-4">
                      <div class="w-24 border-t border-black"></div>
                      <span class="text-lg">Parent Signature</span>
                    </div>
                    <div class="flex flex-col items-center space-y-4">
                      <div class="w-24 border-t border-black"></div>
                      <span class="text-lg">Student Signature</span>
                    </div>
                    <div class="flex flex-col items-center space-y-4">
                      <div class="w-24 border-t border-black"></div>
                      <span class="text-lg">Manager Signature</span>
                    </div>
                    <div class="flex flex-col items-center space-y-4">
                      <div class="w-24 border-t border-black"></div>
                      <span class="text-lg">Director Signature</span>
                    </div>
                  </div>
                </div>
                <div class="flex justify-center">
                  <!-- Submit Button -->
                  <button type="submit"
                    id="submitButton"
                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                    onclick="generatePDFAdmission()">
                    <i class="fa fa-paper-plane mr-2"></i>
                    Submit
                  </button>
                </div>          
              </div>
            </div>
          </form>
        </div>
        
        <!-- Invoice View (Hidden Initially) -->
        <div class="flex items-center justify-center bg-gray-100 p-4">
          <div id="inquiryFormSection"
            class="hidden bg-white rounded-xl shadow-xl overflow-hidden w-full max-w-4xl">
            <div id="container" class="hidden">
              <div class="flex justify-center">
                <img
                  src="https://i.postimg.cc/DZFDcqP8/IMG-20250320-WA0023-1-modified-3.png"
                  class="logo" alt="Institute Logo">
              </div>
              <h1 class="text-center text-2xl font-bold my-4">Invoice - Shelar
                Training Institute</h1>
              <button onclick="fetchData()"
                class="bg-blue-600 text-white px-4 py-2 rounded mx-auto block">Fetch
                Data</button>
              <div id="details"></div>
              <div id="output"></div>
              <div id="emiOutput"></div>
              <div class="flex justify-center gap-4 my-4">
                <button id="prevButton" onclick="prevPage()"
                  class="bg-blue-600 text-white px-4 py-2 rounded"
                  style="display:none;">Previous</button>
                <button id="nextButton" onclick="nextPage()"
                  class="bg-blue-600 text-white px-4 py-2 rounded"
                  style="display:none;">Next</button>
              </div>
            </div>
          </div>
        </div>


          <!-- Form View (Visible Initially) -->
          <form id="ifId" class="flex justify-center items-center bg-gray-100" onsubmit="submitInquiryForm(event)">
           <div class="max-w-4xl mx-auto px-4">
              <!-- Added mx-auto here for centering -->
              <div class="bg-white rounded-xl shadow-xl">
                <!-- Header -->
                <div class="header-bg text-white p-6">
                  <div
                    class="flex flex-col md:flex-row md:items-center md:justify-between">
                    <div class="flex items-center space-x-4 mb-4 md:mb-0">
                      <div
                        class="w-12 h-12 bg-white rounded-lg flex items-center justify-center shadow-md">
                        <img
                          src="https://i.postimg.cc/DZFDcqP8/IMG-20250320-WA0023-1-modified-3.png"
                          alt="Logo" class="w-10 h-10 object-contain">
                      </div>
                      <div>
                        <h1 class="text-xl md:text-2xl font-bold">STI SHELAR
                          TRAINING INSTITUTE</h1>
                        <p class="text-xs md:text-sm opacity-90">
                          <i class="fas fa-map-marker-alt mr-1"></i>
                          C/34, Bunglow, Near Nandikeshwar Mandir, Kamgar Nagar,
                          Kurla(E)
                        </p>
                      </div>
                    </div>
                    <div class="text-center md:text-right">
                      <p class="text-yellow-300 font-medium">
                        <i class="fas fa-file-alt mr-1"></i> INQUIRY FORM
                      </p>
                      <div class="mt-2 text-xs">
                        <p><i class="fas fa-phone-alt mr-1"></i> +91
                          9967288158</p>
                        <p><i class="fas fa-phone-alt mr-1"></i> +91
                          7400406467</p>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Form Content -->
                <div class="flex items-start justify-center p-6 bg-gray-50">
                  <div id="InquiryForm" class="space-y-5">
                    <!-- Personal Details Row -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                      <div>
                        <label for="date"
                          class="block text-sm font-medium text-gray-700 mb-1">
                          <i
                            class="fas fa-calendar-alt text-blue-900 mr-2"></i>Date
                        </label>
                        <input type="date" id="date" name="date" required
                          class="form-input w-full px-4 py-2 rounded-lg border border-gray-300">
                      </div>
                      <div>
                        <label for="fullName"
                          class="block text-sm font-medium text-gray-700 mb-1">
                          <i class="fas fa-user text-blue-900 mr-2"></i>Full
                          Nameee
                        </label>
                        <input type="text" id="fullName" name="fullName"
                          required
                          class="form-input w-full px-4 py-2 rounded-lg border border-gray-300">
                      </div>
                    </div>
                    <!-- Education Row -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                      <div>
                        <label for="qualification"
                          class="block text-sm font-medium text-gray-700 mb-1">
                          <i
                            class="fas fa-graduation-cap text-blue-900 mr-2"></i>Qualification
                        </label>
                        <input type="text" id="qualification"
                          name="qualification"
                          required
                          class="form-input w-full px-4 py-2 rounded-lg border border-gray-300">
                      </div>
                      <div>
                        <label for="age"
                          class="block text-sm font-medium text-gray-700 mb-1">
                          <i
                            class="fas fa-birthday-cake text-blue-900 mr-2"></i>Age
                        </label>
                        <input type="number" id="age" name="age" required
                          class="form-input w-full px-4 py-2 rounded-lg border border-gray-300">
                      </div>
                    </div>
                    <!-- Contact Information -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                      <h3
                        class="text-blue-900 font-semibold mb-3 flex items-center">
                        <i class="fas fa-address-card mr-2"></i>Contact
                        Information
                      </h3>
                      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                          <label for="phoneNo"
                            class="block text-sm font-medium text-gray-700 mb-1">
                            <i
                              class="fas fa-mobile-alt text-blue-900 mr-2"></i>Phone
                          </label>
                          <input type="text" id="phoneNo" name="phoneNo"
                            required
                            class="form-input w-full px-4 py-2 rounded-lg border border-gray-300">
                        </div>
                        <div>
                          <label for="whatsappNo"
                            class="block text-sm font-medium text-gray-700 mb-1">
                            <i
                              class="fab fa-whatsapp text-blue-900 mr-2"></i>WhatsApp
                          </label>
                          <input type="text" id="whatsappNo" name="whatsappNo"
                            required
                            class="form-input w-full px-4 py-2 rounded-lg border border-gray-300">
                        </div>
                        <div>
                          <label for="parentsNo"
                            class="block text-sm font-medium text-gray-700 mb-1">
                            <i
                              class="fas fa-user-friends text-blue-900 mr-2"></i>Parents
                            No
                          </label>
                          <input type="text" id="parentsNo" name="parentsNo"
                            required
                            class="form-input w-full px-4 py-2 rounded-lg border border-gray-300">
                        </div>
                      </div>
                      <div class="mt-4">
                        <label for="email"
                          class="block text-sm font-medium text-gray-700 mb-1">
                          <i
                            class="fas fa-envelope text-blue-900 mr-2"></i>Email
                        </label>
                        <input type="email" id="email" name="email"
                          class="form-input w-full px-4 py-2 rounded-lg border border-gray-300">
                      </div>
                    </div>
                    <!-- Address -->
                    <div>
                      <label for="address"
                        class="block text-sm font-medium text-gray-700 mb-1">
                        <i class="fas fa-home text-blue-900 mr-2"></i>Address
                      </label>
                      <textarea id="address" name="address" required rows="3"
                        class="form-input w-full px-4 py-2 rounded-lg border border-gray-300"></textarea>
                    </div>
                    <!-- Course Details -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                      <div>
                        <label for="interestedCourse"
                          class="block text-sm font-medium text-gray-700 mb-1">
                          <i
                            class="fas fa-book text-blue-900 mr-2"></i>Interested
                          Course
                        </label>
                        <input type="text" id="interestedCourse"
                          name="interestedCourse" required
                          class="form-input w-full px-4 py-2 rounded-lg border border-gray-300">
                      </div>
                      <div>
                        <label for="inquiryTakenBy"
                          class="block text-sm font-medium text-gray-700 mb-1">
                          <i
                            class="fas fa-user-tie text-blue-900 mr-2"></i>Inquiry
                          Taken By
                        </label>
                        <input type="text" id="inquiryTakenBy"
                          name="inquiryTakenBy" required
                          class="form-input w-full px-4 py-2 rounded-lg border border-gray-300">
                      </div>
                          <div>
                            <label for="branch22" class="block text-sm font-medium text-gray-700 mb-1">
                              <i class="fas fa-building text-blue-900 mr-2"></i>Branch
                            </label>
                            <input type="text" id="branch22" name="branch" readonly
                              class="form-input w-full px-4 py-2 rounded-lg border border-gray-300" />
                          </div>
                    </div>
                    <!-- Terms and Submit -->
                    <div
                      class="border-t border-dashed border-yellow-500 my-4 pt-4">
                      <div
                        class="flex flex-col md:flex-row md:items-center md:justify-between">
                        <div class="mb-4 md:mb-0">
                          <label class="inline-flex items-center">
                            <input type="checkbox" id="agree1" name="agree"
                              required class="h-4 w-4 text-yellow-500">
                            <span class="ml-2 text-sm text-gray-700">I agree to
                              the terms</span>
                          </label>
                          <div id="agreeError1"
                            class="text-red-500 text-xs italic"></div>
                        </div>
                        <div class="flex justify-end">
                          <button type="submit" id="submitButton2"
                            class="submit-btn text-blue-600 px-8 py-2 rounded-lg font-medium">
                            <i class="fas fa-paper-plane mr-2"></i>Submit
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Footer -->
                <div class="bg-gray-50 p-4 border-t border-gray-200">
                  <div class="flex justify-end">
                    <div class="text-center">
                      <div
                        class="italic text-gray-700">______________________</div>
                      <div class="text-sm font-medium text-blue-900">AUTHORITY
                        SIGNATURE</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </form>
      </main>

      <!-- STUDENT MODAL (Add/Edit) -->
      <div id="studentModal" class="modal hidden">
        <div class="modal-content">
          <h2 id="studentModalTitle" class="text-xl font-bold mb-4">Add
            Student</h2>
          <form id="studentForm" class="space-y-4">
            <input type="hidden" id="studentRow" />
            <div>
              <label
                class="block text-sm font-medium text-gray-700 mb-1">Student ID
                (leave blank to auto-gen)</label>
              <input type="text" id="studentIdNew"
                class="w-full px-4 py-2 border rounded-lg border-gray-300" />
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label
                  class="block text-sm font-medium text-gray-700 mb-1">Session</label>
                <select id="sessionNew"
                  class="w-full px-4 py-2 border rounded-lg border-gray-300">
                  <option value>Select Session</option>
                </select>
              </div>
              <div>
                <label
                  class="block text-sm font-medium text-gray-700 mb-1">Course</label>
                <select id="tradeNew"
                  class="w-full px-4 py-2 border rounded-lg border-gray-300">
                  <option value>Select Course</option>
                </select>
              </div>
            </div>
            <div>
              <label
                class="block text-sm font-medium text-gray-700 mb-1">Student
                Name</label>
              <input type="text" id="studentNameNew"
                class="w-full px-4 py-2 border rounded-lg border-gray-300" />
            </div>
            <div>
              <label
                class="block text-sm font-medium text-gray-700 mb-1">Father's
                Name</label>
              <input type="text" id="fatherNameNew"
                class="w-full px-4 py-2 border rounded-lg border-gray-300" />
            </div>
            <div>
              <label
                class="block text-sm font-medium text-gray-700 mb-1">Institute
                Name</label>
              <input type="text" id="instituteNameNew"
                class="w-full px-4 py-2 border rounded-lg border-gray-300" />
            </div>
            <div>
              <label
                class="block text-sm font-medium text-gray-700 mb-1">Class</label>
              <input type="text" id="classNameNew"
                class="w-full px-4 py-2 border rounded-lg border-gray-300" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Total
                Fees</label>
              <input type="number" id="totalFeesNew"
                class="w-full px-4 py-2 border rounded-lg border-gray-300" />
            </div>
            <div class="flex justify-end gap-4">
              <button type="button" onclick="closeStudentModal()"
                class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg">
                Cancel
              </button>
              <button type="submit" id="studentModalBtn"
                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                Add Student
              </button>
            </div>
          </form>
        </div>
      </div>
    

      <script>
         /******************************************
         * 0) INITIAL SETUP & GLOBALS
         ******************************************/
         let dropdownData = {
         sessions: [], 
         trades: [], 
         feesTypes: [], 
         paymentModes: []
         };
         
         // We'll store the data used in Class Dashboard
         let classMonthLineChartRef = null; 
         let classMonthPieChartRef = null; 
         let classMonthData = [];
         
         // For Analytics
         let dateWiseChartRef = null;
         let lineChartRef = null;
         let pieChartRef = null;
         
         // For Due Fees
         let dueFeesData = [];
         
         /******************************************
         * 1) HELPER FUNCTIONS
         ******************************************/
         function hideAllSections() {
         document.getElementById('slipFormSection').classList.add('hidden');
         document.getElementById('oldFeesSection').classList.add('hidden');
         document.getElementById('analyticsSection').classList.add('hidden');
         document.getElementById('manageStudentSection').classList.add('hidden');
         document.getElementById('classMonthDashboard').classList.add('hidden');
         document.getElementById('dueFeesSection').classList.add('hidden');
         document.getElementById('separateReceipt').classList.add('hidden');
         document.getElementById('ifId').classList.add('hidden');
         document.getElementById('admissionFormSection').classList.add('hidden');
         }
         function updateGeneratedTime() {
         const now = new Date();
         document.getElementById('generatedTime').innerText = now.toLocaleString();
         }

         
         
         // Convert any table to CSV / Copy / PDF
         function copyTable(containerId) {
         const container = document.getElementById(containerId);
         const table = container.querySelector('table');
         if (!table) return;
         let range = document.createRange();
         range.selectNode(table);
         window.getSelection().removeAllRanges();
         window.getSelection().addRange(range);
         try {
         document.execCommand('copy');
         Swal.fire({ icon: 'success', title: 'Copied', text: 'Table copied to clipboard.', timer: 1500, showConfirmButton: false });
         } catch (err) {
         console.log(err);
         }
         window.getSelection().removeAllRanges();
         }
         
         function exportCSV(containerId, filename) {
         const container = document.getElementById(containerId);
         const table = container.querySelector('table');
         if (!table) return;
         let csv = [];
         const rows = table.querySelectorAll('tr');
         rows.forEach(row => {
         const cols = row.querySelectorAll('td, th');
         let rowData = [];
         cols.forEach(col => {
           // Escape quotes
           rowData.push('"'+(col.innerText.replace(/"/g, '""'))+'"');
         });
         csv.push(rowData.join(","));
         });
         const csvString = csv.join("\n");
         const blob = new Blob([csvString], { type: 'text/csv' });
         const url = URL.createObjectURL(blob);
         const a = document.createElement('a');
         a.setAttribute('hidden', '');
         a.setAttribute('href', url);
         a.setAttribute('download', filename);
         document.body.appendChild(a);
         a.click();
         document.body.removeChild(a);
         }
         
         function exportTablePDF(containerId, title) {
         const container = document.getElementById(containerId);
         const table = container.querySelector('table');
         if (!table) return;
         const tempDiv = document.createElement('div');
         tempDiv.innerHTML = `<h2 style="text-align:center;font-size:20px;margin-bottom:10px;">${title}</h2>` + table.outerHTML;
         const opt = {
         margin: 0.5,
         filename: title + '.pdf',
         image: { type: 'jpeg', quality: 0.98 },
         html2canvas: { scale: 2 },
         jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
         };
         html2pdf().set(opt).from(tempDiv).save();
         }
         
         /******************************************
         * 2) LOGIN / LOGOUT
         ******************************************/
         document.getElementById('loginForm').addEventListener('submit', function(e) {
         e.preventDefault();
         const loginData = {
         username: document.getElementById('loginUsername').value.trim(),
         password: document.getElementById('loginPassword').value.trim()
         };
         google.script.run.withSuccessHandler(function(resp) {
         if (resp.success) {
           Swal.fire({ icon: 'success', title: 'Login Successful', text: 'Welcome, ' + resp.userName, timer: 1500, showConfirmButton: false });
           document.getElementById('loginSection').classList.add('hidden');
           document.getElementById('appSection').classList.remove('hidden');
           document.getElementById('userName').value = resp.userName;
           document.getElementById('userRole').value = resp.role;
           document.getElementById('userRoleDisplay').textContent = resp.role;
         
           // Admin UI if role=admin
           if (resp.role === 'admin') {
             document.getElementById('manageStudentsBtn').classList.remove('hidden');
             document.getElementById('analyticsBtn').classList.remove('hidden');
             document.getElementById('classMonthDashboardBtn').classList.remove('hidden');
             document.getElementById('dueFeesBtn').classList.remove('hidden');
           }
         
           // load dropdown data
           google.script.run.withSuccessHandler(function(dd) {
             if (dd.error) {
               console.log("Dropdown error", dd.error);
               return;
             }
             dropdownData = dd;
             fillDropdowns();
           }).getDropdownData();
         
         } else {
           Swal.fire({ icon: 'error', title: 'Login Failed', text: resp.error });
         }
         }).loginUser(loginData);
         });
         
         function logout() {
         document.getElementById('appSection').classList.add('hidden');
         document.getElementById('loginSection').classList.remove('hidden');
         document.getElementById('loginUsername').value = "";
         document.getElementById('loginPassword').value = "";
         Swal.fire({ icon: 'info', title: 'Logged Out', text: 'You have been logged out.', timer: 1500, showConfirmButton: false });
         }
         
         /******************************************
         * 3) SLIP FORM: SUBMIT / UPDATE
         ******************************************/
         document.getElementById('receiptForm').addEventListener('submit', function(e) {
         e.preventDefault();
         submitFeeData();
         });
         
         function submitFeeData() {
         const formData = collectFormData();
         google.script.run.withSuccessHandler(function(resp) {
         if (resp.includes("Error")) {
           Swal.fire({ icon: 'error', title: 'Error', text: resp });
         } else {
           Swal.fire({ icon: 'success', title: 'Saved', text: resp, timer: 1500, showConfirmButton: false });
           document.getElementById('receiptForm').reset();
           document.getElementById('monthField').value = "";
           document.getElementById('recordRowNumber').value = "";
           document.getElementById('btnUpdateData').classList.add('hidden');
           document.getElementById('btnSubmitNew').classList.remove('hidden');
           updateGeneratedTime();
           showReceipt(formData); // Show receipt after successful submission
         }
         }).submitData(formData);
         }
         
         function updateFeeData() {
         const userRole = document.getElementById('userRole').value;
         const formData = collectFormData();
         google.script.run.withSuccessHandler(function(resp) {
         if (resp.includes("Error")) {
           Swal.fire({ icon: 'error', title: 'Update Error', text: resp });
         } else {
           Swal.fire({ icon: 'success', title: 'Updated', text: resp, timer: 1500, showConfirmButton: false });
           document.getElementById('receiptForm').reset();
           document.getElementById('monthField').value = "";
           document.getElementById('recordRowNumber').value = "";
           document.getElementById('btnUpdateData').classList.add('hidden');
           document.getElementById('btnSubmitNew').classList.remove('hidden');
           updateGeneratedTime();
           showReceipt(formData); // Show receipt after successful update
         }
         }).updateData(formData, userRole);
         }
         
          

 
          
         function collectFormData() {
         return {
         studentId: document.getElementById('studentId').value.trim(),
         date: document.getElementById('date').value.trim(),
         month: document.getElementById('monthField').value.trim(),
         session: document.getElementById('session').value.trim(),
         transactionId: document.getElementById('transactionId').value.trim(),
         trade: document.getElementById('trade').value.trim(),
         studentName: document.getElementById('studentName').value.trim(),
         fatherName: document.getElementById('fatherName').value.trim(),
         paidAmount: document.getElementById('paidAmount').value.trim(),
         paidAmountInWord: document.getElementById('paidAmountInWord').value.trim(),
         feesType: document.getElementById('feesType').value.trim(),
         paymentMode: document.getElementById('paymentMode').value.trim(),
         remark: document.getElementById('remark').value.trim(),
         userName: document.getElementById('userName').value.trim(),
         recordRowNumber: document.getElementById('recordRowNumber').value.trim()
         };
         }
         
         // Convert amount => words
         function numberToWords(num) {
         if (num === 0) return "zero";
         const a = ["","one","two","three","four","five","six","seven","eight","nine","ten","eleven",
                  "twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"];
         const b = ["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"];
         const g = ["","thousand","million","billion"];
         function grp(n) {
         let str = "";
         if (n > 99) {
           str += a[Math.floor(n / 100)] + " hundred ";
           n = n % 100;
         }
         if (n > 0) {
           if (n < 20) str += a[n]+" ";
           else str += b[Math.floor(n / 10)]+" "+a[n % 10]+" ";
         }
         return str;
         }
         let result = "";
         let j = 0;
         while (num > 0) {
         let n = num % 1000;
         if (n !== 0) result = grp(n)+g[j]+" "+result;
         num = Math.floor(num/1000);
         j++;
         }
         return result.trim();
         }
         function convertAmountToWords() {
         const val = document.getElementById('paidAmount').value.trim();
         if (!val) {
         document.getElementById('paidAmountInWord').value = "";
         return;
         }
         const num = parseFloat(val);
         if (isNaN(num)) {
         document.getElementById('paidAmountInWord').value = "Invalid amount";
         return;
         }
         document.getElementById('paidAmountInWord').value = numberToWords(Math.floor(num));
         }
         function updateMonthField() {
         const dVal = document.getElementById('date').value;
         if (dVal) {
         const dObj = new Date(dVal);
         const shortM = dObj.toLocaleString("en-US", { month: "short" });
         document.getElementById('monthField').value = shortM;
         } else {
         document.getElementById('monthField').value = "";
         }
         }
         
         /******************************************
         * 4) SEARCHING STUDENT & OLD FEES
         ******************************************/
         function searchBySideBar() {
         const sid = document.getElementById('sideBarSearchId').value.trim();
         if (!sid) {
         Swal.fire({ icon: 'info', title: 'Enter Student ID', text: 'Please type a Student ID' });
         return;
         }
         fetchStudentSession(sid);
         }
         function fetchStudentSession(studentId) {
         google.script.run.withSuccessHandler(function(resp) {
         if (resp.error) {
           Swal.fire({ icon: 'error', title: 'Error', text: resp.error });
         } else {
           document.getElementById('studentId').value = studentId;
           document.getElementById('session').value = resp.session;
           document.getElementById('studentName').value = resp.studentName;
           document.getElementById('fatherName').value = resp.fatherName;
           document.getElementById('trade').value = resp.trade;
         
           // auto date => today
           const today = new Date();
           const yyyy = today.getFullYear();
           const mm = String(today.getMonth()+1).padStart(2,'0');
           const dd = String(today.getDate()).padStart(2,'0');
           document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;
           updateMonthField();
         
           document.getElementById('recordRowNumber').value = "";
           document.getElementById('btnUpdateData').classList.add('hidden');
           document.getElementById('btnSubmitNew').classList.remove('hidden');
           updateGeneratedTime();
           Swal.fire({ icon: 'success', title: 'Student Loaded', timer: 1000, showConfirmButton: false });
         }
         }).getStudentSession(studentId);
         }
         function searchOldFees() {
         const sid = prompt("Enter Student ID for Old Fees:");
         if (!sid) return;
         google.script.run.withSuccessHandler(function(resp) {
         if (resp.error) {
           Swal.fire({ icon: 'error', title: 'Error', text: resp.error });
         } else {
           let tbl = "";
           if (!resp.length) {
             tbl = `<tr><td colspan='5' class='px-4 py-2 text-center'>No old fee records found.</td></tr>`;
           } else {
             resp.forEach(r => {
               tbl += `<tr>
                 <td class='px-4 py-2'>${r.date}</td>
                 <td class='px-4 py-2'>${r.month}</td>
                 <td class='px-4 py-2'>${r.paidAmount}</td>
                 <td class='px-4 py-2'>${r.transactionId}</td>
                 <td class='px-4 py-2'><button class='bg-blue-500 text-white px-2 py-1 rounded' onclick='viewRecord(${r.row})'>Get</button></td>
               </tr>`;
             });
           }
           document.getElementById('oldFeesTable').innerHTML = tbl;
           hideAllSections();
           document.getElementById('oldFeesSection').classList.remove('hidden');
         }
         }).getOldFees(sid);
         }
         // "View Old Slips" from Slip form
         function searchOldFeesFromSlip() {
         const sid = document.getElementById('studentId').value.trim();
         if (!sid) {
         Swal.fire({ icon: 'warning', title: 'Enter Student ID', text: 'Please type a Student ID first.' });
         return;
         }
         google.script.run.withSuccessHandler(function(resp) {
         if (resp.error) {
           Swal.fire({ icon: 'error', title: 'Error', text: resp.error });
         } else {
           let tbl = "";
           if (!resp.length) {
             tbl = `<tr><td colspan='5' class='px-4 py-2 text-center'>No old fee records found.</td></tr>`;
           } else {
             resp.forEach(r => {
               tbl += `<tr>
                 <td class='px-4 py-2'>${r.date}</td>
                 <td class='px-4 py-2'>${r.month}</td>
                 <td class='px-4 py-2'>${r.paidAmount}</td>
                 <td class='px-4 py-2'>${r.transactionId}</td>
                 <td class='px-4 py-2'><button class='bg-blue-500 text-white px-2 py-1 rounded' onclick='viewRecord(${r.row})'>Get</button></td>
               </tr>`;
             });
           }
           document.getElementById('oldFeesTable').innerHTML = tbl;
           hideAllSections();
           document.getElementById('oldFeesSection').classList.remove('hidden');
         }
         }).getOldFees(sid);
         }
         function backToSlipForm() {
         hideAllSections();
         document.getElementById('slipFormSection').classList.remove('hidden');
         }
         function viewRecord(rowNumber) {
         google.script.run.withSuccessHandler(function(resp) {
         if (resp.error) {
           Swal.fire({ icon: 'error', title: 'Error', text: resp.error });
         } else {
           const vals = resp.values;
           document.getElementById('studentId').value = vals[0] || "";
           document.getElementById('date').value = vals[1] || "";
           document.getElementById('monthField').value = vals[2] || "";
           document.getElementById('session').value = vals[3] || "";
           document.getElementById('transactionId').value = vals[4] || "";
           document.getElementById('trade').value = vals[5] || "";
           document.getElementById('studentName').value = vals[6] || "";
           document.getElementById('fatherName').value = vals[7] || "";
           document.getElementById('paidAmount').value = vals[8] || "";
           document.getElementById('paidAmountInWord').value = vals[9] || "";
           document.getElementById('feesType').value = vals[10] || "";
           document.getElementById('paymentMode').value = vals[11] || "";
           document.getElementById('remark').value = vals[12] || "";
           document.getElementById('userName').value = vals[13] || "";
           document.getElementById('recordRowNumber').value = rowNumber;
         
           const role = document.getElementById('userRole').value;
           if (role === 'admin') {
             document.getElementById('btnUpdateData').classList.remove('hidden');
             document.getElementById('btnSubmitNew').classList.add('hidden');
           } else {
             document.getElementById('btnUpdateData').classList.add('hidden');
             document.getElementById('btnSubmitNew').classList.remove('hidden');
           }
           backToSlipForm();
         }
         }).getRecord(rowNumber);
         }
         
         /******************************************
         * 5) PDF DOWNLOAD
         ******************************************/
         function downloadPDF() {
         const element = document.getElementById("slipFormSection");
         const opt = {
         margin: 0.5,
         filename: 'FeeSlip.pdf',
         image: { type: 'jpeg', quality: 0.98 },
         html2canvas: { scale: 2 },
         jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
         };
         html2pdf().set(opt).from(element).save().then(() => {
         Swal.fire({ icon: 'success', title: 'PDF Downloaded', text: 'Fee slip PDF downloaded.', timer: 1500, showConfirmButton: false });
         });
         }
         
         /******************************************
         * 6) ANALYTICS
         ******************************************/
         function toggleAnalytics() {
         hideAllSections();
         document.getElementById('analyticsSection').classList.remove('hidden');
         loadAnalytics();
         }
         function backToSlipFromAnalytics() {
         hideAllSections();
         document.getElementById('slipFormSection').classList.remove('hidden');
         }
         function clearAnalyticsFilter() {
         document.getElementById('analyticsDateFrom').value = "";
         document.getElementById('analyticsDateTo').value = "";
         document.getElementById('analyticsMonthFilter').value = "";
         document.getElementById('analyticsFeesTypeFilter').value = "";
         document.getElementById('analyticsPaymentModeFilter').value = "";
         loadAnalytics();
         }
         function loadAnalytics() {
         const userRole = document.getElementById('userRole').value;
         const monthFilter = document.getElementById('analyticsMonthFilter').value.trim();
         const feesTypeFilter = document.getElementById('analyticsFeesTypeFilter').value.trim();
         const paymentModeFilter = document.getElementById('analyticsPaymentModeFilter').value.trim();
         const dateFrom = document.getElementById('analyticsDateFrom').value.trim();
         const dateTo = document.getElementById('analyticsDateTo').value.trim();
         
         google.script.run.withSuccessHandler(function(an) {
         if (an.error) {
           Swal.fire({ icon: 'error', title: 'Analytics Error', text: an.error });
           return;
         }
         
         document.getElementById('cardTotalPaid').textContent = an.totalPaidFees.toFixed(2);
         document.getElementById('cardTotalUnpaid').textContent = an.totalUnpaidFees.toFixed(2);
         document.getElementById('cardTotalStudents').textContent = an.totalStudents;
         document.getElementById('cardPaidStudents').textContent = an.paidStudentsCount;
         document.getElementById('cardUnpaidStudents').textContent = an.unpaidStudentsCount;
         
         const dateLabels = Object.keys(an.dateWisePaid).sort();
         const dateVals = dateLabels.map(d => an.dateWisePaid[d]);
         
         // Bar Chart
         if (dateWiseChartRef) dateWiseChartRef.destroy();
         const ctxBar = document.getElementById('dateWiseChart').getContext('2d');
         dateWiseChartRef = new Chart(ctxBar, {
           type: 'bar',
           data: {
             labels: dateLabels,
             datasets: [{
               label: 'Fees Paid',
               data: dateVals,
               backgroundColor: 'rgba(54, 162, 235, 0.6)',
               borderColor: 'rgba(54, 162, 235, 1)',
               borderWidth: 1
             }]
           },
           options: { responsive: true, scales: { y: { beginAtZero: true } } }
         });
         
         // Line Chart
         const lineLabels = Object.keys(an.lineData).sort();
         const lineVals = lineLabels.map(d => an.lineData[d]);
         if (lineChartRef) lineChartRef.destroy();
         const ctxLine = document.getElementById('lineChart').getContext('2d');
         lineChartRef = new Chart(ctxLine, {
           type: 'line',
           data: {
             labels: lineLabels,
             datasets: [{
               label: 'Fees Trend',
               data: lineVals,
               fill: false,
               borderColor: 'rgba(255,99,132,1)',
               tension: 0.1
             }]
           },
           options: { responsive: true }
         });
         
         // Pie Chart
         if (pieChartRef) pieChartRef.destroy();
         const ctxPie = document.getElementById('pieChart').getContext('2d');
         pieChartRef = new Chart(ctxPie, {
           type: 'pie',
           data: {
             labels: ['Paid', 'Unpaid'],
             datasets: [{
               data: [an.pieData.paid, an.pieData.unpaid],
               backgroundColor: ['#4CAF50','#FF9800']
             }]
           },
           options: { responsive: true }
         });
         
         }).getAnalyticsData(monthFilter, feesTypeFilter, paymentModeFilter, dateFrom, dateTo, userRole);
         }
         
         /******************************************
         * 7) MANAGE STUDENTS
         ******************************************/
         function toggleManageStudents() {
         hideAllSections();
         document.getElementById('manageStudentSection').classList.remove('hidden');
         loadStudentList();
         }
         function loadStudentList() {
         google.script.run.withSuccessHandler(function(studs) {
         if (studs.error) {
           Swal.fire({ icon: 'error', title: 'Error', text: studs.error });
           return;
         }
         let h = `<table class='min-w-full'>
           <thead class='bg-gray-50'>
             <tr>
               <th class='px-4 py-2 text-left'>Student ID</th>
               <th class='px-4 py-2 text-left'>Session</th>
               <th class='px-4 py-2 text-left'>Name</th>
               <th class='px-4 py-2 text-left'>Course</th>
               <th class='px-4 py-2 text-left'>Class</th>
               <th class='px-4 py-2 text-left'>Total Fees</th>
               <th class='px-4 py-2 text-left'>Actions</th>
             </tr>
           </thead><tbody>`;
         studs.forEach(s => {
           h += `<tr class='border-b'>
             <td class='px-4 py-2'>${s.studentId}</td>
             <td class='px-4 py-2'>${s.session}</td>
             <td class='px-4 py-2'>${s.studentName}</td>
             <td class='px-4 py-2'>${s.trade}</td>
             <td class='px-4 py-2'>${s.className}</td>
             <td class='px-4 py-2'>${s.totalFees}</td>
             <td class='px-4 py-2'>
               <button class='bg-blue-500 text-white px-2 py-1 rounded mr-2' onclick='editStudent(${JSON.stringify(s)})'>Edit</button>
               <button class='bg-red-500 text-white px-2 py-1 rounded' onclick='deleteStudent(${s.row})'>Delete</button>
             </td>
           </tr>`;
         });
         h += "</tbody></table>";
         document.getElementById('studentTableContainer').innerHTML = h;
         }).getStudentList();
         }
         function openStudentModal(mode, stud) {
         document.getElementById('studentModal').classList.remove('hidden');
         if (mode === 'add') {
         document.getElementById('studentModalTitle').innerText = "Add Student";
         document.getElementById('studentModalBtn').innerText = "Add Student";
         document.getElementById('studentForm').reset();
         document.getElementById('studentRow').value = "";
         } else if (mode === 'edit') {
         document.getElementById('studentModalTitle').innerText = "Edit Student";
         document.getElementById('studentModalBtn').innerText = "Update Student";
         document.getElementById('studentRow').value = stud.row;
         document.getElementById('studentIdNew').value = stud.studentId;
         document.getElementById('sessionNew').value = stud.session;
         document.getElementById('tradeNew').value = stud.trade;
         document.getElementById('studentNameNew').value = stud.studentName;
         document.getElementById('fatherNameNew').value = stud.fatherName;
         document.getElementById('instituteNameNew').value = stud.instituteName;
         document.getElementById('classNameNew').value = stud.className;
         document.getElementById('totalFeesNew').value = stud.totalFees;
         }
         }
         function closeStudentModal() {
         document.getElementById('studentModal').classList.add('hidden');
         }
         document.getElementById('studentForm').addEventListener('submit', function(e) {
         e.preventDefault();
         const userRole = document.getElementById('userRole').value;
         const sData = {
         studentId: document.getElementById('studentIdNew').value.trim(),
         session: document.getElementById('sessionNew').value.trim(),
         trade: document.getElementById('tradeNew').value.trim(),
         studentName: document.getElementById('studentNameNew').value.trim(),
         fatherName: document.getElementById('fatherNameNew').value.trim(),
         instituteName: document.getElementById('instituteNameNew').value.trim(),
         className: document.getElementById('classNameNew').value.trim(),
         totalFees: document.getElementById('totalFeesNew').value.trim()
         };
         const row = document.getElementById('studentRow').value.trim();
         
         if (row) {
         // update
         sData.row = row;
         google.script.run.withSuccessHandler(function(resp) {
           if (resp.includes("Error")) {
             Swal.fire({ icon: 'error', title: 'Update Error', text: resp });
           } else {
             Swal.fire({ icon: 'success', title: 'Updated', text: resp, timer: 1500, showConfirmButton: false });
             closeStudentModal();
             loadStudentList();
           }
         }).updateStudentData(sData, userRole);
         } else {
         // add
         google.script.run.withSuccessHandler(function(resp) {
           if (resp.includes("Error")) {
             Swal.fire({ icon: 'error', title: 'Add Error', text: resp });
           } else {
             Swal.fire({ icon: 'success', title: 'Student Added', text: resp, timer: 1500, showConfirmButton: false });
             closeStudentModal();
             loadStudentList();
           }
         }).addStudentData(sData, userRole);
         }
         });
         function editStudent(stud) {
         openStudentModal('edit', stud);
         }
         function deleteStudent(rowNumber) {
         const ur = document.getElementById('userRole').value;
         Swal.fire({
         icon: 'warning',
         title: 'Are you sure?',
         text: 'This will delete the student record.',
         showCancelButton: true,
         confirmButtonText: 'Yes, delete'
         }).then(result => {
         if (result.isConfirmed) {
           google.script.run.withSuccessHandler(function(resp) {
             if (resp.includes("Error")) {
               Swal.fire({ icon: 'error', title: 'Delete Error', text: resp });
             } else {
               Swal.fire({ icon: 'success', title: 'Deleted', text: resp, timer: 1500, showConfirmButton: false });
               loadStudentList();
             }
           }).deleteStudentData(rowNumber, ur);
         }
         });
         }
         function filterStudentList() {
         const input = document.getElementById('studentSearchInput').value.toLowerCase();
         const table = document.getElementById('studentTableContainer').getElementsByTagName('table')[0];
         if (!table) return;
         const tr = table.getElementsByTagName('tr');
         for (let i = 1; i < tr.length; i++) {
         const rowTxt = tr[i].textContent.toLowerCase();
         tr[i].style.display = rowTxt.indexOf(input) > -1 ? "" : "none";
         }
         }
         
         /******************************************
         * 8) CLASS & MONTH DASHBOARD
         ******************************************/
         function toggleClassMonthDashboard() {
         hideAllSections();
         document.getElementById('classMonthDashboard').classList.remove('hidden');
         loadClassList();
         }
         function backToSlipFromClassDashboard() {
         hideAllSections();
         document.getElementById('slipFormSection').classList.remove('hidden');
         }
         function loadClassList() {
         google.script.run.withSuccessHandler(function(cls) {
         const sel = document.getElementById('selectClass');
         sel.innerHTML = `<option value="">All Classes</option>`;
         if (cls.error) {
           console.log(cls.error);
           return;
         }
         cls.forEach(c => {
           const opt = document.createElement('option');
           opt.value = c;
           opt.textContent = c;
           sel.appendChild(opt);
         });
         }).getClassList();
         }
         function loadClassMonthDashboard() {
         const sc = document.getElementById('selectClass').value;
         const sm = document.getElementById('selectMonth').value;
         const ur = document.getElementById('userRole').value;
         google.script.run.withSuccessHandler(function(res) {
         if (res.error) {
           Swal.fire({ icon: 'error', title: 'Error', text: res.error });
           return;
         }
         // line chart
         if (classMonthLineChartRef) classMonthLineChartRef.destroy();
         const ctx = document.getElementById('classMonthLineChart').getContext('2d');
         const dLabels = Object.keys(res.lineData);
         const dVals = dLabels.map(d => res.lineData[d]);
         classMonthLineChartRef = new Chart(ctx, {
           type: 'line',
           data: {
             labels: dLabels,
             datasets: [{
               label: 'Fees Paid',
               data: dVals,
               borderColor: 'rgba(75,192,192,1)',
               fill: false,
               tension: 0.1
             }]
           },
           options: { responsive: true, scales: { y: { beginAtZero: true } } }
         });
         
         // store data to do client-side filtering
         classMonthData = res.students;
         
         // build table
         const tb = document.getElementById('classMonthStudentTable');
         tb.innerHTML = "";
         res.students.forEach(s => {
           const paidTxt = s.hasPaid ? 'Yes' : 'No';
           tb.innerHTML += `<tr>
             <td class='px-4 py-2'>${s.studentId}</td>
             <td class='px-4 py-2'>${s.studentName}</td>
             <td class='px-4 py-2'>${paidTxt}</td>
           </tr>`;
         });
         
         updateClassMonthPieChart();
         filterClassMonthTable(); // apply filters immediately
         }).getClassMonthDashboard(sc, sm, ur);
         }
         // Filter paid/unpaid + student search client-side
         function filterClassMonthTable() {
         const selectPaid = document.getElementById('selectPaidStatus').value;
         const searchVal = document.getElementById('classMonthSearchInput').value.toLowerCase();
         const rows = document.getElementById('classMonthStudentTable').getElementsByTagName('tr');
         for (let i=0; i<rows.length; i++){
         let cols = rows[i].getElementsByTagName('td');
         if (cols.length<3) continue;
         let studentId = cols[0].textContent.toLowerCase();
         let studentName = cols[1].textContent.toLowerCase();
         let paidCol = cols[2].textContent.toLowerCase(); // "yes" or "no"
         
         // check search
         if (studentId.indexOf(searchVal)===-1 && studentName.indexOf(searchVal)===-1){
           rows[i].style.display='none';
           continue;
         }
         // check paid status
         if (selectPaid==='paid' && paidCol!=='yes'){
           rows[i].style.display='none';
         } else if (selectPaid==='unpaid' && paidCol!=='no') {
           rows[i].style.display='none';
         } else {
           rows[i].style.display='';
         }
         }
         updateClassMonthPieChart();
         }
         
         function updateClassMonthPieChart() {
         // count paid vs. unpaid in classMonthData (but also consider search filter if we want)
         // For simplicity, we recalc from the array because it's easy:
         let paidCount=0, unpaidCount=0;
         
         // We'll also check what is currently visible in the table:
         const rows = document.getElementById('classMonthStudentTable').getElementsByTagName('tr');
         for (let i=0; i<rows.length; i++){
         if (rows[i].style.display==='none') continue; // skip hidden
         let cols = rows[i].getElementsByTagName('td');
         if (cols.length<3) continue;
         let paidCol = cols[2].textContent.toLowerCase();
         if (paidCol==='yes') paidCount++;
         else unpaidCount++;
         }
         
         if (classMonthPieChartRef) classMonthPieChartRef.destroy();
         const ctxPie = document.getElementById('classMonthPieChart').getContext('2d');
         classMonthPieChartRef = new Chart(ctxPie, {
         type: 'pie',
         data: {
           labels: ['Paid','Unpaid'],
           datasets: [{
             data: [paidCount, unpaidCount],
             backgroundColor: ['#4CAF50','#FF9800']
           }]
         },
         options:{ responsive:true }
         });
         }
         
         /******************************************
         * 9) DUE FEES
         ******************************************/
         function toggleDueFees() {
         hideAllSections();
         document.getElementById('dueFeesSection').classList.remove('hidden');
         // Load class list for filter
         google.script.run.withSuccessHandler(function(cls){
         const sel = document.getElementById('dueFeesClassSelect');
         sel.innerHTML = `<option value="">All Classes</option>`;
         if (cls.error) {
           console.log(cls.error);
         } else {
           cls.forEach(c => {
             const opt = document.createElement('option');
             opt.value = c;
             opt.textContent = c;
             sel.appendChild(opt);
           });
         }
         }).getClassList();
         loadDueFees();
         }
         function closeDueFees() {
         hideAllSections();
         document.getElementById('slipFormSection').classList.remove('hidden');
         }
         function loadDueFees() {
         const userRole = document.getElementById('userRole').value;
         google.script.run.withSuccessHandler(function(res){
         if (res.error) {
           Swal.fire({ icon:'error', title:'Due Fees Error', text: res.error });
           return;
         }
         document.getElementById('dueTotalFees').textContent = res.summary.totalFees;
         document.getElementById('dueTotalPaid').textContent = res.summary.totalPaid;
         document.getElementById('dueTotalDue').textContent = res.summary.totalDue;
         document.getElementById('dueFullyPaidCount').textContent = res.summary.fullyPaidCount;
         
         dueFeesData = res.data; // store globally
         renderDueFeesTable(dueFeesData);
         }).getDueFeesData(userRole);
         }
         function renderDueFeesTable(dataArray) {
         let h = `<table class='min-w-full'>
         <thead class='bg-gray-50'>
           <tr>
             <th class='px-4 py-2 text-left'>Student ID</th>
             <th class='px-4 py-2 text-left'>Name</th>
             <th class='px-4 py-2 text-left'>Class</th>
             <th class='px-4 py-2 text-left'>Total Fees</th>
             <th class='px-4 py-2 text-left'>Paid</th>
             <th class='px-4 py-2 text-left'>Due</th>
           </tr>
         </thead><tbody>`;
         dataArray.forEach(d=>{
         h += `<tr class='border-b'>
           <td class='px-4 py-2'>${d.studentId}</td>
           <td class='px-4 py-2'>${d.studentName}</td>
           <td class='px-4 py-2'>${d.className}</td>
           <td class='px-4 py-2'>${d.totalFees}</td>
           <td class='px-4 py-2'>${d.sumPaid}</td>
           <td class='px-4 py-2 text-red-600'>${d.dueFees}</td>
         </tr>`;
         });
         h += "</tbody></table>";
         document.getElementById('dueFeesTableContainer').innerHTML = h;
         }
         function filterDueFees() {
         const inputVal = document.getElementById('dueFeesSearch').value.toLowerCase();
         const classVal = document.getElementById('dueFeesClassSelect').value.toLowerCase();
         
         const filtered = dueFeesData.filter(d => {
         // match search (across ID, name, fatherName, class, etc.)
         let rowText = (d.studentId + " " + d.studentName + " " + d.fatherName + " " + d.className).toLowerCase();
         if (rowText.indexOf(inputVal)===-1) return false;
         
         // match class filter
         if (classVal && d.className.toLowerCase() !== classVal) return false;
         
         return true;
         });
         renderDueFeesTable(filtered);
         }
         
         /******************************************
         * 10) RECEIPT PRINTING
         ******************************************/
         let lastReceiptData = null;
         
         function showReceipt(data) {
         try {
         // Store the data for later access
         lastReceiptData = data;
         
         // Fill receipt data
         document.getElementById('receiptNumber').textContent = data.transactionId || 'N/A';
         document.getElementById('receiptDate').textContent = data.date ? formatDate(data.date) : '________________';
         document.getElementById('receiptStudentName').textContent = data.studentName || 'Not Provided';
         document.getElementById('receiptCourse').textContent = data.trade || 'Not Specified';
         
         // Format currency
         const formatCurrency = (val) => val ? '₹' + parseFloat(val).toFixed(2) : '₹0.00';
         document.getElementById('receiptTotalAmount').textContent = formatCurrency(data.totalFees || 0);
         document.getElementById('receiptPaidAmount').textContent = formatCurrency(data.paidAmount || 0);
         
         // Calculate balance if not provided
         const balance = (data.totalFees || 0) - (data.paidAmount || 0);
         document.getElementById('receiptBalance').textContent = formatCurrency(balance);
         
         document.getElementById('receiptExamFees').textContent = data.examFees ? formatCurrency(data.examFees) : ' ';
         document.getElementById('receiptReceivedBy').textContent = data.userName || 'Administrator';
         
         // Show receipt
         hideAllSections();
         document.getElementById('separateReceipt').classList.remove('hidden');
         
         } catch (error) {
         console.error('Error showing receipt:', error);
         Swal.fire('Error', 'Could not generate receipt', 'error');
         backToSlipForm();
         }
         }
         
         function showLatestReceipt() {
         if (!lastReceiptData) {
         Swal.fire('Info', 'No recent receipt available. Please submit a payment first.', 'info');
         return;
         }
         showReceipt(lastReceiptData);
         }
         
         function printReceipt() {
         if (!lastReceiptData) {
         Swal.fire('Info', 'No receipt data available to print', 'info');
         return;
         }
         
         // Create a clone of the receipt to avoid affecting the original
         const receipt = document.getElementById('separateReceipt').cloneNode(true);
         receipt.classList.remove('hidden');
         receipt.style.display = 'block';
         
         // Create a temporary container for printing
         const printContainer = document.createElement('div');
         printContainer.appendChild(receipt);
         printContainer.style.position = 'absolute';
         printContainer.style.left = '-9999px';
         document.body.appendChild(printContainer);
         
         // Remove print button before printing
         const printBtn = printContainer.querySelector('button[onclick="printReceipt()"]');
         if (printBtn) printBtn.remove();
         
         // Trigger print
         window.print();
         
         // Clean up
         document.body.removeChild(printContainer);
         }
         
         function formatDate(dateString) {
         if (!dateString) return '';
         const date = new Date(dateString);
         return date.toLocaleDateString('en-US', { 
         year: 'numeric', 
         month: 'short', 
         day: 'numeric',
         hour: '2-digit',
         minute: '2-digit'
         });
         }
         
         /******************************************
         * 11) INITIALIZE
         ******************************************/
         updateGeneratedTime();
         
         // Fill dropdowns function
         function fillDropdowns() {
         // Slip form
         const sessionEl = document.getElementById('session');
         sessionEl.innerHTML = '<option value="">Select Session</option>';
         dropdownData.sessions.forEach(s=>{
         const opt = document.createElement('option');
         opt.value=s; opt.textContent=s;
         sessionEl.appendChild(opt);
         });
         const tradeEl = document.getElementById('trade');
         tradeEl.innerHTML='<option value="">Select Course</option>';
         dropdownData.trades.forEach(t=>{
         const opt=document.createElement('option');
         opt.value=t; opt.textContent=t;
         tradeEl.appendChild(opt);
         });
         const feesEl=document.getElementById('feesType');
         feesEl.innerHTML='<option value="">Select Branch </option>';
         dropdownData.feesTypes.forEach(f=>{
         const opt=document.createElement('option');
         opt.value=f; opt.textContent=f;
         feesEl.appendChild(opt);
         });
         const payEl=document.getElementById('paymentMode');
         payEl.innerHTML='<option value="">Select Payment Mode</option>';
         dropdownData.paymentModes.forEach(pm=>{
         const opt=document.createElement('option');
         opt.value=pm; opt.textContent=pm;
         payEl.appendChild(opt);
         });
         
         // Student form
         const sessNew=document.getElementById('sessionNew');
         sessNew.innerHTML='<option value="">Select Session</option>';
         dropdownData.sessions.forEach(s=>{
         const opt=document.createElement('option');
         opt.value=s; opt.textContent=s;
         sessNew.appendChild(opt);
         });
         const tradeNew=document.getElementById('tradeNew');
         tradeNew.innerHTML='<option value="">Select Course</option>';
         dropdownData.trades.forEach(t=>{
         const opt=document.createElement('option');
         opt.value=t; opt.textContent=t;
         tradeNew.appendChild(opt);
         });
         
         // analytics
         const aFees=document.getElementById('analyticsFeesTypeFilter');
         aFees.innerHTML='<option value="">Branch </option>';
         dropdownData.feesTypes.forEach(f=>{
         const opt=document.createElement('option');
         opt.value=f; opt.textContent=f;
         aFees.appendChild(opt);
         });
         const aPay=document.getElementById('analyticsPaymentModeFilter');
         aPay.innerHTML='<option value="">All Payment Modes</option>';
         dropdownData.paymentModes.forEach(pm=>{
         const opt=document.createElement('option');
         opt.value=pm; opt.textContent=pm;
         aPay.appendChild(opt);
         });
         }
         // Show Slip by default on login
         function openSlip(){
         hideAllSections();
         document.getElementById('slipFormSection').classList.remove('hidden');
         }
           function calculateMonthlyFees() {
           // Get the value of admission fees
           const admissionFees = parseFloat(document.getElementById('admission_fees').value) || 0;
         
          // Calculate monthly fees as admission / 12
          const monthlyFees = admissionFees / 12;
         
          document.getElementById('total').value = admissionFees;
         
          // Update the monthly fees input field
          document.getElementById('monthly_fees').value = monthlyFees.toFixed(2); // Format to two decimal places
         }
         function saveDataToSheet() {
         // Collect values from input fields
         const data = [
           document.getElementById("jan_25").value,
           document.getElementById("feb_25").value,
           document.getElementById("mar_25").value,
           document.getElementById("apr_25").value,
           document.getElementById("may_25").value,
           document.getElementById("jun_25").value,
           document.getElementById("jul_25").value,
           document.getElementById("aug_25").value,
           document.getElementById("sep_25").value,
           document.getElementById("oct_25").value,
           document.getElementById("nov_25").value,
           document.getElementById("dec_25").value
         ];
         // Call Apps Script function to save data
         google.script.run.saveData(data);
         alert('Data saved successfully!');
         }
         
              function openInquiryForm() {

                const userRole = document.getElementById('userRole').value;
                
                console.log("Inquiry Form button clicked");
                hideAllSections(); 
                document.getElementById('ifId').classList.remove('hidden');

                const branchInput = document.getElementById("branch22");

                if (userRole === 'admin') {
                  branchInput.value = "Kurla";
                } else if (userRole === 'user') {
                  branchInput.value = "Thane";
                } else {
                  branchInput.value = "Unknown";
                }
              }



         
         const { jsPDF } = window.jspdf;
         
         // Show admission form
         function openAdmissionForm() {
         console.log("Admission Form button clicked");
         hideAllSections();
         const section = document.getElementById('admissionFormSection');
         if (section) section.classList.remove('hidden');
         else console.error("Admission form section not found!");
         }
        
         
         // Handle admission form submission
         document.addEventListener('DOMContentLoaded', function () {
         const admissionBtn = document.getElementById('admissionBtn');
         if (admissionBtn) {
         admissionBtn.addEventListener('click', openAdmissionForm);
         } else {
         console.error("Admission button not found!");
         }
         
         const form = document.getElementById('admissionForm');
         const submitBtn = document.getElementById('submitButton');
         
         if (submitBtn && form) {
         submitBtn.addEventListener('click', function (e) {
         e.preventDefault();
         
         const formData = new FormData(form);
         const data = {};
         formData.forEach((value, key) => {
           if (!data[key]) data[key] = [];
           data[key].push(value);
         });
         
         console.log("Submitting data:", data);
         google.script.run.withSuccessHandler(onSuccess).submitForm(data);
         });
         }
         });
         
         // Handle success
         function onSuccess() {
         alert('Form submitted successfully!');
         generatePDFAdmission();
         }
         
         // Generate PDF
         function generatePDFAdmission() {
         const element = document.getElementById('admissionFormSection'); // or 'slipFormSection' if needed
         const options = {
         scale: 3,
         useCORS: true,
         letterRendering: true,
         onclone: (clonedDoc) => {
         clonedDoc.querySelectorAll('input, select').forEach(el => {
           el.style.paddingTop = '2px';
           el.style.paddingBottom = '2px';
         });
         }
         };
         
         html2canvas(element, options).then(canvas => {
         const pdf = new jsPDF('p', 'mm', 'a4');
         const imgWidth = 210;
         const imgHeight = (canvas.height * imgWidth) / canvas.width;
         
         if (imgHeight > 297) {
         const pageHeight = 297;
         let position = 0;
         
         while (position < imgHeight) {
           pdf.addImage(canvas, 'PNG', 0, position === 0 ? 0 : -position, imgWidth, imgHeight);
           position += pageHeight;
           if (position < imgHeight) pdf.addPage();
         }
         } else {
         pdf.addImage(canvas, 'PNG', 0, 0, imgWidth, imgHeight);
         }
         
         const studentName = document.querySelector('input[name="student_name"]').value || 'Student';
         pdf.save(`${studentName}_AdmissionForm.pdf`);
         });
         
         
         
        // Initialize jsPDF
         const { jsPDF } = window.jspdf;
         
         // Data management variables
         let formData = [];
         let currentRecordIndex = 0;
         
         // DOM Ready Handler
         
         // Fetch data from Google Sheets
         function fetchData() {
         const detailsDiv = document.getElementById('details');
         detailsDiv.innerHTML = '<p class="text-center py-4">Loading data...</p>';
         
         if (typeof google === 'undefined' || !google.script.run) {
         showError({message: "Google Apps Script not available"});
         return;
         }
         
         google.script.run
         .withSuccessHandler(displayFetchedData)
         .withFailureHandler(showError)
         .getData();
         }
         
         function showError(error) {
         document.getElementById('details').innerHTML = `
         <p class="text-red-500 text-center py-4">
           Error: ${error.message || 'Failed to load data'}
         </p>`;
         }
         
         function displayFetchedData(fetchedData) {
         if (!fetchedData || fetchedData.length < 2) {
         document.getElementById('details').innerHTML = `
           <p class="text-center py-4">No data available</p>`;
         return;
         }
         
         formData = fetchedData;
         currentRecordIndex = 1; // Skip header row
         displayCurrentRecord();
         
         // Show the container if hidden
         document.getElementById('ifId').classList.add('hidden');
         document.getElementById('container').classList.remove('hidden');
         }
         
         function displayCurrentRecord() {
         const outputDiv = document.getElementById('output');
         const detailsDiv = document.getElementById('details');
         const emiDiv = document.getElementById('emiOutput');
         
         // Clear previous content
         outputDiv.innerHTML = '';
         detailsDiv.innerHTML = '';
         emiDiv.innerHTML = '';
         
         if (formData.length > 1 && currentRecordIndex < formData.length) {
         const record = formData[currentRecordIndex];
         const headers = formData[0];
         
         // Display basic details
         const detailFields = [
           {label: "Serial no", index: 0},
           {label: "Name", index: 1},
           {label: "Email", index: 2},
           {label: "Phone", index: 3},
           {label: "Address", index: 4}
         ];
         
         detailFields.forEach(field => {
           if (record[field.index] !== undefined) {
             const div = document.createElement('div');
             div.className = 'py-2 border-b border-gray-100';
             div.textContent = `${field.label}: ${record[field.index] || '-'}`;
             detailsDiv.appendChild(div);
           }
         });
         
         // Add payable information
         const payableDiv = document.createElement('div');
         payableDiv.className = 'py-3 mt-3 font-bold border-t border-gray-200';
         payableDiv.textContent = "Payable to: Shelar Training Institute";
         detailsDiv.appendChild(payableDiv);
         
         // Create main fees table (columns 5-8)
         createDataTable(outputDiv, headers.slice(5, 9), record.slice(5, 9));
         
         // Create EMI table if data exists (columns 9+)
         if (record.length > 9) {
           createDataTable(emiDiv, headers.slice(9), record.slice(9));
         }
         }
         
         // Update navigation buttons
         document.getElementById('prevButton').style.display = 
         currentRecordIndex <= 1 ? 'none' : 'block';
         document.getElementById('nextButton').style.display = 
         currentRecordIndex >= formData.length - 1 ? 'none' : 'block';
         }
         
         function createDataTable(container, headers, data) {
         const table = document.createElement('table');
         const headerRow = document.createElement('tr');
         
         headers.forEach(header => {
         const th = document.createElement('th');
         th.textContent = header;
         headerRow.appendChild(th);
         });
         table.appendChild(headerRow);
         
         const dataRow = document.createElement('tr');
         data.forEach(cell => {
         const td = document.createElement('td');
         td.textContent = cell || '-';
         dataRow.appendChild(td);
         });
         table.appendChild(dataRow);
         
         container.appendChild(table);
         }
         
         function nextPage() {
         if (currentRecordIndex < formData.length - 1) {
         currentRecordIndex++;
         displayCurrentRecord();
         }
         }
         
         function prevPage() {
         if (currentRecordIndex > 1) {
         currentRecordIndex--;
         displayCurrentRecord();
         }
        }
          


         // PDF Generation
         function generatePDFInquire() {
         const formElement = document.getElementById('ifId');
         const options = {
         scale: 2,
         useCORS: true,
         allowTaint: true,
         logging: true,
         letterRendering: true
         };
         
         html2canvas(formElement, options).then(canvas => {
         const pdf = new jsPDF('p', 'mm', 'a4');
         const imgData = canvas.toDataURL('image/png');
         const imgWidth = 190; // A4 width - margins
         const imgHeight = (canvas.height * imgWidth) / canvas.width;
         
         pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
         
         const studentName = document.getElementById('fullName').value || 'Student';
         pdf.save(`${studentName.replace(/\s+/g, '_')}_Inquiry_Form.pdf`);
         
         // Switch to invoice view
         document.getElementById('ifId').classList.add('hidden');
         document.getElementById('container').classList.remove('hidden');
         }).catch(err => {
         console.error('PDF generation error:', err);
         Swal.fire({
           icon: 'error',
           title: 'PDF Error',
           text: 'Failed to generate PDF',
           confirmButtonColor: '#1e3a8a',
         });
         });
         }
         }



document.addEventListener('DOMContentLoaded', function () {
  const inquiryForm = document.getElementById('ifId'); // Replace with your form's ID
  if (inquiryForm) {
    inquiryForm.addEventListener('submit', submitInquiryForm); // Handle form submission
  }
});

function submitInquiryForm(e) {

  
  e.preventDefault();
  console.log("Hello88 - Form submission started");


  // Validate terms checkbox
  const agreeCheckbox = document.getElementById('agree1');
  if (!agreeCheckbox?.checked) {
    console.log("Validation failed: Checkbox not checked");
    document.getElementById('agreeError1').textContent = 'Please agree to the terms';
    return; // Stops here if checkbox is unchecked
  } else {
    document.getElementById('agreeError1').textContent = '';
  }

  const submitBtn = document.getElementById('submitButton2');
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
  submitBtn.disabled = true;

  // Hardcoded test data (or collect from form)
const formValues = {
      date: document.getElementById('date')?.value || new Date().toISOString().split('T')[0],
      fullName: document.getElementById('fullName')?.value.trim() || '',
      qualification: document.getElementById('qualification')?.value.trim() || '',
      phoneNo: document.getElementById('phoneNo')?.value.trim() || '',
      whatsappNo: document.getElementById('whatsappNo')?.value.trim() || '',
      parentsNo: document.getElementById('parentsNo')?.value.trim() || '',
      email: document.getElementById('email')?.value.trim() || '',
      age: document.getElementById('age')?.value.trim() || '',
      address: document.getElementById('address')?.value.trim() || '',
      interestedCourse: document.getElementById('interestedCourse')?.value.trim() || '',
      inquiryTakenBy: document.getElementById('inquiryTakenBy')?.value.trim() || '',
      branch: document.getElementById('branch22')?.value.trim() || ''
    }

  console.log("Form Values:", formValues); // This MUST appear if execution reaches here

  // Send data to Google Apps Script
  google.script.run
    .withSuccessHandler((response) => {
      console.log("Server Response:", response); // Log response from Google Apps Script
      if (response.success) {
        Swal.fire({
          icon: 'success',
          title: 'Success!',
          text: response.message,
          confirmButtonColor: '#1e3a8a',
        }).then(() => {
          document.getElementById('ifId')?.reset();
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Validation Error',
          text: response.message,
          confirmButtonColor: '#1e3a8a',
        });
      }
      submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Submit';
      submitBtn.disabled = false;
    })
    .withFailureHandler((error) => {
      console.error("Script Error:", error); // Log full error
      Swal.fire({
        icon: 'error',
        title: 'Script Error',
        text: error.message || 'An unexpected error occurred.',
        confirmButtonColor: '#1e3a8a',
      });
      submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Submit';
      submitBtn.disabled = false;
    })
    .processForm(formValues);
}

      </script>
    </body>
  </html>