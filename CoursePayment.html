<div
  id="coursePaymentSection"
  class="bg-white rounded-xl shadow-xl overflow-hidden"
>
  <!-- <div class="header-bg text-white p-6 bg-blue-800">
    <div class="logo-container" style="width: 180px; height: auto; display: flex; justify-content: center; align-items: center;">
       <img 
      src="https://i.postimg.cc/FzvwbhS3/Untitled-1.png" 
       alt="Logo" 
     style="width: 100%; max-width: 160px; height: auto; padding: 5px;"
       />
    </div>
    <!-- <h1 class="text-2xl font-bold">STI SHELAR TRAINING INSTITUTE</h1>
    <p class="opacity-90">C/34, Bunglow, Near
                  Nandikeshwar Mandir, Kamgar Nagar, Kurla(E)
    </p> -->
    <!-- <div class="text-center md:text-right">
              <p class="text-yellow-300 font-medium text-lg"> <i class="fas fa-file-alt mr-1"></i> COURSE PAYMENT
              </p>
                            </div>
  </div> -->
  <div class="header-bg text-white p-6 bg-blue-800 flex flex-col md:flex-row justify-between items-center">
  <div class="logo-container" style="width: 180px; height: auto; display: flex; justify-content: center; align-items: center;">
     <img 
      src="https://i.postimg.cc/FzvwbhS3/Untitled-1.png" 
      alt="Logo" 
      style="width: 100%; max-width: 160px; height: auto; padding: 5px;"
    />
  </div>
  <div class="text-yellow-300 font-medium text-lg mt-4 md:mt-0 md:text-right w-full md:w-auto text-center md:text-right">
    <i class="fas fa-file-alt mr-1"></i> COURSE PAYMENT
  </div>
</div>

  <div class="p-6 space-y-8">
    <!-- Course Selection -->
    <div class="space-y-4">
      <div>
        <h2 class="text-xl font-semibold text-gray-800">Student Information</h2>
        <br />
        <!-- <div class="grid grid-cols-2 gap-4">
          <div class="max-w-md mx-auto mt-6">
            <label for="ID" class="block text-sm font-medium text-gray-700 mb-1"
              >General ID</label
            >
            <input
              type="text"
              id="ID"
              placeholder="Enter your name"
              class="w-full px-4 py-2 border border-gray-300 rounded-2xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              style="text-align: left"
            />
          </div>
          <div class="max-w-md mx-auto mt-6">
            <label
              for="std_Coursepayname"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Student Name</label
            >
            <input
              type="text"
              id="std_Coursepayname"
              placeholder="Enter your name"
              class="w-full px-4 py-2 border border-gray-300 rounded-2xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>
        </div> -->
        <div class="form-row">
             <div>
               <label for="ID" class="form-label"><i class="fas fa-calendar-alt"></i>Receipt No.</label>
               <input type="text" placeholder="Enter Receipt no." id="ID" name="ID" required class="form-input">
              </div>
              <div>
               <label for="std_Coursepayname" class="form-label"><i class="fas fa-user"></i>Student Name</label>
               <input type="text" id="std_Coursepayname" placeholder="Enter name" name="std_Coursepayname" required class="form-input">
              </div>
         </div>
      </div>

      <h2 class="text-xl font-semibold text-gray-800">Course Information</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Course Name</label
          >
          <select
            id="coursePaySelect"
            class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 shadow-sm"
          >
            <option value="" disabled selected>Select a course</option>
            <option value="anm_nursing">ANM Nursing Diploma</option>
            <option value="gnm_nursing">GNM Nursing Diploma</option>
            <option value="dmlt">DMLT Diploma</option>
            <option value="ot_technician">OT Technician</option>
            <option value="general_nursing">General Nursing Assistant</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Course Duration</label
          >
          <div
            id="courseDuration"
            class="w-full p-2 rounded-lg bg-gray-50 border border-gray-200"
          >
            -
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Annual Fees</label
          >
          <div
            id="coursePayFees"
            class="w-full p-2 rounded-lg bg-gray-50 border border-gray-200 font-medium"
          >
            -
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Total Course Fees</label
          >
          <div
            id="totalFees"
            class="w-full p-2 rounded-lg bg-gray-50 border border-gray-200 font-medium"
          >
            -
          </div>
        </div>
      </div>
    </div>

    <!-- Payment Options -->
    <div class="space-y-4">
      <h2 class="text-xl font-semibold text-gray-800">Payment Options</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Full Payment -->
        <div
          class="payment-card border-2 rounded-lg p-4 cursor-pointer"
          onclick="selectPayment('full')"
          id="fullPaymentCard"
        >
          <div class="flex items-center mb-2">
            <input
              type="radio"
              name="Coursepayment_type"
              value="full"
              class="h-5 w-5 text-blue-500"
              checked
            />
            <h3 class="ml-2 font-semibold">Full Payment</h3>
          </div>
  <p class="text-sm text-gray-600">
    Pay the entire amount upfront
  </p>
  <div id="fullPaymentDetails" class="mt-3 text-sm">
    <div class="flex justify-between py-1">
      <span>Course Fees:</span>
      <span id="fullCourseFees">-</span>
    </div>
    <div class="flex items-center justify-between py-1">
      <label for="fullDiscountRupees" class="font-semibold">Discount (‚Çπ):</label>
      <input
        type="text"
        id="fullDiscountRupees"
        class="w-20 px-2 py-1 border border-gray-300 rounded text-right"
        placeholder="0"
        oninput="validateIntegerOnly(this)"
        onchange="updateFullPaymentDiscount()"
      />
    </div>
    <div class="flex justify-between py-1">
      <span>Discount (%):</span>
      <span id="fullDiscountPercent">-</span>
    </div>
    <div
      class="flex justify-between py-1 border-t border-gray-200 mt-1"
    >
      <span class="font-bold">Total Payable:</span>
      <span id="fullTotal" class="font-bold text-blue-600">-</span>
    </div>
  </div>
        </div>

        <!-- Partial Payment -->
        <div
          class="payment-card border-2 rounded-lg p-4 cursor-pointer"
          onclick="selectPayment('partial')"
          id="partialPaymentCard"
        >
          <div class="flex items-center mb-2">
            <input
              type="radio"
              name="Coursepayment_type"
              value="partial"
              class="h-5 w-5 text-blue-500"
            />
            <h3 class="ml-2 font-semibold">Partial Payment</h3>
          </div>
          <p class="text-sm text-gray-600">Pay initial amount and the rest in EMIs</p>
          <div id="partialPaymentDetails" class="mt-3 text-sm space-y-2">
            <div class="flex items-center justify-between py-1">
              <label class="font-semibold">Initial Payment (‚Çπ):</label>
              <input
                type="text"
                id="partialInitialInput"
                class="w-24 px-2 py-1 border border-gray-300 rounded text-right"
                placeholder="0"
                oninput="validateIntegerOnly(this)"
                onchange="updatePartialPayment()"
              />
            </div>
            <div class="flex items-center justify-between py-1">
              <label class="font-semibold">EMI Tenure (months):</label>
              <select
                id="partialTenure"
                class="border rounded px-2 py-1"
                onchange="updatePartialPayment()"
                style="width: 80px;"
              >
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6" selected>6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
              </select>
            </div>
            <div class="flex justify-between py-1">
              <span>Remaining Amount:</span>
              <span id="partialRemaining">-</span>
            </div>
            <div
              class="flex justify-between py-1 border-t border-gray-200 mt-1"
            >
              <span class="font-bold">EMI Amount:</span>
              <span id="partialEMI" class="font-bold text-blue-600">-</span>
            </div>
          </div>
        </div>

        <!-- EMI Payment -->
        <div
          class="payment-card border-2 rounded-lg p-4 cursor-pointer"
          onclick="selectPayment('emi')"
          id="emiPaymentCard"
        >
          <div class="flex items-center mb-2">
            <input
              type="radio"
              name="Coursepayment_type"
              value="emi"
              checked
              class="h-5 w-5 text-blue-500"
            />
            <h3 class="ml-2 font-semibold">EMI Plan</h3>
          </div>
          <p class="text-sm text-gray-600">Pay in easy monthly installments</p>
          <div id="emiPaymentDetails" class="mt-3 text-sm space-y-2">
            <div class="flex items-center justify-between py-1">
              <label class="font-semibold">Down Payment (‚Çπ):</label>
              <input
                type="text"
                id="emiDownPaymentInput"
                class="w-24 px-2 py-1 border border-gray-300 rounded text-right"
                placeholder="0"
                oninput="validateIntegerOnly(this)"
                onchange="updateEMIPayment()"
              />
            </div>
            <div class="flex items-center justify-between py-1">
              <label class="font-semibold">EMI Tenure (months):</label>
              <select
                id="emiTenure"
                class="border rounded px-2 py-1"
                onchange="updateEMIPayment()"
                style="width: 80px;"
              >
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="18">18</option>
                <option value="24">24</option>
              </select>
            </div>
            <div class="flex justify-between py-1">
              <span>EMI Amount:</span>
              <span id="emiAmount" class="font-bold text-blue-600">-</span>
            </div>
            <div class="flex justify-between py-1">
              <span>Total Amount:</span>
              <span id="emiTotalAmount" class="font-semibold">-</span>
            </div>
            <div
              class="flex justify-between py-1 border-t border-gray-200 mt-1"
            >
              <span class="font-bold">Total Payable:</span>
              <span id="emiTotal" class="font-bold text-blue-600">-</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Installment Plan (shown for EMI/Partial) -->
    <div
      id="installmentPlan"
      class="hidden bg-white rounded-lg border border-gray-200 p-4 installment-plan"
    >
      <h3 class="font-semibold text-lg mb-3">Installment Schedule</h3>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th
                class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"
              >
                Installment
              </th>
              <th
                class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"
              >
                Due Date
              </th>
              <th
                class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"
              >
                Amount
              </th>
              <th
                class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"
              >
                Status
              </th>
              <th
                class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"
              >
                Checkbox
              </th>
              <th
                class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"
              >
                Receipt
              </th>
            </tr>
          </thead>
          <tbody
            id="installmentTable"
            class="bg-white divide-y divide-gray-200"
          >
            <!-- Installment rows will be added here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Payment method -->
    <h2 class="text-xl font-semibold text-gray-800">Payment method</h2>
    <label class="text-l font-semibold text-gray-600" for="pay-select"
      >Select payment:</label
    >
    <select id="pay-select">
      <button>
        <selectedcontent></selectedcontent>
      </button>

      <option value="">Select a method</option>
      <option value="Bank">
        <span class="icon" aria-hidden="true">üè¶</span
        ><span class="option-label">Bank</span>
      </option>
      <option value="UPI">
        <span class="icon" aria-hidden="true">üì±</span
        ><span class="option-label">UPI</span>
      </option>
      <option value="Cash">
        <span class="icon" aria-hidden="true">üíµ</span
        ><span class="option-label">Cash</span>
      </option>
      <option value="cheque">
  <span class="icon text-lg" aria-hidden="true">‚úçÔ∏è</span>
  <span class="option-label">Bank Check</span>
 </option>
    </select>

    <!-- Submit Button -->
    
    <!-- <div class="pt-4">
      <button
        onmouseover="copyCoursePay()"
        onclick="openAdmissionForm()"
        class="w-full bg-gradient-to-r from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 transform hover:scale-105"
      >
        Proceed to Admission Form
      </button>
    </div> -->
 <div class="flex justify-end">
<button onclick="generateReceipt() "
 class="bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-medium tracking-wide py-2.5 px-6 rounded-md shadow-lg transform hover:scale-105 transition duration-300 flex items-center justify-center gap-2"
      >Save & Generate Receipt</button>
&nbsp;&nbsp;
<button onclick="submitCoursePayment() "
 class="bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-medium tracking-wide py-2.5 px-6 rounded-md shadow-lg transform hover:scale-105 transition duration-300 flex items-center justify-center gap-2"
      >Submit to sheet</button>
&nbsp;&nbsp;
<button onclick="proceedToAdmissionReceipt()"
 class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-medium tracking-wide py-2.5 px-6 rounded-md shadow-lg transform hover:scale-105 transition duration-300 flex items-center justify-center gap-2"
      >Proceed to Admission Receipt</button>
 </div>
<style>
  /* Hide number input arrows (spinner buttons) */
  input[type="number"].no-spinner::-webkit-outer-spin-button,
  input[type="number"].no-spinner::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  input[type="number"].no-spinner {
    -moz-appearance: textfield;
  }
</style>
<!-- Add this receipt container (if missing) -->
  </div>
  <div id="receiptContainer" class="hidden p-6 bg-white rounded-lg shadow-md"></div>

</div>
<script>
  // Function to validate integer input - only allow whole numbers, no decimals
  function validateIntegerInput(inputElement) {
    // Remove any non-digit characters (excluding negative sign and decimal point initially)
    let value = inputElement.value.replace(/[^\d]/g, '');

    // Remove leading zeros unless the value is "0"
    if (value.startsWith('0') && value.length > 1) {
      value = value.replace(/^0+/, '');
    }

    // If empty, set to "0" or empty string based on placeholder
    if (value === '') {
      value = inputElement.placeholder === '0' ? '0' : '';
    }

    // Update the input value
    inputElement.value = value;
  }

  // Simple integer validation function - immediate filtering for normal text input behavior
  function validateIntegerOnly(inputElement) {
    // Get current value after the input event
    let currentValue = inputElement.value;

    // Filter out non-digit characters immediately
    let filteredValue = currentValue.replace(/[^\d]/g, '');

    // Only update if the value actually changed
    if (currentValue !== filteredValue) {
      inputElement.value = filteredValue;
    }
  }

  function submitCoursePayment() {
  const formData = {
    ID: document.getElementById("ID").value,
    Coursepayname: document.getElementById("std_Coursepayname").value,
    coursePaySelect: document.getElementById("coursePaySelect").value,
    courseDuration: document.getElementById("courseDuration").innerText,
    coursePayFees: document.getElementById("coursePayFees").innerText,
    totalFees: document.getElementById("totalFees").innerText,
    paySelect: document.getElementById("pay-select").value
  };

  google.script.run
    .withSuccessHandler((result) => {
      if (result.success) {
        alert("Course payment saved successfully!");
      } else {
        alert("Error: " + result.message);
      }
    })
    .withFailureHandler((error) => {
      alert("Error saving payment: " + error);
    })
    .saveCoursePayment(formData); // Backend function
}

 function proceedToAdmissionReceipt() {
  try {
    // üî• CRITICAL: Store current course payment data along with combined workflow data
    const coursePaymentData = {
      receiptNo: document.getElementById("ID")?.value || "AR-" + Math.floor(1000 + Math.random() * 9000),
      studentName: document.getElementById("std_Coursepayname")?.value || "",
      courseName: document.getElementById("coursePaySelect")?.value || "",
      courseDuration: document.getElementById("courseDuration")?.textContent || "",
      totalFee: document.getElementById("totalFees")?.textContent ? parseFloat(document.getElementById("totalFees").textContent.replace(/[^0-9.]/g, '')) : 0,
      paymentMethod: document.getElementById("pay-select")?.value || "Cash",
      startDate: new Date().toISOString().split('T')[0], // Today's date as start date
      courseYear: 1, // Default to 1st year
      installmentCount: 12, // Default to 12 installments (monthly)
      loggedInUser: document.getElementById("loggedInUserId")?.value || "Admin",
      receiptDate: new Date().toISOString().split('T')[0]
    };

    // üî• CRITICAL: Retrieve and merge previous workflow data
    const inquiryData = JSON.parse(sessionStorage.getItem('inquiryDataForAdmission') || '{}');
    const admissionData = JSON.parse(sessionStorage.getItem('admissionData') || '{}');

    console.log("Merging data for receipt:");
    console.log("inquiryData:", inquiryData);
    console.log("admissionData:", admissionData);
    console.log("coursePaymentData:", coursePaymentData);

    // Ensure studentName is properly built from admission data first (prioritize complete studentName), then build from parts, then inquiry data
    let studentName = "";
    if (admissionData.studentName && admissionData.studentName.trim() !== "") {
      studentName = admissionData.studentName;
    } else if (admissionData.firstName || admissionData.lastName) {
      // Build from admission data individual name parts
      const firstName = admissionData.firstName || "";
      const middleName = admissionData.middleName || "";
      const lastName = admissionData.lastName || "";
      studentName = [firstName, middleName, lastName].filter(Boolean).join(" ");
    } else if (inquiryData.firstName || inquiryData.lastName) {
      // Fallback to inquiry data
      const firstName = inquiryData.firstName || "";
      const middleName = inquiryData.middleName || "";
      const lastName = inquiryData.lastName || "";
      studentName = [firstName, middleName, lastName].filter(Boolean).join(" ");
    }
    // Fallback to course payment form data
    if (!studentName) {
      studentName = coursePaymentData.studentName;
    }

    // üî• CRITICAL: Create complete admission receipt data by merging all sources
    const completeReceiptData = {
      // Basic Info
      receiptNo: coursePaymentData.receiptNo,
      receiptDate: coursePaymentData.receiptDate,
      studentName: studentName,

      // Course Info
      courseName: coursePaymentData.courseName,
      courseYear: coursePaymentData.courseYear,
      courseDuration: coursePaymentData.courseDuration,

      // Fee Details
      totalFee: coursePaymentData.totalFee,
      installmentCount: coursePaymentData.installmentCount,
      startDate: coursePaymentData.startDate,

      // Guardian Info (critical for agreement section) - FIXED: Use correct property names
      guardianName: admissionData.guardianName || admissionData.guardian_name || admissionData.guardianName || "",
      studentRelation: admissionData.studentRelation || admissionData.guardian_relation || admissionData.studentRelation || "",

      // Additional fields from admission form
      addressLine1: admissionData.addressLine1 || "",
      addressLine2: admissionData.addressLine2 || "",
      addressLine3: admissionData.addressLine3 || "",
      pincode: admissionData.pincode || "",
      phoneNo: admissionData.phoneNo || inquiryData.phoneNo || "",
      whatsappNo: admissionData.whatsappNo || inquiryData.whatsappNo || "",
      email: admissionData.email || inquiryData.email || "",
      age: admissionData.age || inquiryData.age || "",
      gender: admissionData.gender || "",
      qualification: admissionData.qualification || inquiryData.qualification || "",
      parentsNo: admissionData.parentsNo || "",

      // Workflow metadata
      loggedInUser: coursePaymentData.loggedInUser,
      inquiryTakenBy: inquiryData.inquiryTakenBy || "",
      branch: admissionData.branch || inquiryData.branch22 || "",
      interestedCourse: admissionData.interestedCourse || inquiryData.interestedCourse || coursePaymentData.courseName,

      // Consent status - FIXED: Generate consentText if not present
      agree: admissionData.agree || false,
      consentText: admissionData.consentText || (admissionData.guardian_name && admissionData.guardian_relation
        ? `I am ${admissionData.guardian_relation} of ${admissionData.guardian_name}`
        : admissionData.guardianName && admissionData.studentRelation
        ? `I am ${admissionData.studentRelation} of ${admissionData.guardianName}`
        : "")
    };

    // üî• CRITICAL: Store complete workflow data in sessionStorage
    sessionStorage.setItem('completeReceiptData', JSON.stringify(completeReceiptData));

    console.log("Complete receipt data prepared:", completeReceiptData);

    // üî• CRITICAL: Use the same function as sidebar instead of navigating to new page
    openreceiptFormSection();

  } catch (error) {
    console.error("Error in proceedToAdmissionReceipt:", error);
    alert("Error preparing admission receipt. Please check console for details.");
  }
}

</script>
