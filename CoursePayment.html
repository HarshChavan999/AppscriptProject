<div
  id="coursePaymentSection"
  class="bg-white rounded-xl shadow-xl overflow-hidden"
>
  <!-- <div class="header-bg text-white p-6 bg-blue-800">
    <div class="logo-container" style="width: 180px; height: auto; display: flex; justify-content: center; align-items: center;">
       <img 
      src="https://i.postimg.cc/FzvwbhS3/Untitled-1.png" 
       alt="Logo" 
     style="width: 100%; max-width: 160px; height: auto; padding: 5px;"
       />
    </div>
   <h1 class="text-2xl font-bold">STI SHELAR TRAINING INSTITUTE</h1>
    <p class="opacity-90">C/34, Bunglow, Near
                  Nandikeshwar Mandir, Kamgar Nagar, Kurla(E)
    </p> -->
    <!-- <div class="text-center md:text-right">
              <p class="text-yellow-300 font-medium text-lg"> <i class="fas fa-file-alt mr-1"></i> COURSE PAYMENT
              </p>
                            </div>
  </div> -->
  <div class="header-bg text-white p-6 bg-blue-800 flex flex-col md:flex-row justify-between items-center">
  <div class="logo-container" style="width: 180px; height: auto; display: flex; justify-content: center; align-items: center;">
     <img 
      src="https://i.postimg.cc/FzvwbhS3/Untitled-1.png" 
      alt="Logo" 
      style="width: 100%; max-width: 160px; height: auto; padding: 5px;"
    />
  </div>
  <div class="text-yellow-300 font-medium text-lg mt-4 md:mt-0 md:text-right w-full md:w-auto text-center md:text-right">
    <i class="fas fa-file-alt mr-1"></i> COURSE PAYMENT
  </div>
</div>

  <div class="p-6 space-y-8">
    <!-- Course Selection -->
    <div class="space-y-4">
      <div>
        <h2 class="text-xl font-semibold text-gray-800">Student Information</h2>
        <br />
        <!-- <div class="grid grid-cols-2 gap-4">
          <div class="max-w-md mx-auto mt-6">
            <label for="ID" class="block text-sm font-medium text-gray-700 mb-1"
              >General ID</label
            >
            <input
              type="text"
              id="ID"
              placeholder="Enter your name"
              class="w-full px-4 py-2 border border-gray-300 rounded-2xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              style="text-align: left"
            />
          </div>
          <div class="max-w-md mx-auto mt-6">
            <label
              for="std_Coursepayname"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Student Name</label
            >
            <input
              type="text"
              id="std_Coursepayname"
              placeholder="Enter your name"
              class="w-full px-4 py-2 border border-gray-300 rounded-2xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>
        </div> -->
        <div class="form-row">
             <div>
               <label for="ID" class="form-label"><i class="fas fa-calendar-alt"></i>Receipt No.</label>
               <input type="text" placeholder="Enter Receipt no." id="ID" name="ID" required class="form-input">
              </div>
              <div>
               <label for="std_Coursepayname" class="form-label"><i class="fas fa-user"></i>Student Name</label>
               <input type="text" id="std_Coursepayname" placeholder="Enter name" name="std_Coursepayname" required class="form-input">
              </div>
         </div>
         <div class="form-row">
              <div>
               <label for="enrollmentId" class="form-label"><i class="fas fa-id-card"></i>Enrollment ID</label>
               <input type="text" id="enrollmentId" placeholder="Enrollment ID" name="enrollmentId" readonly class="form-input">
              </div>
         </div>
      </div>

      <h2 class="text-xl font-semibold text-gray-800">Course Information</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Course Name</label
          >
          <select
            id="coursePaySelect"
            class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 shadow-sm"
          >
            <option value="" disabled selected>Select a course</option>
            <option value="anm_nursing">ANM Nursing Diploma</option>
            <option value="gnm_nursing">GNM Nursing Diploma</option>
            <option value="dmlt">DMLT Diploma</option>
            <option value="ot_technician">OT Technician</option>
            <option value="general_nursing">General Nursing Assistant</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Course Duration</label
          >
          <div
            id="courseDuration"
            class="w-full p-2 rounded-lg bg-gray-50 border border-gray-200"
          >
            -
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Annual Fees</label
          >
          <div
            id="coursePayFees"
            class="w-full p-2 rounded-lg bg-gray-50 border border-gray-200 font-medium"
          >
            -
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Total Course Fees</label
          >
          <div
            id="totalFees"
            class="w-full p-2 rounded-lg bg-gray-50 border border-gray-200 font-medium"
          >
            -
          </div>
        </div>
      </div>
    </div>

    <!-- Payment Options -->
    <div id="paymentOptionsSection" class="space-y-4">
      <h2 class="text-xl font-semibold text-gray-800">Payment Options</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Full Payment -->
        <div
          class="payment-card border-2 rounded-lg p-4 cursor-pointer"
          onclick="selectPayment('full')"
          id="fullPaymentCard"
        >
          <div class="flex items-center mb-2">
            <input
              type="radio"
              name="Coursepayment_type"
              value="full"
              class="h-5 w-5 text-blue-500"
              checked
            />
            <h3 class="ml-2 font-semibold">Full Payment</h3>
          </div>
  <p class="text-sm text-gray-600">
    Pay the entire amount upfront
  </p>
  <div id="fullPaymentDetails" class="mt-3 text-sm">
    <div class="flex justify-between py-1">
      <span>Course Fees:</span>
      <span id="fullCourseFees">-</span>
    </div>
    <div class="flex items-center justify-between py-1">
      <label for="fullDiscountRupees" class="font-semibold">Discount (‚Çπ):</label>
      <input
        type="text"
        id="fullDiscountRupees"
        class="w-20 px-2 py-1 border border-gray-300 rounded text-right"
        placeholder="0"
        oninput="validateIntegerOnly(this)"
        onchange="updateFullPaymentDiscount()"
      />
    </div>
    <div class="flex justify-between py-1">
      <span>Discount (%):</span>
      <span id="fullDiscountPercent">-</span>
    </div>
    <div
      class="flex justify-between py-1 border-t border-gray-200 mt-1"
    >
      <span class="font-bold">Total Payable:</span>
      <span id="fullTotal" class="font-bold text-blue-600">-</span>
    </div>
  </div>
        </div>

        <!-- Partial Payment -->
        <div
          class="payment-card border-2 rounded-lg p-4 cursor-pointer"
          onclick="selectPayment('partial')"
          id="partialPaymentCard"
        >
          <div class="flex items-center mb-2">
            <input
              type="radio"
              name="Coursepayment_type"
              value="partial"
              class="h-5 w-5 text-blue-500"
            />
            <h3 class="ml-2 font-semibold">Partial Payment</h3>
          </div>
          <p class="text-sm text-gray-600">Pay initial amount and the rest in EMIs</p>
          <div id="partialPaymentDetails" class="mt-3 text-sm space-y-2">
            <div class="flex items-center justify-between py-1">
              <label class="font-semibold">Initial Payment (‚Çπ):</label>
              <input
                type="text"
                id="partialInitialInput"
                class="w-24 px-2 py-1 border border-gray-300 rounded text-right"
                placeholder="0"
                oninput="validateIntegerOnly(this)"
                onchange="updatePartialPayment()"
              />
            </div>
            <div class="flex items-center justify-between py-1">
              <label class="font-semibold">EMI Tenure (months):</label>
              <select
                id="partialTenure"
                class="border rounded px-2 py-1"
                onchange="updatePartialPayment()"
                style="width: 80px;"
              >
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6" selected>6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
              </select>
            </div>
            <div class="flex justify-between py-1">
              <span>Remaining Amount:</span>
              <span id="partialRemaining">-</span>
            </div>
            <div
              class="flex justify-between py-1 border-t border-gray-200 mt-1"
            >
              <span class="font-bold">EMI Amount:</span>
              <span id="partialEMI" class="font-bold text-blue-600">-</span>
            </div>
          </div>
        </div>

        <!-- EMI Payment -->
        <div
          class="payment-card border-2 rounded-lg p-4 cursor-pointer"
          onclick="selectPayment('emi')"
          id="emiPaymentCard"
        >
          <div class="flex items-center mb-2">
            <input
              type="radio"
              name="Coursepayment_type"
              value="emi"
              class="h-5 w-5 text-blue-500"
            />
            <h3 class="ml-2 font-semibold">EMI Plan</h3>
          </div>
          <p class="text-sm text-gray-600">Pay in easy monthly installments</p>
          <div id="emiPaymentDetails" class="mt-3 text-sm space-y-2">
            <div class="flex items-center justify-between py-1">
              <label class="font-semibold">Down Payment (‚Çπ):</label>
              <input
                type="text"
                id="emiDownPaymentInput"
                class="w-24 px-2 py-1 border border-gray-300 rounded text-right"
                placeholder="0"
                oninput="validateIntegerOnly(this)"
                onchange="updateEMIPayment()"
              />
            </div>
            <div class="flex items-center justify-between py-1">
              <label class="font-semibold">EMI Tenure (months):</label>
              <select
                id="emiTenure"
                class="border rounded px-2 py-1"
                onchange="updateEMIPayment()"
                style="width: 80px;"
              >
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="18">18</option>
                <option value="24">24</option>
              </select>
            </div>
            <div class="flex justify-between py-1">
              <span>EMI Amount:</span>
              <span id="emiAmount" class="font-bold text-blue-600">-</span>
            </div>
            <div class="flex justify-between py-1">
              <span>Total Amount:</span>
              <span id="emiTotalAmount" class="font-semibold">-</span>
            </div>
            <div
              class="flex justify-between py-1 border-t border-gray-200 mt-1"
            >
              <span class="font-bold">Total Payable:</span>
              <span id="emiTotal" class="font-bold text-blue-600">-</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Installment Schedule (shown when coming from Admission Analytics) -->
    <div id="installmentScheduleSection" class="space-y-4 hidden">
      <h2 class="text-xl font-semibold text-gray-800">Installment Schedule</h2>
      <div class="bg-white rounded-lg border border-gray-200 p-4">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Installment</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Due Date</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Mark as Paid</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Receipt</th>
              </tr>
            </thead>
            <tbody id="installmentTable" class="bg-white divide-y divide-gray-200">
              <!-- Installment rows will be added here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>



    <!-- Payment method -->
    <h2 class="text-xl font-semibold text-gray-800">Payment method</h2>
    <label class="text-l font-semibold text-gray-600" for="pay-select"
      >Select payment:</label
    >
    <select id="pay-select">
      <button>
        <selectedcontent></selectedcontent>
      </button>

      <option value="">Select a method</option>
      <option value="Bank">
        <span class="icon" aria-hidden="true">üè¶</span
        ><span class="option-label">Bank</span>
      </option>
      <option value="UPI">
        <span class="icon" aria-hidden="true">üì±</span
        ><span class="option-label">UPI</span>
      </option>
      <option value="Cash">
        <span class="icon" aria-hidden="true">üíµ</span
        ><span class="option-label">Cash</span>
      </option>
      <option value="cheque">
  <span class="icon text-lg" aria-hidden="true">‚úçÔ∏è</span>
  <span class="option-label">Bank Check</span>
 </option>
    </select>

    <!-- Submit Button -->
    
    <!-- <div class="pt-4">
      <button
        onmouseover="copyCoursePay()"
        onclick="openAdmissionForm()"
        class="w-full bg-gradient-to-r from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 transform hover:scale-105"
      >
        Proceed to Admission Form
      </button>
    </div> -->
 <div class="flex justify-end">


<button onclick="proceedToAdmissionReceipt()"
 class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-medium tracking-wide py-2.5 px-6 rounded-md shadow-lg transform hover:scale-105 transition duration-300 flex items-center justify-center gap-2"
      >Proceed to Admission Receipt</button>
 </div>
<style>
  /* Hide number input arrows (spinner buttons) */
  input[type="number"].no-spinner::-webkit-outer-spin-button,
  input[type="number"].no-spinner::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  input[type="number"].no-spinner {
    -moz-appearance: textfield;
  }
</style>
<!-- Add this receipt container (if missing) -->
  </div>
  <div id="receiptContainer" class="hidden p-6 bg-white rounded-lg shadow-md"></div>

</div>
<script>
  // Function to validate integer input - only allow whole numbers, no decimals
  function validateIntegerInput(inputElement) {
    // Remove any non-digit characters (excluding negative sign and decimal point initially)
    let value = inputElement.value.replace(/[^\d]/g, '');

    // Remove leading zeros unless the value is "0"
    if (value.startsWith('0') && value.length > 1) {
      value = value.replace(/^0+/, '');
    }

    // If empty, set to "0" or empty string based on placeholder
    if (value === '') {
      value = inputElement.placeholder === '0' ? '0' : '';
    }

    // Update the input value
    inputElement.value = value;
  }

  // Simple integer validation function - immediate filtering for normal text input behavior
  function validateIntegerOnly(inputElement) {
    // Get current value after the input event
    let currentValue = inputElement.value;

    // Filter out non-digit characters immediately
    let filteredValue = currentValue.replace(/[^\d]/g, '');

    // Only update if the value actually changed
    if (currentValue !== filteredValue) {
      inputElement.value = filteredValue;
    }
  }

  function submitCoursePayment() {
  const formData = {
    ID: document.getElementById("ID").value,
    Coursepayname: document.getElementById("std_Coursepayname").value,
    enrollmentId: document.getElementById("enrollmentId").value,
    coursePaySelect: document.getElementById("coursePaySelect").value,
    courseDuration: document.getElementById("courseDuration")?.textContent || "",
    coursePayFees: document.getElementById("coursePayFees").innerText,
    totalFees: document.getElementById("totalFees").innerText,
    paySelect: document.getElementById("pay-select").value
  };

  google.script.run
    .withSuccessHandler((result) => {
      if (result.success) {
        alert("Course payment saved successfully!");
      } else {
        alert("Error: " + result.message);
      }
    })
    .withFailureHandler((error) => {
      alert("Error saving payment: " + error);
    })
    .saveCoursePayment(formData); // Backend function
}

  // Function to generate installment schedule based on payment type
  function generateInstallmentScheduleForPaymentType(paymentType, totalFee) {
    const schedule = [];
    const startDate = new Date();

    if (paymentType === "full") {
      // Full payment: single installment
      schedule.push({
        installmentNumber: 1,
        amount: totalFee,
        dueDate: startDate.toISOString().split('T')[0],
        status: "Full Paid"
      });
    } else if (paymentType === "partial") {
      // Partial payment: initial payment + EMIs
      const initialPayment = parseFloat(document.getElementById("partialInitialInput").value) || 0;
      const tenure = parseInt(document.getElementById("partialTenure").value) || 6;
      const remainingAmount = totalFee - initialPayment;
      const emiAmount = Math.ceil(remainingAmount / tenure);

      // Initial payment
      if (initialPayment > 0) {
        schedule.push({
          installmentNumber: 1,
          amount: initialPayment,
          dueDate: startDate.toISOString().split('T')[0],
          status: "Pending",
          type: "Initial Payment"
        });
      }

      // EMI installments
      for (let i = 1; i <= tenure; i++) {
        const installmentNumber = initialPayment > 0 ? i + 1 : i;
        const dueDate = new Date(startDate);
        dueDate.setMonth(startDate.getMonth() + i);

        schedule.push({
          installmentNumber: installmentNumber,
          amount: emiAmount,
          dueDate: dueDate.toISOString().split('T')[0],
          status: "Pending",
          type: "EMI"
        });
      }
    } else if (paymentType === "emi") {
      // EMI payment: down payment + EMIs
      const downPayment = parseFloat(document.getElementById("emiDownPaymentInput").value) || 0;
      const tenure = parseInt(document.getElementById("emiTenure").value) || 12;
      const remainingAmount = totalFee - downPayment;
      const emiAmount = Math.ceil(remainingAmount / tenure);

      // Down payment
      if (downPayment > 0) {
        schedule.push({
          installmentNumber: 1,
          amount: downPayment,
          dueDate: startDate.toISOString().split('T')[0],
          status: "Pending",
          type: "Down Payment"
        });
      }

      // EMI installments
      for (let i = 1; i <= tenure; i++) {
        const installmentNumber = downPayment > 0 ? i + 1 : i;
        const dueDate = new Date(startDate);
        dueDate.setMonth(startDate.getMonth() + i);

        schedule.push({
          installmentNumber: installmentNumber,
          amount: emiAmount,
          dueDate: dueDate.toISOString().split('T')[0],
          status: "Pending",
          type: "EMI"
        });
      }
    }

    console.log("Generated installment schedule:", schedule);
    return schedule;
  }

 function proceedToAdmissionReceipt() {
  try {
    // üî• CRITICAL: Store current course payment data along with combined workflow data
    const courseDurationElement = document.getElementById("courseDuration");
    let courseDuration = courseDurationElement?.textContent?.trim() || "";

    // üî• DEBUG: Force update course details before proceeding
    const courseSelect = document.getElementById("coursePaySelect");
    if (courseSelect && courseSelect.value) {
      // Manually trigger updateCoursePayDetails to ensure duration is current
      if (typeof updateCoursePayDetails === 'function') {
        updateCoursePayDetails();
        // Re-get the duration after update
        const updatedDuration = courseDurationElement?.textContent?.trim() || "";
        if (updatedDuration && updatedDuration !== courseDuration && updatedDuration !== "-") {
          courseDuration = updatedDuration;
          console.log("Updated course duration from", courseDuration, "to", updatedDuration);
        }
      }
    }

    // üî• FALLBACK: If duration is still empty or "-", try to get it from course data
    if (!courseDuration || courseDuration === "-") {
      const selectedCourse = courseSelect?.value;
      if (selectedCourse && typeof getCourseDataByLocation === 'function') {
        let branch24 = document.getElementById("branch22")?.value;
        if (!branch24) {
          branch24 = sessionStorage.getItem("userBranch") || "kurla";
        }
        const courseData = getCourseDataByLocation(branch24);
        if (courseData[selectedCourse]) {
          courseDuration = courseData[selectedCourse].duration;
          console.log("Using fallback course duration:", courseDuration);
        }
      }
    }

    console.log("Course duration element:", courseDurationElement);
    console.log("Course duration textContent:", courseDurationElement?.textContent);
    console.log("Final course duration:", courseDuration);

    // Get selected payment type and generate installment schedule
    const paymentType = document.querySelector('input[name="Coursepayment_type"]:checked')?.value || "full";
    const totalFee = document.getElementById("totalFees")?.textContent ? parseFloat(document.getElementById("totalFees").textContent.replace(/[^0-9.]/g, '')) : 0;
    const installmentSchedule = generateInstallmentScheduleForPaymentType(paymentType, totalFee);

    const coursePaymentData = {
      receiptNo: document.getElementById("ID")?.value || "AR-" + Math.floor(1000 + Math.random() * 9000),
      studentName: document.getElementById("std_Coursepayname")?.value || "",
      courseName: document.getElementById("coursePaySelect")?.value || "",
      courseDuration: courseDuration,
      totalFee: totalFee,
      paymentMethod: document.getElementById("pay-select")?.value || "Cash",
      startDate: new Date().toISOString().split('T')[0], // Today's date as start date
      courseYear: 1, // Default to 1st year
      installmentCount: installmentSchedule.length, // Use actual installment count
      loggedInUser: document.getElementById("loggedInUserId")?.value || "Admin",
      receiptDate: new Date().toISOString().split('T')[0],
      paymentType: paymentType,
      installmentSchedule: installmentSchedule // Add the detailed schedule
    };

    // üî• CRITICAL: Retrieve and merge previous workflow data
    const inquiryData = JSON.parse(sessionStorage.getItem('inquiryDataForAdmission') || '{}');
    const admissionData = JSON.parse(sessionStorage.getItem('admissionData') || '{}');

    console.log("Merging data for receipt:");
    console.log("inquiryData:", inquiryData);
    console.log("admissionData:", admissionData);
    console.log("coursePaymentData:", coursePaymentData);

    // Ensure studentName is properly built from admission data first (prioritize complete studentName), then build from parts, then inquiry data
    let studentName = "";
    if (admissionData.studentName && admissionData.studentName.trim() !== "") {
      studentName = admissionData.studentName;
    } else if (admissionData.firstName || admissionData.lastName) {
      // Build from admission data individual name parts
      const firstName = admissionData.firstName || "";
      const middleName = admissionData.middleName || "";
      const lastName = admissionData.lastName || "";
      studentName = [firstName, middleName, lastName].filter(Boolean).join(" ");
    } else if (inquiryData.firstName || inquiryData.lastName) {
      // Fallback to inquiry data
      const firstName = inquiryData.firstName || "";
      const middleName = inquiryData.middleName || "";
      const lastName = inquiryData.lastName || "";
      studentName = [firstName, middleName, lastName].filter(Boolean).join(" ");
    }
    // Fallback to course payment form data
    if (!studentName) {
      studentName = coursePaymentData.studentName;
    }

    // üî• CRITICAL: Create complete admission receipt data by merging all sources
    const completeReceiptData = {
      // Basic Info
      receiptNo: coursePaymentData.receiptNo,
      receiptDate: coursePaymentData.receiptDate,
      studentName: studentName,
      enrollmentNo: document.getElementById("enrollmentId")?.value || "",

      // Course Info
      courseName: coursePaymentData.courseName,
      courseYear: coursePaymentData.courseYear,
      courseDuration: coursePaymentData.courseDuration,

      // Fee Details
      totalFee: coursePaymentData.totalFee,
      paymentType: coursePaymentData.paymentType,
      installmentCount: coursePaymentData.installmentCount,
      startDate: coursePaymentData.startDate,
      installmentSchedule: coursePaymentData.installmentSchedule, // Add the installment schedule

      // Guardian Info (critical for agreement section) - FIXED: Use correct property names
      guardianName: admissionData.guardianName || admissionData.guardian_name || admissionData.guardianName || "",
      studentRelation: admissionData.studentRelation || admissionData.guardian_relation || admissionData.studentRelation || "",

      // Student Photo from admission form (check both sessionStorage and localStorage)
      studentPhoto: sessionStorage.getItem('studentPhoto') || localStorage.getItem('admission_studentPhoto') || "",

      // Additional fields from admission form
      addressLine1: admissionData.addressLine1 || "",
      addressLine2: admissionData.addressLine2 || "",
      addressLine3: admissionData.addressLine3 || "",
      pincode: admissionData.pincode || "",
      phoneNo: admissionData.phoneNo || inquiryData.phoneNo || "",
      whatsappNo: admissionData.whatsappNo || inquiryData.whatsappNo || "",
      email: admissionData.email || inquiryData.email || "",
      age: admissionData.age || inquiryData.age || "",
      gender: admissionData.gender || "",
      qualification: admissionData.qualification || inquiryData.qualification || "",
      parentsNo: admissionData.parentsNo || "",

      // Workflow metadata
      loggedInUser: coursePaymentData.loggedInUser,
      inquiryTakenBy: inquiryData.inquiryTakenBy || "",
      branch: admissionData.branch || inquiryData.branch22 || "",
      interestedCourse: admissionData.interestedCourse || inquiryData.interestedCourse || coursePaymentData.courseName,

      // Consent status - FIXED: Generate consentText if not present
      agree: admissionData.agree || false,
      consentText: admissionData.consentText || (admissionData.guardian_name && admissionData.guardian_relation
        ? `I am ${admissionData.guardian_relation} of ${admissionData.guardian_name}`
        : admissionData.guardianName && admissionData.studentRelation
        ? `I am ${admissionData.studentRelation} of ${admissionData.guardianName}`
        : "")
    };

    console.log("CoursePayment - Photo retrieval:");
    console.log("sessionStorage studentPhoto:", sessionStorage.getItem('studentPhoto') ? "EXISTS (length: " + sessionStorage.getItem('studentPhoto').length + ")" : "NOT FOUND");
    console.log("localStorage admission_studentPhoto:", localStorage.getItem('admission_studentPhoto') ? "EXISTS (length: " + localStorage.getItem('admission_studentPhoto').length + ")" : "NOT FOUND");
    console.log("Final studentPhoto in completeReceiptData:", completeReceiptData.studentPhoto ? "EXISTS (length: " + completeReceiptData.studentPhoto.length + ")" : "NOT FOUND");

    // üî• CRITICAL: Save installment schedule to persist exact schedule
    google.script.run
      .withSuccessHandler((scheduleResult) => {
        if (scheduleResult.success) {
          console.log("Installment schedule saved successfully");
        } else {
          console.error("Failed to save installment schedule:", scheduleResult.message);
        }

        // üî• CRITICAL: Store complete workflow data in sessionStorage
        sessionStorage.setItem('completeReceiptData', JSON.stringify(completeReceiptData));

        console.log("Complete receipt data prepared:", completeReceiptData);

        // üî• CRITICAL: Use the same function as sidebar instead of navigating to new page
        openreceiptFormSection();
      })
      .withFailureHandler((error) => {
        console.error("Error saving installment schedule:", error);
        // Continue with receipt generation even if schedule save fails
        sessionStorage.setItem('completeReceiptData', JSON.stringify(completeReceiptData));
        openreceiptFormSection();
      })
      .saveInstallmentSchedule({
        receiptNo: coursePaymentData.receiptNo,
        studentName: coursePaymentData.studentName,
        enrollmentNo: coursePaymentData.enrollmentId,
        courseName: coursePaymentData.courseName,
        paymentType: coursePaymentData.paymentType,
        totalFee: coursePaymentData.totalFee,
        installmentSchedule: coursePaymentData.installmentSchedule
      });

  } catch (error) {
    console.error("Error in proceedToAdmissionReceipt:", error);
    alert("Error preparing admission receipt. Please check console for details.");
  }
}

  // Function to populate installment schedule
  function populateInstallmentSchedule() {
    const receiptNo = document.getElementById("ID").value;

    if (!receiptNo || receiptNo.trim() === "") {
      console.log("No receipt number found, cannot load installment schedule");
      return;
    }

    const tableBody = document.getElementById("installmentTable");
    tableBody.innerHTML = "";

    // Load local payments first for immediate UI updates
    let localPayments = loadLocalPayments(receiptNo);
    console.log("Loaded local payments:", localPayments);

    // Try to load saved installment schedule first
    google.script.run
      .withSuccessHandler((savedSchedule) => {
        console.log("Loaded saved installment schedule:", savedSchedule);

        if (savedSchedule && savedSchedule.length > 0) {
          // Use the saved schedule
          generateInstallmentTableRowsFromSchedule(savedSchedule, localPayments);
        } else {
          // Fallback to generating default schedule if no saved schedule
          console.log("No saved schedule found, generating default schedule");
          generateDefaultInstallmentSchedule(localPayments);
        }

        // Load server payments and update status
        google.script.run
          .withSuccessHandler((serverPayments) => {
            console.log("Loaded server payments:", serverPayments);
            serverPayments = serverPayments || []; // Handle null response

            // Merge local and server payments (server takes precedence)
            const allPayments = [...localPayments];
            serverPayments.forEach(serverPayment => {
              const existingIndex = allPayments.findIndex(p => p.installmentNumber === serverPayment.installmentNumber);
              if (existingIndex >= 0) {
                allPayments[existingIndex] = serverPayment; // Replace with server data
              } else {
                allPayments.push(serverPayment); // Add new server payment
              }
            });

            if (allPayments.length > 0) {
              updateInstallmentStatus(allPayments);
            }
          })
          .withFailureHandler((error) => {
            console.error("Error loading server payments:", error);
            // Keep local payments as they are
          })
          .getInstallmentPaymentsForStudent(receiptNo);
      })
      .withFailureHandler((error) => {
        console.error("Error loading saved installment schedule:", error);
        // Fallback to generating default schedule
        generateDefaultInstallmentSchedule(localPayments);
      })
      .loadInstallmentSchedule(receiptNo);
  }

  // Function to generate table rows from saved schedule
  function generateInstallmentTableRowsFromSchedule(schedule, paidInstallments) {
    const tableBody = document.getElementById("installmentTable");

    schedule.forEach(installment => {
      const row = document.createElement("tr");
      row.className = "hover:bg-gray-50";

      const statusId = `status-${installment.installmentNumber}`;
      const receiptBtnId = `receiptBtn-${installment.installmentNumber}`;

      // Check if this installment is paid
      const isPaid = paidInstallments.some(p => p.installmentNumber === installment.installmentNumber);
      const statusClass = isPaid ? "bg-green-100 text-green-800" : "bg-yellow-100 text-yellow-800";
      const statusText = isPaid ? "Paid" : "Pending";
      const checkboxChecked = isPaid ? "checked disabled" : "";
      const receiptBtnHidden = isPaid ? "" : "hidden";

      row.innerHTML = `
        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${installment.installmentNumber}</td>
        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${new Date(installment.dueDate).toLocaleDateString('en-IN')}</td>
        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-green-600">‚Çπ${installment.amount.toLocaleString()}</td>
        <td class="px-4 py-3 whitespace-nowrap text-sm">
          <span id="${statusId}" class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">${statusText}</span>
        </td>
        <td class="px-4 py-3 whitespace-nowrap text-sm">
          <input type="checkbox" class="installment-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" data-installment="${installment.installmentNumber}" data-amount="${installment.amount}" onchange="handleInstallmentPayment(this, '${statusId}', '${receiptBtnId}')" ${checkboxChecked}>
        </td>
        <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
          <button id="${receiptBtnId}" onclick="generateInstallmentReceipt(${installment.installmentNumber}, ${installment.amount})" class="text-sm px-3 py-1 bg-green-600 text-white rounded ${receiptBtnHidden} hover:bg-green-700 transition-colors">
            Receipt
          </button>
        </td>
      `;

      tableBody.appendChild(row);
    });
  }

  // Fallback function to generate default installment schedule
  function generateDefaultInstallmentSchedule(paidInstallments) {
    const totalFeesElement = document.getElementById("totalFees");
    const totalFeesText = totalFeesElement.textContent || totalFeesElement.innerText;
    const totalAmount = parseFloat(totalFeesText.replace(/[^0-9.]/g, '')) || 0;

    if (totalAmount === 0) {
      console.log("No total fees found, cannot generate installment schedule");
      return;
    }

    // Default to 12 installments (monthly)
    const numberOfInstallments = 12;
    const installmentAmount = Math.ceil(totalAmount / numberOfInstallments);

    const today = new Date();

    // Generate the table with local payments applied
    generateInstallmentTableRows(numberOfInstallments, installmentAmount, today, paidInstallments);
  }

  // Function to update installment status based on existing payments
  function updateInstallmentStatus(existingPayments) {
    console.log("Updating installment status with payments:", existingPayments);

    const paidInstallments = {};
    existingPayments.forEach(payment => {
      paidInstallments[payment.installmentNumber] = payment;
    });

    // Get all installment checkboxes and update their status
    const checkboxes = document.querySelectorAll('.installment-checkbox');
    checkboxes.forEach(checkbox => {
      const installmentNumber = parseInt(checkbox.getAttribute('data-installment'));
      const statusSpan = document.getElementById(`status-${installmentNumber}`);
      const receiptBtn = document.getElementById(`receiptBtn-${installmentNumber}`);

      if (paidInstallments[installmentNumber]) {
        console.log(`Marking installment ${installmentNumber} as paid`);

        if (statusSpan) {
          statusSpan.className = "px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800";
          statusSpan.textContent = "Paid";
        }

        if (checkbox) {
          checkbox.checked = true;
          checkbox.disabled = true;
          checkbox.removeAttribute('onchange'); // Prevent further changes
        }

        if (receiptBtn) {
          receiptBtn.classList.remove("hidden");
        }
      }
    });
  }

  // Function to store payment locally for immediate persistence
  function storePaymentLocally(receiptNo, installmentNumber, paymentData) {
    const key = `payment_${receiptNo}_${installmentNumber}`;
    localStorage.setItem(key, JSON.stringify({
      ...paymentData,
      storedAt: new Date().toISOString()
    }));
    console.log(`Stored payment locally: ${key}`);
  }

  // Function to load local payments for immediate UI update
  function loadLocalPayments(receiptNo) {
    const payments = [];
    // Load payments for this receipt number (up to a reasonable limit)
    for (let i = 1; i <= 50; i++) { // Increased limit to handle more installments
      const key = `payment_${receiptNo}_${i}`;
      const stored = localStorage.getItem(key);
      if (stored) {
        try {
          const payment = JSON.parse(stored);
          payments.push(payment);
          console.log(`Loaded local payment for installment ${i}:`, payment);
        } catch (e) {
          console.error(`Error parsing local payment for ${key}:`, e);
          localStorage.removeItem(key); // Clean up invalid data
        }
      }
    }
    return payments;
  }

  // Helper function to generate table rows
  function generateInstallmentTableRows(numberOfInstallments, installmentAmount, today, paidInstallments) {
    const tableBody = document.getElementById("installmentTable");

    for (let i = 1; i <= numberOfInstallments; i++) {
      // Calculate due date (monthly intervals)
      const dueDate = new Date(today);
      dueDate.setMonth(today.getMonth() + i - 1);

      const row = document.createElement("tr");
      row.className = "hover:bg-gray-50";

      const statusId = `status-${i}`;
      const receiptBtnId = `receiptBtn-${i}`;

      const isPaid = paidInstallments[i] !== undefined;
      const statusClass = isPaid ? "bg-green-100 text-green-800" : "bg-yellow-100 text-yellow-800";
      const statusText = isPaid ? "Paid" : "Pending";
      const checkboxChecked = isPaid ? "checked disabled" : "";
      const receiptBtnHidden = isPaid ? "" : "hidden";

      row.innerHTML = `
        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${i}</td>
        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${dueDate.toLocaleDateString('en-IN')}</td>
        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-green-600">‚Çπ${installmentAmount.toLocaleString()}</td>
        <td class="px-4 py-3 whitespace-nowrap text-sm">
          <span id="${statusId}" class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">${statusText}</span>
        </td>
        <td class="px-4 py-3 whitespace-nowrap text-sm">
          <input type="checkbox" class="installment-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" data-installment="${i}" data-amount="${installmentAmount}" onchange="handleInstallmentPayment(this, '${statusId}', '${receiptBtnId}')" ${checkboxChecked}>
        </td>
        <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
          <button id="${receiptBtnId}" onclick="generateInstallmentReceipt(${i}, ${installmentAmount})" class="text-sm px-3 py-1 bg-green-600 text-white rounded ${receiptBtnHidden} hover:bg-green-700 transition-colors">
            Receipt
          </button>
        </td>
      `;

      tableBody.appendChild(row);
    }
  }

  // Function to handle installment payment checkbox
  function handleInstallmentPayment(checkbox, statusId, receiptBtnId) {
    if (!checkbox.checked) {
      // If unchecked, hide receipt button and reset status
      const statusSpan = document.getElementById(statusId);
      const receiptButton = document.getElementById(receiptBtnId);

      if (statusSpan) {
        statusSpan.textContent = "Pending";
        statusSpan.className = "px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800";
      }

      if (receiptButton) {
        receiptButton.classList.add("hidden");
      }
      return;
    }

    const installmentNumber = checkbox.getAttribute('data-installment');
    const amount = checkbox.getAttribute('data-amount');

    // Show confirmation dialog
    const confirmed = confirm(`Are you sure the payment is completed?\n\nInstallment: ${installmentNumber}\nAmount: ‚Çπ${parseInt(amount).toLocaleString()}`);

    if (confirmed) {
      // Automatically save to sheet
      saveInstallmentPayment(installmentNumber, amount, checkbox, statusId, receiptBtnId);
    } else {
      // Uncheck if not confirmed
      checkbox.checked = false;
    }
  }

  // Function to save installment payment
  function saveInstallmentPayment(installmentNumber, amount, checkbox, statusId, receiptBtnId) {
    const formData = {
      receiptNo: document.getElementById("ID").value,
      studentName: document.getElementById("std_Coursepayname").value,
      enrollmentId: document.getElementById("enrollmentId").value,
      courseName: document.getElementById("coursePaySelect").value,
      installmentNumber: installmentNumber,
      installmentAmount: amount,
      paymentMethod: document.getElementById("pay-select").value,
      paymentDate: new Date().toISOString().split('T')[0],
      loggedInUser: document.getElementById("loggedInUserId")?.value || "Admin"
    };

    // Disable checkbox while processing
    checkbox.disabled = true;

    google.script.run
      .withSuccessHandler((result) => {
        if (result.success) {
          // Store payment locally for persistence
          storePaymentLocally(formData.receiptNo, formData.installmentNumber, {
            receiptNo: formData.receiptNo,
            studentName: formData.studentName,
            enrollmentId: formData.enrollmentId,
            courseName: formData.courseName,
            installmentNumber: parseInt(formData.installmentNumber),
            installmentAmount: parseFloat(formData.installmentAmount),
            paymentMethod: formData.paymentMethod,
            paymentDate: formData.paymentDate,
            loggedInUser: formData.loggedInUser
          });

          // Generate and save receipt data
          generateAndSaveInstallmentReceipt(installmentNumber, amount, formData);

          // Update status to Paid
          const statusSpan = document.getElementById(statusId);
          if (statusSpan) {
            statusSpan.className = "px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800";
            statusSpan.textContent = "Paid";
          }

          // Ensure checkbox stays checked and prevent further changes
          checkbox.checked = true;
          checkbox.removeAttribute('onchange');
          checkbox.disabled = true;

          const receiptButton = document.getElementById(receiptBtnId);
          if (receiptButton) {
            receiptButton.classList.remove("hidden");
          }

          alert(`Installment ${installmentNumber} payment saved successfully! Receipt has been generated and saved.`);
        } else {
          alert("Error: " + (result.message || "Failed to save payment"));
          checkbox.checked = false;
          checkbox.disabled = false;
        }
      })
      .withFailureHandler((error) => {
        alert("Error saving payment: " + error);
        checkbox.checked = false;
        checkbox.disabled = false;
      })
      .saveInstallmentPayment(formData);
  }

  // Function to generate and save installment receipt data
  function generateAndSaveInstallmentReceipt(installmentNumber, amount, paymentData) {
    try {
      // Generate receipt number
      const receiptNo = "IR" + Math.floor(1000 + Math.random() * 9000);

      // Get form data
      const date = new Date().toLocaleDateString('en-GB');
      const studentName = paymentData.studentName;
      const courseName = paymentData.courseName;
      const paymentMode = paymentData.paymentMethod;

      // Format currency
      const formatCurrency = (amount) => {
        return '‚Çπ' + amount.toFixed(2);
      };

      // Prepare receipt data
      const receiptData = {
        receiptNo: receiptNo,
        date: date,
        studentName: studentName,
        courseName: courseName,
        installmentNumber: installmentNumber,
        amountPaid: formatCurrency(amount),
        paymentMode: paymentMode,
        receiptType: 'installment'
      };

      // Generate the receipt HTML
      const receiptHTML = generateInstallmentReceiptHTML(receiptData);

      // Save receipt data to localStorage for persistence
      const receiptKey = `installment_receipt_${paymentData.receiptNo}_${installmentNumber}`;
      localStorage.setItem(receiptKey, JSON.stringify({
        ...receiptData,
        html: receiptHTML,
        generatedAt: new Date().toISOString()
      }));

      // Add receipt to the receipt container
      addReceiptToContainer(receiptData, receiptHTML);

      console.log("Installment receipt generated and saved:", receiptNo);

    } catch (error) {
      console.error("Error generating installment receipt:", error);
    }
  }

  // Function to generate installment receipt HTML
  function generateInstallmentReceiptHTML(receiptData) {
    

    return `
      <!DOCTYPE html>
      <html lang="en">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Installment Receipt</title>
        <style>
          @page { size: A4; margin: 0.5in; }
          body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: white; }
          .page-container { width: 210mm; height: 297mm; display: flex; flex-direction: column;
                          justify-content: space-between; padding: 10mm; box-sizing: border-box; }
          .receipt { width: 100%; height: 45%; border: 3px solid #000; border-radius: 15px;
                   padding: 15px; box-sizing: border-box; background: white; margin-bottom: 10mm;
                   page-break-inside: avoid; }
          .header { display: flex; align-items: center; margin-bottom: 15px;
                   border-bottom: 2px solid #000; padding-bottom: 10px; }
           .logo img { width: 65px; height: auto;}
          .institute-name { font-size: 28px; font-weight: bold; color: #000;
                          flex-grow: 1; letter-spacing: 1px; }
          .receipt-label { background: #333; color: white; padding: 5px 15px;
                          border-radius: 20px; font-size: 14px; font-weight: bold; }
          .receipt-content { display: flex; flex-direction: column; height: calc(100% - 100px); }
          .receipt-info { display: flex; justify-content: space-between; margin-bottom: 20px; }
          .receipt-no, .date { font-size: 16px; font-weight: bold; }
          .form-fields { flex-grow: 1; display: flex; flex-direction: column; gap: 12px; }
          .field-row { display: flex; align-items: center; font-size: 14px; font-weight: bold; }
          .field-label { min-width: 140px; color: #000; }
          .field-value { flex-grow: 1; border-bottom: 1px solid #000; padding: 2px 5px;
                       min-height: 20px; color: #0066cc; white-space: nowrap;
                       overflow: hidden; text-overflow: ellipsis; max-width: calc(100% - 140px); }
          .footer { margin-top: 15px; display: flex; justify-content: space-between; align-items: flex-end; }
          .note { font-size: 12px; font-weight: bold; max-width: 60%; }
          .signature-area { text-align: center; min-width: 150px; }
          .signature-line { border-bottom: 1px solid #000; height: 40px; margin-bottom: 5px; }
          .signature-label { font-size: 12px; font-weight: bold; }
          @media print {
            .page-container { height: 297mm; padding: 0.5in; }
            .receipt { margin-bottom: 5mm; }
          }
        </style>
      </head>
      <body>
        <div class="page-container">
          <!-- First Receipt -->
          <div class="receipt">
            <div class="header">
               <div class="logo">
                        <img src="${logoBase64}">
                    </div> 
              <div class="institute-name">SHELAR TRAINING INSTITUTE</div>
              <div class="receipt-label">INSTALLMENT RECEIPT</div>
            </div>
            <div class="receipt-content">
              <div class="receipt-info">
                <div class="receipt-no">Receipt No: ${receiptData.receiptNo}</div>
                <div class="date">Date: ${receiptData.date}</div>
              </div>
              <div class="form-fields">
                <div class="field-row">
                  <div class="field-label">Student Name:</div>
                  <div class="field-value">${receiptData.studentName}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">Course Name:</div>
                  <div class="field-value">${receiptData.courseName}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">Installment No:</div>
                  <div class="field-value">${receiptData.installmentNumber}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">Amount Paid:</div>
                  <div class="field-value">${receiptData.amountPaid}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">Payment Mode:</div>
                  <div class="field-value">${receiptData.paymentMode}</div>
                </div>
              </div>
              <div class="footer">
                <div class="note">‚Ä¢ Installment payment received successfully</div>
                <div class="signature-area">
                  <div class="signature-line"></div>
                  <div class="signature-label">Authorized Signature</div>
                </div>
              </div>
            </div>
          </div>
          <!-- Second Receipt (Duplicate) -->
          <div class="receipt">
            <div class="header">
               <div class="logo">
                        <img src="${logoBase64}">
                    </div> 
              <div class="institute-name">SHELAR TRAINING INSTITUTE</div>
              <div class="receipt-label">INSTALLMENT RECEIPT</div>
            </div>
            <div class="receipt-content">
              <div class="receipt-info">
                <div class="receipt-no">Receipt No: ${receiptData.receiptNo}</div>
                <div class="date">Date: ${receiptData.date}</div>
              </div>
              <div class="form-fields">
                <div class="field-row">
                  <div class="field-label">Student Name:</div>
                  <div class="field-value">${receiptData.studentName}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">Course Name:</div>
                  <div class="field-value">${receiptData.courseName}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">Installment No:</div>
                  <div class="field-value">${receiptData.installmentNumber}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">Amount Paid:</div>
                  <div class="field-value">${receiptData.amountPaid}</div>
                </div>
                <div class="field-row">
                  <div class="field-label">Payment Mode:</div>
                  <div class="field-value">${receiptData.paymentMode}</div>
                </div>
              </div>
              <div class="footer">
                <div class="note">‚Ä¢ Installment payment received successfully</div>
                <div class="signature-area">
                  <div class="signature-line"></div>
                  <div class="signature-label">Authorized Signature</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <script>
          setTimeout(() => {
            window.print();
          }, 500);
        </scr` + `ipt>
      </body>
      </html>
    `;
  }

  // Function to add receipt to the receipt container
  function addReceiptToContainer(receiptData, receiptHTML) {
    const logoBase64 = "https://i.postimg.cc/15z0wxhX/cropped-circle-image-(1).png";
    const receiptContainer = document.getElementById("receiptContainer");
    if (!receiptContainer) return;

    // Show the container if it's hidden
    receiptContainer.classList.remove("hidden");

    // Create receipt item
    const receiptItem = document.createElement("div");
    receiptItem.className = "bg-white border border-gray-200 rounded-lg p-4 mb-4 shadow-sm";
    receiptItem.innerHTML = `
      <div class="flex justify-between items-center mb-2">
        <h3 class="text-lg font-semibold text-gray-800">Installment Receipt - ${receiptData.receiptNo}</h3>
        <div class="flex space-x-2">
          <button onclick="printReceipt('${receiptData.receiptNo}')" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
            Print
          </button>
          <button onclick="viewReceipt('${receiptData.receiptNo}')" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
            View
          </button>
        </div>
      </div>
      <div class="text-sm text-gray-600 space-y-1">
        <p><strong>Student:</strong> ${receiptData.studentName}</p>
        <p><strong>Course:</strong> ${receiptData.courseName}</p>
        <p><strong>Installment:</strong> ${receiptData.installmentNumber}</p>
        <p><strong>Amount:</strong> ${receiptData.amountPaid}</p>
        <p><strong>Date:</strong> ${receiptData.date}</p>
      </div>
    `;

    // Add to container
    receiptContainer.appendChild(receiptItem);
  }

  // Function to print receipt
  function printReceipt(receiptNo) {
    const receiptKey = `installment_receipt_${document.getElementById("ID").value}_${receiptNo.split('IR')[1]}`;
    const storedReceipt = localStorage.getItem(receiptKey);

    if (storedReceipt) {
      const receiptData = JSON.parse(storedReceipt);
      const printWindow = window.open('', '_blank', 'width=800,height=1000');
      if (printWindow) {
        printWindow.document.write(receiptData.html);
        printWindow.document.close();
      }
    }
  }

  // Function to view receipt
  function viewReceipt(receiptNo) {
    const receiptKey = `installment_receipt_${document.getElementById("ID").value}_${receiptNo.split('IR')[1]}`;
    const storedReceipt = localStorage.getItem(receiptKey);

    if (storedReceipt) {
      const receiptData = JSON.parse(storedReceipt);
      const viewWindow = window.open('', '_blank', 'width=800,height=1000');
      if (viewWindow) {
        viewWindow.document.write(receiptData.html);
        viewWindow.document.close();
      }
    }
  }

  // Function to generate installment receipt (similar to exam receipt)
  function generateInstallmentReceipt(installmentNumber, amount) {
    console.log("generateInstallmentReceipt called with:", installmentNumber, amount);

    try {
      // Generate receipt number
      const receiptNo = "IR" + Math.floor(1000 + Math.random() * 9000);
      console.log("Generated receipt number:", receiptNo);

      // Get form data
      const date = new Date().toLocaleDateString('en-GB');
      const studentName = document.getElementById('std_Coursepayname')?.value || "N/A";
      const courseSelect = document.getElementById('coursePaySelect');
      const courseName = courseSelect?.options[courseSelect.selectedIndex]?.text || "N/A";
      const paymentMode = document.getElementById('pay-select')?.value || "Cash";

      console.log("Receipt data:", { studentName, courseName, paymentMode });

      // Format currency
      const formatCurrency = (amount) => {
        return '‚Çπ' + amount.toFixed(2);
      };

      // Prepare receipt data
      const receiptData = {
        receiptNo: receiptNo,
        date: date,
        studentName: studentName,
        courseName: courseName,
        installmentNumber: installmentNumber,
        amountPaid: formatCurrency(amount),
        paymentMode: paymentMode
      };

      console.log("Prepared receipt data:", receiptData);

      // Generate the receipt HTML (similar to exam receipt)
      const receiptHTML = `
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Installment Receipt</title>
          <style>
            @page { size: A4; margin: 0.5in; }
            body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: white; }
            .page-container { width: 210mm; height: 297mm; display: flex; flex-direction: column;
                            justify-content: space-between; padding: 10mm; box-sizing: border-box; }
            .receipt { width: 100%; height: 45%; border: 3px solid #000; border-radius: 15px;
                     padding: 15px; box-sizing: border-box; background: white; margin-bottom: 10mm;
                     page-break-inside: avoid; }
            .header { display: flex; align-items: center; margin-bottom: 15px;
                     border-bottom: 2px solid #000; padding-bottom: 10px; }
            .logo { width: 60px; height: 60px; margin-right: 15px; display: flex;
                   align-items: center; justify-content: center; overflow: hidden; }
            .logo img { width: 100%; height: auto; object-fit: contain; display: block; }
            .institute-name { font-size: 28px; font-weight: bold; color: #000;
                            flex-grow: 1; letter-spacing: 1px; }
            .receipt-label { background: #333; color: white; padding: 5px 15px;
                            border-radius: 20px; font-size: 14px; font-weight: bold; }
            .receipt-content { display: flex; flex-direction: column; height: calc(100% - 100px); }
            .receipt-info { display: flex; justify-content: space-between; margin-bottom: 20px; }
            .receipt-no, .date { font-size: 16px; font-weight: bold; }
            .form-fields { flex-grow: 1; display: flex; flex-direction: column; gap: 12px; }
            .field-row { display: flex; align-items: center; font-size: 14px; font-weight: bold; }
            .field-label { min-width: 140px; color: #000; }
            .field-value { flex-grow: 1; border-bottom: 1px solid #000; padding: 2px 5px;
                         min-height: 20px; color: #0066cc; white-space: nowrap;
                         overflow: hidden; text-overflow: ellipsis; max-width: calc(100% - 140px); }
            .footer { margin-top: 15px; display: flex; justify-content: space-between; align-items: flex-end; }
            .note { font-size: 12px; font-weight: bold; max-width: 60%; }
            .signature-area { text-align: center; min-width: 150px; }
            .signature-line { border-bottom: 1px solid #000; height: 40px; margin-bottom: 5px; }
            .signature-label { font-size: 12px; font-weight: bold; }
            @media print {
              .page-container { height: 297mm; padding: 0.5in; }
              .receipt { margin-bottom: 5mm; }
            }
          </style>
        </head>
        <body>
          <div class="page-container">
            <!-- First Receipt -->
            <div class="receipt">
              <div class="header">
                <div class="logo">
                  <img src="data:image/svg+xml;utf8,
<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'>
  <circle cx='80' cy='80' r='75' fill='%232c3e50'/>
  <text x='50%' y='55%' font-size='80' font-family='Arial' font-weight='bold' fill='white' text-anchor='middle' dominant-baseline='middle'>S</text>
</svg>"
alt="Logo"
style="width: 100%; max-width: 160px; height: auto; padding: 5px;" />

                </div>
                <div class="institute-name">SHELAR TRAINING INSTITUTE</div>
                <div class="receipt-label">INSTALLMENT RECEIPT</div>
              </div>
              <div class="receipt-content">
                <div class="receipt-info">
                  <div class="receipt-no">Receipt No: ${receiptData.receiptNo}</div>
                  <div class="date">Date: ${receiptData.date}</div>
                </div>
                <div class="form-fields">
                  <div class="field-row">
                    <div class="field-label">Student Name:</div>
                    <div class="field-value">${receiptData.studentName}</div>
                  </div>
                  <div class="field-row">
                    <div class="field-label">Course Name:</div>
                    <div class="field-value">${receiptData.courseName}</div>
                  </div>
                  <div class="field-row">
                    <div class="field-label">Installment No:</div>
                    <div class="field-value">${receiptData.installmentNumber}</div>
                  </div>
                  <div class="field-row">
                    <div class="field-label">Amount Paid:</div>
                    <div class="field-value">${receiptData.amountPaid}</div>
                  </div>
                  <div class="field-row">
                    <div class="field-label">Payment Mode:</div>
                    <div class="field-value">${receiptData.paymentMode}</div>
                  </div>
                </div>
                <div class="footer">
                  <div class="note">‚Ä¢ Installment payment received successfully</div>
                  <div class="signature-area">
                    <div class="signature-line"></div>
                    <div class="signature-label">Authorized Signature</div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Second Receipt (Duplicate) -->
            <div class="receipt">
              <div class="header">
                <div class="logo">
                  <img src="data:image/svg+xml;utf8,
<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'>
  <circle cx='80' cy='80' r='75' fill='%232c3e50'/>
  <text x='50%' y='55%' font-size='80' font-family='Arial' font-weight='bold' fill='white' text-anchor='middle' dominant-baseline='middle'>S</text>
</svg>"
alt="Logo"
style="width: 100%; max-width: 160px; height: auto; padding: 5px;" />

                </div>
                <div class="institute-name">SHELAR TRAINING INSTITUTE</div>
                <div class="receipt-label">INSTALLMENT RECEIPT</div>
              </div>
              <div class="receipt-content">
                <div class="receipt-info">
                  <div class="receipt-no">Receipt No: ${receiptData.receiptNo}</div>
                  <div class="date">Date: ${receiptData.date}</div>
                </div>
                <div class="form-fields">
                  <div class="field-row">
                    <div class="field-label">Student Name:</div>
                    <div class="field-value">${receiptData.studentName}</div>
                  </div>
                  <div class="field-row">
                    <div class="field-label">Course Name:</div>
                    <div class="field-value">${receiptData.courseName}</div>
                  </div>
                  <div class="field-row">
                    <div class="field-label">Installment No:</div>
                    <div class="field-value">${receiptData.installmentNumber}</div>
                  </div>
                  <div class="field-row">
                    <div class="field-label">Amount Paid:</div>
                    <div class="field-value">${receiptData.amountPaid}</div>
                  </div>
                  <div class="field-row">
                    <div class="field-label">Payment Mode:</div>
                    <div class="field-value">${receiptData.paymentMode}</div>
                  </div>
                </div>
                <div class="footer">
                  <div class="note">‚Ä¢ Installment payment received successfully</div>
                  <div class="signature-area">
                    <div class="signature-line"></div>
                    <div class="signature-label">Authorized Signature</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <script>
            setTimeout(() => {
              window.print();
            }, 500);
          </scr` + `ipt>
        </body>
        </html>
      `;

      console.log("Attempting to open receipt window...");

      // Open a new tab and write the receipt
      const printWindow = window.open('', '_blank', 'width=800,height=1000');

      if (printWindow) {
        console.log("Print window opened successfully");
        printWindow.document.write(receiptHTML);
        printWindow.document.close();
        console.log("Receipt HTML written to window");
      } else {
        console.log("Print window blocked by popup blocker, showing alert");
        alert("Popup blocked! Please allow popups for this site and try again.");
      }

    } catch (error) {
      console.error("Error generating installment receipt:", error);
      alert("Error generating receipt. Please check the console for details.");
    }
  }

  // Function to save course payment data persistently
  function saveCoursePaymentData(data) {
    const key = `course_payment_${data.receiptNo}`;
    localStorage.setItem(key, JSON.stringify({
      ...data,
      savedAt: new Date().toISOString()
    }));
    console.log("Course payment data saved:", key);
  }

  // Function to load course payment data
  function loadCoursePaymentData(receiptNo) {
    const key = `course_payment_${receiptNo}`;
    const stored = localStorage.getItem(key);
    if (stored) {
      try {
        return JSON.parse(stored);
      } catch (e) {
        console.error("Error parsing stored course payment data:", e);
        return null;
      }
    }
    return null;
  }

  // Function to populate form from admission data
  function populateCoursePaymentFromAdmission(admissionData) {
    if (admissionData) {
      // Map admission analytics data structure to course payment fields
      document.getElementById("ID").value = admissionData.receiptNumber || "";
      document.getElementById("enrollmentId").value = admissionData.enrollmentId || "";

      // Build full name from first, middle, last name
      const fullName = [admissionData.firstName, admissionData.middleName, admissionData.lastName]
        .filter(name => name && name.trim())
        .join(" ");
      document.getElementById("std_Coursepayname").value = fullName || "";

      // Set course selection - map courseName to course value
      const courseSelect = document.getElementById("coursePaySelect");
      if (admissionData.courseName) {
        // Convert course name to course value (e.g., "ANM Nursing Diploma" -> "anm_nursing")
        const courseValueMap = {
          "ANM Nursing Diploma": "anm_nursing",
          "GNM Nursing Diploma": "gnm_nursing",
          "DMLT Diploma": "dmlt",
          "OT Technician": "ot_technician",
          "General Nursing Assistant": "general_nursing"
        };
        const courseValue = courseValueMap[admissionData.courseName] || admissionData.courseName;
        courseSelect.value = courseValue;

        // Trigger course details update
        if (typeof updateCoursePayDetails === 'function') {
          updateCoursePayDetails();
        }
      }

      // Save this data persistently for future visits
      saveCoursePaymentData({
        receiptNo: admissionData.receiptNumber,
        enrollmentId: admissionData.enrollmentId,
        studentName: fullName,
        courseName: admissionData.courseName,
        firstName: admissionData.firstName,
        middleName: admissionData.middleName,
        lastName: admissionData.lastName
      });

      // Hide payment options and show installment schedule for users from admission analytics
      document.getElementById("paymentOptionsSection").classList.add("hidden");
      document.getElementById("installmentScheduleSection").classList.remove("hidden");

      // Wait for course details to load, then populate installment schedule
      waitForCourseDetailsAndPopulate();
    }
  }

  // Function to populate form from saved data when user returns
  function populateCoursePaymentFromSavedData(savedData) {
    if (savedData) {
      document.getElementById("ID").value = savedData.receiptNo || "";
      document.getElementById("enrollmentId").value = savedData.enrollmentId || "";
      document.getElementById("std_Coursepayname").value = savedData.studentName || "";

      // Set course selection
      const courseSelect = document.getElementById("coursePaySelect");
      if (savedData.courseName) {
        const courseValueMap = {
          "ANM Nursing Diploma": "anm_nursing",
          "GNM Nursing Diploma": "gnm_nursing",
          "DMLT Diploma": "dmlt",
          "OT Technician": "ot_technician",
          "General Nursing Assistant": "general_nursing"
        };
        const courseValue = courseValueMap[savedData.courseName] || savedData.courseName;
        courseSelect.value = courseValue;

        // Trigger course details update
        if (typeof updateCoursePayDetails === 'function') {
          updateCoursePayDetails();
        }
      }

      // Hide payment options and show installment schedule
      document.getElementById("paymentOptionsSection").classList.add("hidden");
      document.getElementById("installmentScheduleSection").classList.remove("hidden");

      // Load saved receipts immediately
      loadSavedReceipts();

      // Wait for course details to load, then populate installment schedule
      waitForCourseDetailsAndPopulate();
    }
  }

  // Helper function to wait for course details to load before populating installment schedule
  function waitForCourseDetailsAndPopulate() {
    const totalFeesElement = document.getElementById("totalFees");
    const totalFeesText = totalFeesElement.textContent || totalFeesElement.innerText;
    const totalAmount = parseFloat(totalFeesText.replace(/[^0-9.]/g, '')) || 0;

    if (totalAmount === 0) {
      // Course details not loaded yet, wait and try again
      setTimeout(waitForCourseDetailsAndPopulate, 200);
      return;
    }

    // Course details loaded, now populate installment schedule
    populateInstallmentSchedule();
  }

  // Function to load saved receipts for this student
  function loadSavedReceipts() {
    const receiptNo = document.getElementById("ID").value;
    if (!receiptNo) return;

    // Load all receipts for this receipt number
    for (let i = 1; i <= 50; i++) {
      const receiptKey = `installment_receipt_${receiptNo}_${i}`;
      const storedReceipt = localStorage.getItem(receiptKey);

      if (storedReceipt) {
        try {
          const receiptData = JSON.parse(storedReceipt);
          addReceiptToContainer(receiptData, receiptData.html);
        } catch (e) {
          console.error(`Error loading saved receipt for installment ${i}:`, e);
        }
      }
    }
  }

  // Function to handle receipt number input changes
  function handleReceiptNumberChange() {
    const receiptNoInput = document.getElementById("ID");
    const receiptNo = receiptNoInput.value.trim();

    if (receiptNo) {
      // Check if there's saved data for this receipt number
      const savedData = loadCoursePaymentData(receiptNo);

      if (savedData) {
        console.log("Found saved data for receipt:", receiptNo, savedData);
        // Populate form with saved data
        populateCoursePaymentFromSavedData(savedData);
      } else {
        console.log("No saved data found for receipt:", receiptNo);
        // Clear any existing data and show payment options
        document.getElementById("std_Coursepayname").value = "";
        document.getElementById("enrollmentId").value = "";
        document.getElementById("paymentOptionsSection").classList.remove("hidden");
        document.getElementById("installmentScheduleSection").classList.add("hidden");

        // Clear receipt container
        const receiptContainer = document.getElementById("receiptContainer");
        if (receiptContainer) {
          receiptContainer.innerHTML = "";
          receiptContainer.classList.add("hidden");
        }
      }
    }
  }

  // Initialize when page loads
  document.addEventListener('DOMContentLoaded', function() {
    // Add event listener for receipt number changes
    const receiptNoInput = document.getElementById("ID");
    if (receiptNoInput) {
      receiptNoInput.addEventListener('input', handleReceiptNumberChange);
      receiptNoInput.addEventListener('change', handleReceiptNumberChange);
    }

    // Check if there's admission data from sessionStorage (coming from admission analytics)
    const admissionData = JSON.parse(sessionStorage.getItem('admissionDataForPayment') || 'null');

    if (admissionData && (admissionData.firstName || admissionData.lastName) && admissionData.receiptNumber) {
      // User came from admission analytics - hide payment options, show installment schedule
      populateCoursePaymentFromAdmission(admissionData);

      // Load any saved receipts after populating the form
      setTimeout(() => {
        loadSavedReceipts();
      }, 500);

      // Keep the sessionStorage data so returning users see the installment schedule
      // sessionStorage.removeItem('admissionDataForPayment'); // Commented out to persist data
    } else {
      // Check if there's a receipt number already entered (user returning)
      const currentReceiptNo = receiptNoInput?.value?.trim();
      if (currentReceiptNo) {
        handleReceiptNumberChange(); // This will load saved data if available
      } else {
        // User accessed course payment directly - show payment options, hide installment schedule
        document.getElementById("paymentOptionsSection").classList.remove("hidden");
        document.getElementById("installmentScheduleSection").classList.add("hidden");
      }
    }
  });
</script>
